(function($){samo.frplacement_seats={};samo.cl_wizard=function(){var _ROOT_URL=samo.ROUTES.cl_wizard.url,$module_container=$('#cl_wizard'),_controls=$('input:text, #STATE, #TOWNFROM, #TOURINC',$module_container);samo.cache_controls($module_container);tour_parameter={};var empty_option=[{inc:0,title:"----",selected:true}];$module_container.find('input.date').datePicker();$module_container.find('select').each(function(){var disable_search=true,chosenEl;$(this).chosen({enable_split_word_search:false,search_contains:true,disable_search:disable_search});chosenEl=$(this).parent().find('.chosen-container');chosenEl.addClass($(this).attr('name')+'_chosen');chosenEl.css('text-align','left').css('width','100%');});$('#TOWNFROM, #STATE, #TOURINC',$module_container).on('change',function(){var name=this.name||$(this).attr('name');if(name=='TOWNFROM'){$('.STATE, .TOURINC',$module_container).find('option').remove();}
if(name=='STATE'){$('.TOURINC',$module_container).find('option').remove();}
$('#DATE_BEG').val('');$('#DATE_END').val('');$.getScript(getParams(name),false);});$('#NEXT').on('click',function(){var params={};switch(step){case 1:if($('#DATE_BEG').val()===''){$.notify(samo.i18n('CL_W_NO_DATE_BEG'));return false;}
if($('#DATE_END').val()===''){$.notify(samo.i18n('CL_W_NO_DATE_END'));return false;}
if(parseInt($('#TOURINC').val())===0){$.notify(samo.i18n('CL_W_NO_TOUR'));return false;}
if($('tr','#ALL_TOURIST').length===0){$.notify(samo.i18n('CL_W_NO_TOURIST'));return false;}
$('#TOURIST_ERROR').html('').addClass('d_none');if($('#DATE_BEG').val()!=''){params.DATE_BEG=$('#DATE_BEG').val();}
if($('#DATE_END').val()!=''){params.DATE_END=$('#DATE_END').val();}
$.post(_ROOT_URL+$.param({samo_action:'STEP2'}),params,null,'script');break;case 2:$.post(_ROOT_URL+$.param({samo_action:'STEP3'}),params,null,'script');break;case 3:params.NOTE=$('#NOTECLAIM').val();$.post(_ROOT_URL+$.param({samo_action:'BRON'}),params,null,'script');break;default:return false;}
return true;});$('#BACK').on('click',function(){var params={};switch(step){case 2:window.location.href=_ROOT_URL;break;case 3:window.location.href=_ROOT_URL+$.param({samo_action:'STEP2load'});break;case 4:window.location.href=_ROOT_URL+$.param({samo_action:'STEP3load'});break;default:return false;}
return true;});$('#NEWCLAIM').on('click',function(){var result={};result.samo_action='NEW_CLAIM';$.getScript(_ROOT_URL+$.param(result),null,false);return true;});$('#ADD_TOURIST_BUTTON').on('click',function(){_ed_tourist(0);});$('#ORDER_BTN_HOTEL, #ORDER_BTN_FREIGHT, #ORDER_BTN_GDS_FREIGHT, #ORDER_BTN_SERVICE, #ORDER_BTN_INSURE, #ORDER_BTN_VISA').on('click',function(){var type=$(this).data('otype');_ed_order(type,0);});$('#ORDER_BTN_NOHOTEL').on('click',function(){$.post(samo.ROUTES.cl_wizard.url+$.param({samo_action:'NOHOTEL'}),null,null,null);});$('#ORDER_BTN_LOAD').on('click',function(){if(confirm(samo.i18n('CL_W_ASK_LOAD_ORDER'))){var result={};result.samo_action='LOAD_ORDER';$.getScript(_ROOT_URL+$.param(result),null,false);}});$('#ALL_TOURIST',$module_container).on('click','.a_ed_tourist',function(){var inc=$(this).parents('tr:first').data('tourist');_ed_tourist(inc);});$('#ALL_TOURIST',$module_container).on('click','.delete_tourist_botton',function(){if(confirm(samo.i18n('CL_W_ASK_DELETE_TOURIST'))){var inc=$(this).parents('tr:first').data('tourist');var result={};result.samo_action='DELETE_TOURIST';$.post(_ROOT_URL+$.param(result),{TOURIST_INC:inc},false);}});$('#ALL_ORDER',$module_container).on('click','.delete_order_botton',function(){var $tr=$(this).parents('tr:first');var back=$tr.data('back');if((!back&&confirm(samo.i18n('CL_W_ASK_DELETE_ORDER')))||(back&&confirm(samo.i18n('CL_W_ASK_DELETE_ORDERS')))){var inc=$tr.data('order');var result={};result.samo_action='DELETE_ORDER';$.post(_ROOT_URL+$.param(result),{ORDER_INC:inc},false);}});$('#ALL_ORDER',$module_container).on('click','.link',function(){var order_type=$(this).parent().parent().data('order-type');var order_inc=$(this).parent().parent().data('order');_ed_order(order_type,order_inc);});$('#DATE_BEG').on('change.datepicker',function(e,d){if($(this).val()!=$(this).data('old')){if(samo.alreadyOrder&&!confirm(samo.i18n('CL_W_ASK_CHANGE_DATA'))){$(this).val($(this).data('old'));return;}
if(ischange(this)){if(d&&d.formated!=''){$(this).data('old',d.formated);var result={};result.samo_action='DATEBEG_CHANGE';result.DATE_BEG=samo.dateAsString(d.date,'yyyymmdd');result.TOURINC=$('#TOURINC').val();$.getScript(_ROOT_URL+$.param(result),null,false);}}}});$('#DATE_END').on('change.datepicker',function(e,d){if($(this).val()!=$(this).data('old')){if(samo.alreadyOrder&&!confirm(samo.i18n('CL_W_ASK_CHANGE_DATA'))){$(this).val($(this).data('old'));return;}}
if(ischange(this)){if(d&&d.formated!=''){$(this).data('old',d.formated);var result={};result.samo_action='DATEEND_CHANGE';$.getScript(_ROOT_URL+$.param(result),null,false);}}});var frplacement_disabled=false;var init_frplacement=function(event){var $span=$(event.target),$tr=$span.parents('tr:first'),data=$tr.data();if(!frplacement_disabled){var params={ORDER_INC:data.order};frplacement_disabled=true;params.maxWidth=$module_container.width();params.maxHeight=$(window).height();var url=_ROOT_URL+$.param({samo_action:'CHOOSE_FRPLACEMENT'});$.post(url,params,function(){frplacement_disabled=false;},'script');}};$('#ALL_ORDER').on('click','.frplacement',init_frplacement);samo.frplacement_save=function(button,$pTable){button.disabled=true;var data=null,_data=null,$peoples=$pTable.find('tbody tr');var seats={},seats_count=0,changes=0;data=$pTable.data();$peoples.each(function(){_data=$(this).data();if(_data.inc){seats[_data.people]={'inc':_data.inc,'name':_data.name};seats_count++;}else{seats[_data.people]={'inc':0,'name':''};}
if(!data.seats||!data.seats[_data.people]||data.seats[_data.people]['inc']!=seats[_data.people]['inc']){changes++;}});if(changes>0){var url=_ROOT_URL+$.param({ORDER_INC:data.order,samo_action:'SAVE_FRPLACEMENT'});var params={seats:seats};$.post(url,params,null,'script');}else{$.modal.close();}};function _ed_order(type,inc){var tmp='';if(inc>0){tmp='&ORDER_INC='+inc;}
if(type==='S'&&inc===0){$.getScript(getParams('SERVTYPEFORM')+'&ORDER_TYPE='+type+tmp,edit_order,false);}else if(type==='GDSF'&&inc===0){$.getScript(getParams('ORDERFORM')+'&ORDER_TYPE='+type+tmp,gdsForm,false);}else{$.getScript(getParams('ORDERFORM')+'&ORDER_TYPE='+type+tmp,edit_order,false);}
return true;}
function edit_order(){$('#SERVTYPE').on('click','.servtype',function(){let servtypeinc=$(this).data('servtype');let servcategoryinc=$(this).data('servcategory');samo.jQuery.modal.close();$.getScript(getParams('ORDERFORM')+'&ORDER_TYPE=S&servtype_inc='+servtypeinc+'&servcategory_inc='+servcategoryinc,edit_order,false);});$edit_order_container=$('#edit_order');$edit_order_container.find('input.date').datePicker();$('#ORDER_COUNT').on('change',function(){var order_type=$('#edit_order').data('order-type');if(order_type==='S'&&$('#ORDER_ADD_INFANT').is(':checked')){$('#ORDER_ADD_INFANT').prop('checked',false);}
var _old=parseInt($(this).data('old'));var _new=parseInt($(this).val());$(this).data('old',_new);Redraw_Opeople(_old,_new);});$('#ORDER_ADD_INFANT').click(function(){var order_type=$('#edit_order').data('order-type');if($(this).is(':checked')){if(order_type==='H'||order_type==='F'){$('.order_opeople',$edit_order_container).each(function(){var tmp=parseInt($(this).attr('size'));$(this).attr('size',tmp+1);$(this).append('<option value="-1">'+samo.i18n('CL_W_EMPTY')+'</option>');});if(order_type==='F'){var val=1;$('#ORDER_COUNT').find('option[value='+val+']').prop('selected',true);$('#ORDER_COUNT').find('option[value!='+val+']').prop('disabled',true);$('#ORDER_COUNT').triggerHandler('change');}}else if(order_type==='S'){tmp=parseInt($('#ORDER_COUNT').val())+1;$('#ORDER_COUNT').find('option[value='+tmp+']').prop('selected',true).parent().data('old',tmp);OneOrder();}}else{if(order_type==='H'||order_type==='F'){$('.order_opeople',$edit_order_container).each(function(){var tmp,tmp_k;var n=$(this).attr('id').substring(5);$('#ORDER'+n+' option:selected').prop('selected',false);tmp=$('#ORDER'+n+' option:textbegin("INF")');if($(tmp).length!==0){tmp=$('option:textbegin("INF"):last',$(this));}else{tmp=$('option:last',$(this));}
$(tmp).prop('selected',true);$('#FROM_RIGHT_TO_LEFT_BTN'+n).click();$(tmp).remove();tmp_k=parseInt($(this).attr('size'));$(this).attr('size',tmp_k-1);});if(order_type==='F'){$('#ORDER_COUNT').find('option').prop('disabled',false);}}else if(order_type==='S'){tmp=parseInt($('#ORDER_COUNT').val())-1;$('#ORDER_COUNT').find('option[value='+tmp+']').prop('selected',true).parent().data('old',tmp);RemoveOrder(tmp);}}});if(order_type==='F'&&$('#ORDER_ADD_INFANT').is(':checked')){$('#ORDER_COUNT').find('option[value!=1]').prop('disabled',true);}
var order_type=$('#edit_order').data('order-type');switch(order_type){case'H':case'I':case'V':$('#ORDER_DATEBEG').on('change.datepicker',function(e,d){if(ischange(this)){$('#ORDER_DATEEND').data('old','');if(d.date){if(d.date>$('#ORDER_DATEEND').getDate()){$('#ORDER_DATEEND').val(d.formated);}
empty_rhm();}
var dbeg=$('#ORDER_DATEBEG').clearVal();if(dbeg!=''){$('#ORDER_DATEEND').datePicker({start:dbeg}).trigger('change.datepicker',{force:true});}}});break;default:break;}
switch(order_type){case'H':function Order_Hotel_DateEndChange(el,opts){if(ischange(el)||(opts&&opts.force)){empty_rhm();$.getScript(getParams('ORDER_HOTEL_TOWN')+'&'+getOrderParams(),EndLoadOpeople,false);}}
$('#ORDER_DATEEND').on('change.datepicker',function(e,d){Order_Hotel_DateEndChange(this,d);}).on('blur',function(){Order_Hotel_DateEndChange(this);});$('#ORDER_HOTELINC').on('change',function(){empty_rhm();$.getScript(getParams('ORDER_HOTELINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_ROOMINC').on('change',function(){$('#ORDER_HTPLACEINC').empty().addOptions(empty_option);$('#ORDER_MEALINC').empty().addOptions(empty_option);ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_ROOMINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_HTPLACEINC').on('change',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_HTPLACEINC')+'&'+getOrderParams(),EndLoadOpeople,false);});break;case'F':function Order_Freight_DateEndChange(el,opts){if(ischange(el)||(opts&&opts.force)){$('#ORDER_TOWNFROM').empty().addOptions(empty_option);$('#ORDER_TOWNTO').empty().addOptions(empty_option);empty_rhm();$('#ORDER_BACK_FREIGHT_ENABLE').prop('checked',false).triggerHandler('click');$.getScript(getParams('ORDER_FREIGHT_DATE')+'&'+getOrderParams(),EndLoadOpeople,false);}}
$('#ORDER_DATEBEG').on('change.datepicker',function(e,d){Order_Freight_DateEndChange(this,d);}).on('blur',function(){Order_Freight_DateEndChange(this);});$('#ORDER_TOWNFROM').on('change',function(){$('#ORDER_TOWNTO').empty().addOptions(empty_option);empty_rhm();$('#ORDER_BACK_FREIGHT_ENABLE').prop('checked',false).triggerHandler('click');$.getScript(getParams('ORDER_TOWNFROM')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_TOWNTO').on('change',function(){empty_rhm();$('#ORDER_BACK_FREIGHT_ENABLE').prop('checked',false).triggerHandler('click');$.getScript(getParams('ORDER_TOWNTO')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_CLASSINC').on('change',function(){$('#ORDER_FRPLACEINC').empty().addOptions(empty_option);$('#ORDER_FREIGHTINC').empty().addOptions(empty_option);$('#ORDER_BACK_FREIGHT_ENABLE').prop('checked',false).triggerHandler('click');ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_CLASSINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_FRPLACEINC').on('change',function(){$('#ORDER_FREIGHTINC').empty().addOptions(empty_option);$('#ORDER_BACK_FREIGHT_ENABLE').prop('checked',false).triggerHandler('click');ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_FRPLACEINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_FREIGHTINC').on('change',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_FREIGHTINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_BACK_FREIGHT_ENABLE').click(function(){var dis=true;if($(this).is(':checked')){if(typeof $('#ORDER_DATEBEG').val()=="undefined"||$('#ORDER_TOWNFROM').val()==0||$('#ORDER_TOWNTO').val()==0||$('#ORDER_CLASSINC').val()==0||$('#ORDER_FRPLACEINC').val()==0){$.notify(samo.i18n('CL_W_NOT_ENOUGH_DATA_FOR_SELECTION'));return false;}
dis=false;Order_Back_Freight_DateEndChange($('#ORDER_DATEBEG_BACK_FREIGHT'),{force:1});}else{$('#ORDER_BACK_FREIGHTINC').val(0);}
$('#ORDER_DATEBEG_BACK_FREIGHT').prop('disabled',dis);$('#ORDER_BACK_FREIGHTINC').prop('disabled',dis);});function Order_Back_Freight_DateEndChange(el,opts){if(ischange(el)||(opts&&opts.force)){result={};result.ORDER_DATEBEG_BACK_FREIGHT=samo.dateAsString(samo.dateFromString($('#ORDER_DATEBEG_BACK_FREIGHT').val(),'dd.mm.yyyy'),'yyyymmdd');result.ORDER_TOWNFROM=$('#ORDER_TOWNFROM').val();result.ORDER_TOWNTO=$('#ORDER_TOWNTO').val();result.ORDER_CLASSINC=$('#ORDER_CLASSINC').val();result.ORDER_FRPLACEINC=$('#ORDER_FRPLACEINC').val();$.post(_ROOT_URL+$.param({samo_action:'ORDER_BACK_FREIGHT'}),result,null,'script');}}
$('#ORDER_DATEBEG_BACK_FREIGHT').on('change.datepicker',function(e,d){Order_Back_Freight_DateEndChange(this,d);});break;case'S':$('#ORDER_SERVICE_TRANTYPE').on('change',function(){$('#ORDER_SERVICEINC').empty().addOptions([{inc:'0',title:"----",selected:true}]);$('#ORDER_TOWNS_SERVICE').empty().addOptions([{inc:'0|0',title:"----",selected:true}]);$('#ORDER_HOTEL_SERVICE').empty().addOptions(empty_option);$('#ORDER_COUNT').find('option[value=1]').prop('selected',true).parent().data('old',1);ClearFIELDSET_OPEOPLE();$('#ORDER_DATEBEG').val(samo.ORDER_STARTDATE);$('#ORDER_DATEEND').val(samo.ORDER_ENDDATE);$.getScript(getParams('ORDER_SERVICE_TRANTYPE')+'&'+getOrderParams(),function(){if($('#ORDER_SERVICEINC').val()>0){let period_type=$('#ORDER_SERVICEINC').find('option:selected').data('period-type');let disabled=true;if(period_type==samo.PERIOD_ANY){disabled=false;}
$('#ORDER_DATEEND').prop('disabled',disabled);}
EndLoadOpeople();},false);});$('#ORDER_SERVICEINC').on('change',function(){$('#ORDER_TOWNS_SERVICE').empty().addOptions([{inc:'0|0',title:"----",selected:true}]);$('#ORDER_HOTEL_SERVICE').empty().addOptions(empty_option);$('#ORDER_COUNT').find('option[value=1]').prop('selected',true).parent().data('old',1);ClearFIELDSET_OPEOPLE();var transfertypeinc=$(this).find('option:selected').data('transfertypeinc');var period_type=$(this).find('option:selected').data('period-type');var disabled=true;if(period_type==samo.PERIOD_ANY){disabled=false;}
$('#ORDER_DATEEND').prop('disabled',disabled);if(period_type==samo.PERIOD_ANY){$('#ORDER_DATEBEG').val(samo.ORDER_STARTDATE);$('#ORDER_DATEEND').val(samo.ORDER_ENDDATE);}else if(period_type==samo.PERIOD_ONE_DAY){if(transfertypeinc==samo.TRANSFERTYPE_A_H){$('#ORDER_DATEBEG').val(samo.ORDER_STARTDATE);$('#ORDER_DATEEND').val(samo.ORDER_STARTDATE);}else if(transfertypeinc==samo.TRANSFERTYPE_H_A){$('#ORDER_DATEBEG').val(samo.ORDER_ENDDATE);$('#ORDER_DATEEND').val(samo.ORDER_ENDDATE);}else{$('#ORDER_DATEBEG').val(samo.ORDER_STARTDATE);$('#ORDER_DATEEND').val(samo.ORDER_STARTDATE);}}else{$('#ORDER_DATEBEG').val(samo.ORDER_STARTDATE);$('#ORDER_DATEEND').val(samo.ORDER_ENDDATE);}
$.getScript(getParams('ORDER_SERVICEINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_DATEBEG').on('change.datepicker',function(e,d){if(ischange(this)){var period_type=$('#ORDER_SERVICEINC option:selected').data('period-type');ClearFIELDSET_OPEOPLE();if(period_type==samo.PERIOD_ONE_DAY){$('#ORDER_DATEEND').val($('#ORDER_DATEBEG').val());}
if(d&&d.formated!=''){$(this).data('old',d.formated);$.getScript(getParams('ORDER_SERVICEINC')+'&'+getOrderParams(),EndLoadOpeople,false);}}});$('#ORDER_DATEEND').on('change.datepicker',function(e,d){if(ischange(this)){ClearFIELDSET_OPEOPLE();if(d&&d.formated!=''){$(this).data('old',d.formated);$.getScript(getParams('ORDER_SERVICEINC')+'&'+getOrderParams(),EndLoadOpeople,false);}}});$('#ORDER_SERVICEINC').on('load_opeople',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_SERVICEINC_LOAD_OPEOPLE')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_TOWNS_SERVICE').on('change',function(){$('#ORDER_HOTEL_SERVICE').empty().addOptions(empty_option);$.getScript(getParams('ORDER_TOWNS_SERVICE')+'&'+getOrderParams(),null,false);});break;case'I':$('#ORDER_INSUREINC').on('change',function(){var is_medical=$(this).find('option:selected').data('is_medical');var disabled=true;if(is_medical){disabled=false;}
$('#ORDER_DATEBEG').prop('disabled',disabled);$('#ORDER_DATEEND').prop('disabled',disabled);ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_INSUREINC')+'&'+getOrderParams(),EndLoadOpeople,false);});break;case'V':$('#ORDER_DATEEND').on('change.datepicker',function(){if(ischange(this)){empty_rhm();$.getScript(getParams('ORDER_VISADATES')+'&'+getOrderParams(),EndLoadOpeople,false);}});$('#ORDER_VISAINC').on('change',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_VISAINC')+'&'+getOrderParams(),EndLoadOpeople,false);});break;default:return false;}
$('.from_left_to_right').on('click',from_left_to_right);$('.from_right_to_left').on('click',from_right_to_left);$('.panel > .width100p').find('select').chosen();$('.load',$edit_order_container).click(function(){var i,result={},text={},f_save=true,op=[],fq=true,tmp,tmp2;var order_type=$('#edit_order').data('order-type');if($('#FIELDSET_OPEOPLE').css('display')=='none'){$.notify(samo.i18n('CL_W_PART_NO_ORDERS'));return false;}
if(order_type==='H'&&$('#ORDER_MEALINC').val()==='0'){$.notify(samo.i18n('CL_W_NO_CHHOSE_MEAL'));return false;}
tmp=false;for(i=0;i<parseInt($('#ORDER_COUNT').val());i++){tmp2=$('#ORDER'+i+' option').filter(function(){return $(this).val()<0;}).length;if(tmp2==0){tmp=true;}}
if(!tmp){$.notify(samo.i18n('CL_W_PART_EMPTY_ORDER3'));return false;}
for(i=0;i<parseInt($('#ORDER_COUNT').val());i++){tmp2=$('#ORDER'+i+' option').filter(function(){return $(this).val()<0;}).length;if(tmp2==$('#ORDER'+i+' option').length){$.notify(samo.i18n('CL_W_PART_EMPTY_ORDER2'));return false;}
if(tmp2>0){if(fq){if(!confirm(samo.i18n('CL_W_PART_EMPTY_ORDER'))){f_save=false;return false;}else{fq=false;}}}
if(!f_save){return true;}
tmp=[];$('#ORDER'+i+':first option').each(function(){tmp.push(this.value);});op.push(tmp.join(','));}
var opeople=op.join('|');result.ORDER_OPEOPLE=opeople;var order_controls=$('select:not(:disabled), input:not(:disabled)',$edit_order_container);$(order_controls,$edit_order_container).each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this);var tmp=$('option:selected',this).text();if(name&&value&&value!==0){result[name]=value;text[name]=tmp;}});result.ORDER_ADD_INFANT=($('#ORDER_ADD_INFANT').is(':checked'))?1:0;result.ORDER_TYPE=order_type;var $selected;switch(order_type){case'H':result.townname=$('#ORDER_HOTELINC option:selected').data('townname');result.hotelname=text.ORDER_HOTELINC;result.roomname=text.ORDER_ROOMINC;result.htplacename=text.ORDER_HTPLACEINC;result.mealname=text.ORDER_MEALINC;$selected=$('#ORDER_TOWN option:selected');result.state_inc=$selected.data('state');result.routeindex=$('#ORDER_HOTELINC option:selected').data('routeindex');result.resreg=$('#ORDER_ROOMINC option:selected').data('resreg');var stopsale=0;if($('#ORDER_HOTELINC option:selected').hasClass('stopsale')){stopsale=1;}
result.stopsale=stopsale;break;case'F':if(!result.ORDER_FREIGHTINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_FREIGHT'));return false;}
result.class_name=text.ORDER_CLASSINC;result.frplace_name=text.ORDER_FRPLACEINC;$selected=$('#ORDER_FREIGHTINC option:selected');result.source_name=text.ORDER_TOWNFROM;result.days=$selected.data('days')?parseInt($selected.data('days')):0;var datebeg=samo.dateFromString(result.ORDER_DATEBEG,'yyyymmdd');var dateend=new Date();dateend.setTime(datebeg.getTime());dateend.setDate(datebeg.getDate()+result.days);result.ORDER_DATEEND=samo.dateAsString(dateend,'yyyymmdd');result.srcport=$selected.data('srcport');result.src_time=$selected.data('src_time');result.target_name=text.ORDER_TOWNTO;result.trg_port=$selected.data('trg_port');result.trg_time=$selected.data('trg_time');result.freight_name=$selected.data('freight_name');result.tpartner_name=$selected.data('tpartner_name');result.isback=$selected.data('isback');result.places=$selected.data('places');result.places_title=$selected.data('places_title');result.frplacementavailable=$selected.data('frplacementavailable');result.routeindex=$selected.data('routeindex');if(result.ORDER_BACK_FREIGHT_ENABLE){if(!result.ORDER_BACK_FREIGHTINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_BACK_FREIGHT'));return false;}
$selected=$('#ORDER_BACK_FREIGHTINC option:selected');result.back_source_name=text.ORDER_TOWNTO;result.back_days=$selected.data('days')?parseInt($selected.data('days')):0;datebeg=samo.dateFromString(result.ORDER_DATEBEG_BACK_FREIGHT,'yyyymmdd');dateend=new Date();dateend.setTime(datebeg.getTime());dateend.setDate(datebeg.getDate()+result.back_days);result.ORDER_DATEEND_BACK_FREIGHT=samo.dateAsString(dateend,'yyyymmdd');result.back_srcport=$selected.data('srcport');result.back_src_time=$selected.data('src_time');result.back_target_name=text.ORDER_TOWNFROM;result.back_trg_port=$selected.data('trg_port');result.back_trg_time=$selected.data('trg_time');result.back_freight_name=$selected.data('freight_name');result.back_tpartner_name=$selected.data('tpartner_name');result.isback=$selected.data('isback');result.back_places=$selected.data('places');result.back_places_title=$selected.data('places_title');result.back_frplacementavailable=$selected.data('frplacementavailable');result.back_routeindex=$selected.data('routeindex');}
break;case'S':if(!result.ORDER_SERVICEINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_SERVICE'));return false;}
if(result.ORDER_TOWNS_SERVICE=='0|0'){$.notify(samo.i18n('CL_W_NO_CHHOSE_SERVICE_TOWNS'));return false;}
if(!result.ORDER_HOTEL_SERVICE){$.notify(samo.i18n('CL_W_NO_CHHOSE_SERVICE_HOTEL'));return false;}
$selected=$('#ORDER_SERVICEINC option:selected');var transfertypeinc=$selected.data('transfertypeinc');var period_type=$selected.data('period-type');if(period_type==samo.PERIOD_ANY){if(typeof result.ORDER_DATEEND=="undefined"){$.notify(samo.i18n('CL_W_ORDER_EMPTY_DATEEND'));return false;}}else{result.ORDER_DATEEND=$('#ORDER_DATEEND').val();}
result.servtype_inc=$selected.data('servtype');result.servtype_name=$selected.data('servtype-name');result.service_name=$selected.data('service-name');result.trantype_inc=$selected.data('trantype-inc');result.trantype_name=$selected.data('trantype-name');result.servcategory_inc=$selected.data('servcategory');result.routeindex=$selected.data('routeindex');$selected=$('#ORDER_TOWNS_SERVICE option:selected');result.source_name=$selected.data('source-name');result.target_name=$selected.data('target-name');$selected=$('#ORDER_HOTEL_SERVICE option:selected');result.service_hotel_name=$selected.data('hotel-name');result.service_roominc=$selected.data('roominc');result.service_mealinc=$selected.data('mealinc');result.transfertypeinc=transfertypeinc;break;case'I':if(!result.ORDER_INSUREINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_INSURE'));return false;}
$selected=$('#ORDER_INSUREINC option:selected');result.partner_name=$selected.data('partner-name');result.insure_name=$selected.data('insure-name');result.state_name=$selected.data('state-name');result.state_inc=$selected.data('state');var is_medical=$selected.data('is_medical');result.is_medical=is_medical;if(is_medical&&typeof result.ORDER_DATEBEG=="undefined"){$.notify(samo.i18n('CL_W_ORDER_EMPTY_DATEBEG'));return false;}
if(is_medical&&typeof result.ORDER_DATEEND=="undefined"){$.notify(samo.i18n('CL_W_ORDER_EMPTY_DATEEND'));return false;}
break;case'V':if(!result.ORDER_VISAINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_VISA'));return false;}
$selected=$('#ORDER_VISAINC option:selected');result.visa_name=$selected.data('visa-name');result.days=$selected.data('days');result.state_name=$selected.data('state-name');break;default:return false;}
var $order=$('#edit_order');result.ORDER_INC=$order.data('order');result.pcount=$order.data('pcount');result.adult=$order.data('pcount-adult');result.child=$order.data('pcount-child');result.infant=$order.data('pcount-infant');$.post(_ROOT_URL+$.param({samo_action:'SAVE_ORDER'}),result,null,'script');samo.jQuery.modal.close();return true;});var el='';var trigger_name='change';switch(order_type){case'H':el='ORDER_HTPLACEINC';break;case'F':el='ORDER_FREIGHTINC';break;case'S':el='ORDER_SERVICEINC';trigger_name='load_opeople';break;case'I':el='ORDER_INSUREINC';break;case'V':el='ORDER_VISAINC';break;default:break;}
if($('#'+el+' option').length==2){if(order_type=='S'){var period_type=$('#'+el).find('option:selected').data('period-type');if(period_type==samo.PERIOD_ANY){$('#ORDER_DATEEND').prop('disabled',false);}}
if($('#FIELDSET_OPEOPLE').css('display')=='none'){$('.load',$edit_order_container).prop('disabled',true);$('#'+el).triggerHandler(trigger_name);}}
return true;}
function EndLoadOpeople(){AutoSetOpeople();$('.load',$edit_order_container).prop('disabled',false);}
function AutoSetOpeople(){var order_type=$('#edit_order').data('order-type');if(order_type=='H'){OneOrder(0);}
if($('#ORDER_ALL_TOURIST option').length>0){switch(order_type){case'H':Rasselenie(0);break;case'F':case'S':case'I':case'V':FSIV_AutoSetOpeople();break;default:return false;}}
return true;}
function FSIV_AutoSetOpeople(){var i;var pcount=($('#ORDER_ALL_TOURIST option').length)?$('#ORDER_ALL_TOURIST option').length:1;var order_type=$('#edit_order').data('order-type');if(order_type=='F'){var infant_count=($('#ORDER_ALL_TOURIST option:textbegin("INF")').length)?$('#ORDER_ALL_TOURIST option:textbegin("INF")').length:0;pcount=pcount-infant_count;}
$('#ORDER_COUNT').find('option[value='+pcount+']').prop('selected',true).parent().data('old',pcount);i=0;for(i=0;i<pcount;i++){OneOrder(i);Rasselenie(i);}}
function OneOrder(n){var tmp=[],i,$order=$('#edit_order');var order_type=$order.data('order-type');var people_count_in_one_order=$order.data('pcount');if((order_type==='H'||order_type==='F')&&$('#ORDER_ADD_INFANT').is(':checked')){people_count_in_one_order++;}
var tmp_i=$('#OPEOPLE .div_order').length;for(i=0;i<people_count_in_one_order;i++){tmp.push({inc:-i-1,title:samo.i18n('CL_W_EMPTY')});}
$('#OPEOPLE').append('<div class="div_order" id="DIV_ORDER'+tmp_i+'"><div class="opeople_btn"><input type="button" id="FROM_LEFT_TO_RIGHT_BTN'+tmp_i+'" class="from_left_to_right" value=">>" data-to="'+tmp_i+'"><br><input type="button" id="FROM_RIGHT_TO_LEFT_BTN'+tmp_i+'" class="from_right_to_left" value="<<" data-from="'+tmp_i+'"></div><div class="order"><select size="'+people_count_in_one_order+'" id="ORDER'+tmp_i+'" class="order_opeople" multiple=""></select></div></div><div class="eraser"/>');$('#ORDER'+tmp_i).addOptions(tmp);$('.from_left_to_right').on('click',from_left_to_right);$('.from_right_to_left').on('click',from_right_to_left);}
function movePeopleToOrder(to){if($('#ORDER_ALL_TOURIST option').length===0)return'';var order_type=$('#edit_order').data('order-type');var tmp,f_add_inf=0,mrmrs_cnt=0,chd_cnt=0;inf_cnt=0;if($('#ORDER_ALL_TOURIST option:selected').length===0){tmp=$('#ORDER_ALL_TOURIST option:first');}else{tmp=$('#ORDER_ALL_TOURIST option:selected').eq(0);}
var kogo_text=tmp.text();var kogo_val=parseInt(tmp.val());to='ORDER'+to;var $tmp_t=$('#'+to+' option').filter(function(){return $(this).val()<0;});if($tmp_t.length===0){return samo.i18n('CL_W_FULL_ORDER');}
if(order_type==='H'||order_type==='F'){var $order=$('#edit_order');var place_peoplecount_adult=$order.data('pcount-adult');var place_peoplecount_child=$order.data('pcount-child');var place_peoplecount_infant=$order.data('pcount-infant');if($('#ORDER_ADD_INFANT').is(':checked')==true){place_peoplecount_infant++;}
$('#'+to+' option').each(function(){var mrmrs=$(this).text().substring(0,3);if(mrmrs==='MR '||mrmrs==='MRS'){mrmrs_cnt++;}else if(mrmrs==='CHD'){if(chd_cnt<place_peoplecount_child){chd_cnt++;}else{mrmrs_cnt++;}}else if(mrmrs==='INF'){if(inf_cnt<place_peoplecount_infant){inf_cnt++;}else if(chd_cnt<place_peoplecount_child){chd_cnt++;}else{inf_cnt++;}}});var kogo=kogo_text.substring(0,3);if((kogo=='MR '||kogo=='MRS')&&(mrmrs_cnt>=place_peoplecount_adult)){return samo.i18n('CL_W_FULL_ADULT_ORDER');}else if(kogo=='CHD'&&(mrmrs_cnt>=place_peoplecount_adult)&&(chd_cnt>=place_peoplecount_child)){return samo.i18n('CL_W_FULL_CHILD_ORDER');}else if(kogo=='INF'&&(mrmrs_cnt>=place_peoplecount_adult)&&(chd_cnt>=place_peoplecount_child)&&(inf_cnt>=place_peoplecount_infant)){return samo.i18n('CL_W_FULL_INFANT_ORDER');}}
var opt=$tmp_t.get(0);opt.text=kogo_text;opt.value=kogo_val;tmp.remove();return'';}
function from_left_to_right(){var tmp;var nto=$(this).data('to');var result=movePeopleToOrder(nto);if(result!==''){$.notify(result);}
return true;}
function from_right_to_left(){var nfrom=$(this).data('from');var from='ORDER'+nfrom;if($('#'+from+' option').length===0)return true;var tmp_i=0,f=false,tmp;tmp_i=$('#'+from+' option:selected').length;if(tmp_i>0){tmp=$('#'+from+' option:selected').get(0);if($(tmp).val()<0){return true;}}else{tmp=$('#'+from+' option').filter(function(){return $(this).val()>0;});if(tmp.length===0)return true;tmp=$(tmp).get(0);}
var kogo_text=tmp.text;var kogo_val=tmp.value;tmp.text=samo.i18n('CL_W_EMPTY');tmp.value=-1;$('#ORDER_ALL_TOURIST').append('<option value="'+kogo_val+'">'+kogo_text+'</option>');return true;}
function Rasselenie(n){$('#ORDER_ALL_TOURIST option:textbegin("MR")').each(function(){$(this).prop('selected',true);var result=movePeopleToOrder(n);});$('#ORDER_ALL_TOURIST option:textbegin("CHD")').each(function(){$(this).prop('selected',true);var result=movePeopleToOrder(n);});$('#ORDER_ALL_TOURIST option:textbegin("INF")').each(function(){$(this).prop('selected',true);var result=movePeopleToOrder(n);});return true;}
function Redraw_Opeople(_old,_new){var i;if(_new>_old){for(i=_old+1;i<=_new;i++){OneOrder(i-1);Rasselenie(i-1);}}else{for(i=_old;i>_new;i--){RemoveOrder(i-1);}}}
function RemoveOrder(n){var tmp_k=$('#ORDER'+n+' option').length;for(var i=0;i<tmp_k;i++){$('#FROM_RIGHT_TO_LEFT_BTN'+n).click();}
$('#DIV_ORDER'+n).remove();}
function ClearFIELDSET_OPEOPLE(){$('#ORDER_COUNT').find('option[value=1]').prop('selected',true).parent().data('old',1);$('#FIELDSET_OPEOPLE').css('display','none');$('#ORDER_ALL_TOURIST').empty();$('#OPEOPLE').empty();}
function empty_rhm(){var order_type=$('#edit_order').data('order-type');if(order_type!='I'){$('#ORDER_COUNT').find('option[value=1]').prop('selected',true).parent().data('old',1);ClearFIELDSET_OPEOPLE();}
switch(order_type){case'H':$('#ORDER_ROOMINC').empty().addOptions(empty_option);$('#ORDER_HTPLACEINC').empty().addOptions(empty_option);$('#ORDER_MEALINC').empty().addOptions(empty_option);break;case'F':$('#ORDER_CLASSINC').empty().addOptions(empty_option);$('#ORDER_FRPLACEINC').empty().addOptions(empty_option);$('#ORDER_FREIGHTINC').empty().addOptions(empty_option);break;case'S':$('#ORDER_DATEEND').prop('disabled',true);$('#ORDER_SERVICEINC').empty().addOptions(empty_option);$('#ORDER_TOWNS_SERVICE').empty().addOptions([{inc:'0|0',title:"----",selected:true}]);$('#ORDER_HOTEL_SERVICE').empty().addOptions(empty_option);break;case'V':$('#ORDER_VISAINC').empty().addOptions(empty_option);break;default:return false;}
return true;}
function getOrderParams(){var useGET=arguments[1]||false;var result={};$('#edit_order').find('select, input').each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this,useGET);if(name&&value&&value!==0){result[name]=value;}});var $order=$('#edit_order');result['ORDER_INC']=$order.data('order');var order_type=$order.data('order-type');result['ORDER_TYPE']=order_type;if(order_type=='S'){result['servtype_inc']=$order.data('servtype');result['ORDER_SERVICE_ROUTEINDEX']=$('#ORDER_SERVICEINC').find('option:selected').data('routeindex');}
if(order_type=='I'){var is_medical=$('#ORDER_INSUREINC').find('option:selected').data('is_medical');result['IS_MEDICAL']=is_medical;}
return $.param(result);}
function _ed_tourist(inc){var tmp='';if(Number(inc)!=0){tmp='&TOURIST_INC='+inc;}
$.getScript(getParams('TOURIST_FORM')+tmp,edit_tourist,false);}
function edit_tourist(){var $edit_tourist_container=$('#edit_tourist');samo.tourist_helpers($edit_tourist_container);samo.helpalt_field($edit_tourist_container);$nopassport=$edit_tourist_container.find('.nopassport');$nopassport.on('click',function(){var $tourist=$edit_tourist_container;var checked=this.checked;$.each(samo.passport_fields,function(){var $field=$tourist.find('[name*="['+this+']"]');if($field.length){$field.prop('disabled',checked);if(checked){$field.removeClass('required');}else{var label=$field.closest('tr').find('label.required');if(label.length){$field.addClass('required');}}}});});$nopassport.triggerHandler('click');var $load=$edit_tourist_container.find('.load');$load.on('click',function(){$.each(['FIRST','LAST'],function(idx,prefix){$.each(['LNAME','NAME'],function(_idx,suffix){var $el=$edit_tourist_container.find('[name*="['+prefix+suffix+']"]');if($el.length&&!$el.val().length){var tourist=Math.abs($('#edit_tourist').data('tourist'));$el.val((prefix=='LAST')?((suffix=='LNAME')?samo.i18n('CL_W_NO_FIRST_LNAME'):samo.i18n('CL_W_NO_FIRST_NAME')):(((suffix=='LNAME')?samo.i18n('CL_W_NO_LAST_LNAME'):samo.i18n('CL_W_NO_LAST_NAME'))+'~'+tourist));}});});var val=$('#edit_tourist').find('[name*="[PSERIE]"]').val()||'';$('#edit_tourist').find('[name*="[PSERIE]"]').val(val.toUpperCase());val=$('#edit_tourist').find('[name*="[PNUMBER]"]').val()||'';$('#edit_tourist').find('[name*="[PNUMBER]"]').val(val.toUpperCase());var $params=$('#edit_tourist_form').serialize();var born=valid_date($('#edit_tourist').find('[name*="[BORN]"]'));var pvalid=valid_date($('#edit_tourist').find('[name*="[PVALID]"]'));var pgiven=valid_date($('#edit_tourist').find('[name*="[PGIVEN]"]'));if(born!==false&&pvalid!==false&&pgiven!==false){$.post(_ROOT_URL+$.param({samo_action:'SAVE_TOURIST'}),$params,null,'script');}
return true;});if(typeof window.external!="undefined"&&"staSelectPeople"in window.external){var $sta_people=$('<button class="sta_people">'+samo.i18n('CL_W_STA_PEOPLE')+'</button>').css('margin-right','10px');$sta_people.on('click',function(){try{var result=window.external.staSelectPeople();if(result instanceof Object){var lastname=result.lname.split(' ');$edit_tourist_container.find('[name*="[HUMAN]"]').val(result.age=='ADL'?(result.sex=='MALE'?'MR':'MRS'):result.age);$edit_tourist_container.find('[name*="[MALE]"][value='+(result.sex=='MALE'?1:0)+']').prop('checked',true);$edit_tourist_container.find('[name*="[LASTNAME_LNAME]"]').val(lastname[0]);if(lastname.length>1){$edit_tourist_container.find('[name*="[FIRSTNAME_LNAME]"]').val(lastname[1]);}
$edit_tourist_container.find('[name*="[BORN]"]').val(result.born?samo.dateFromString(result.born,'yyyy-mm-dd'):'');$edit_tourist_container.find('[name*="[PLACEBORN]"]').find('option[html="'+result.bornplace+'"]').prop('selected',true);$edit_tourist_container.find('[name*="[PSERIE]"]').val(result.pserie);$edit_tourist_container.find('[name*="[PNUMBER]"]').val(result.pnumber);$edit_tourist_container.find('[name*="[PVALID]"]').val(result.pexpire?Date.fromString(result.pexpire,'yyyy-mm-dd').asString():'');$edit_tourist_container.find('[name*="[PGIVEN]"]').val(result.pgiven?Date.fromString(result.pgiven,'yyyy-mm-dd').asString():'');$edit_tourist_container.find('[name*="[PGIVENORG]"]').val(result.pgivenorg);$edit_tourist_container.find('[name*="[NATIONALITY]"]').find('option[html="'+result.nationality+'"]').prop('selected',true);$load.click();}}catch(e){}});$load.before($sta_people);}}
samo.post_calc=function(price){$module_container.find('.commission_money').html(price.SumCommission+' '+price.Currency_Alias).end().find('.amount_money').html(price.Amount+' '+price.Currency_Alias).end().find('.toggle_details').css('display','inline');};$module_container.find('.auth_commission').on('click',function(){$.getScript(_ROOT_URL+$.param({samo_action:'COMMISSION'}));});$module_container.find('.toggle_details').on('click',function(){var $self=$(this);if($self.data('show')==$self.text()){$(samo.controls.COMMISSIONS).slideDown(function(){$self.text($self.data('hide'));});}else{$(samo.controls.COMMISSIONS).slideUp(function(){$self.text($self.data('show'));});}});function valid_date(field){var value='';if(field.length&&field.clearVal().length){value=$.controlValue(field.get(0));value=parseInt(value);if(value>20790000||value<19010000){samo.field.error(samo.i18n('INCORRECT_DATE'),field);return false;}}
return value;}
function getParams(action){var useGET=arguments[1]||false;var result={};result.samo_action=action;_controls.each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this,useGET);if(name&&value&&value!==0){result[name]=value;}});return _ROOT_URL+$.param(result);}
function ischange(el){if($(el).val()!=$(el).data('old')){$(el).data('old',$(el).val());return true;}
return false;}
function gdsForm(){var $gdsContainer=$('#gdsContainer');$gdsContainer.find('.gds_born input.date').datePicker();$gdsContainer.find('.SOURCEPOINT').chosen({width:"100%"});$gdsContainer.find('.TARGETPOINT').chosen({width:"100%"});$gdsContainer.find("select[name='class']").chosen({width:"100%"});$gdsContainer.find('.SOURCEPOINT, .TARGETPOINT, select[name=\'class\']').on('change',function(){$('.freight_setup_next').removeClass('hidden');$('._frmSendFreight').addClass('hidden');$('.load-external-freights').addClass('hidden');});$gdsContainer.on('click','._frmFreightConfig',function(){var $source=$gdsContainer.find('.SOURCEPOINT'),$target=$gdsContainer.find('.TARGETPOINT');if(!$source.val()){$source.errorField(samo.i18n('NOT_SET_TOWN'));return false;}
if(!$target.val()){$target.errorField(samo.i18n('NOT_SET_TOWN'));return false;}
$gdsContainer.find('._frmTownsFreight').one('change',function(){$gdsContainer.find('.freight_setup_dates').hide();$gdsContainer.find('.gds_born').hide();$gdsContainer.find('.freight_setup_next').css('visibility','visible');$gdsContainer.find('.freight_setup_dates .date').val('');$('#freightsContainer').hide().find('.freightTable').empty();$gdsContainer.find('.load-external-freights').prop('disabled',true);});$gdsContainer.find('.freight_setup_dates input, .gds_born input').off('change.datepicker').on('change.datepicker',function(){$('#freightsContainer').hide().find('.freightTable').empty();$gdsContainer.find('.load-external-freights').prop('disabled',true);});let params={};$gdsContainer.find('._frmTownsFreight').each(function(index,el){let $el=$(el),name=$el.attr('name'),val;val=name=='directonly'&&$el.prop('checked')?1:$el.val();params[name]=val;});params.samo_action='EXTERNAL_FREIGHTS_CONFIGURE';$.post(_ROOT_URL+$.param(params),null,function(){let $tr=$gdsContainer.find('.freight_setup_dates');$tr.css('display','table-row');$tr.find('input.frm-input').addClass('date').datePicker();$tr=$gdsContainer.find('.gds_born');$tr.css('display','table-row');$('.freight_setup_next').addClass('hidden');$('._frmSendFreight').removeClass('hidden');$('.load-external-freights').addClass('hidden');},'script');});$gdsContainer.on('click','._frmSendFreight',function(){$gdsContainer.find('.FREIGHTSINFO').find('.freightsFilter,.freightsRes').show();$gdsContainer.find('.freightsFilter').html('');$gdsContainer.find('.FREIGHTSINFO tbody.freightTable:eq(0)').html('');var $POINT;$POINT=$gdsContainer.find('.SOURCEPOINT');if(!$POINT.val()){$POINT.errorField(samo.i18n('NOT_SET_TOWNFROMINC'));return;}else{$POINT.removeClass('error');}
$POINT=$gdsContainer.find('.TARGETPOINT');if(!$POINT.val()){$POINT.errorField(samo.i18n('NOT_SET_TOWNTO'));return;}else{$POINT.removeClass('error');}
let is_ok=true;$gdsContainer.find('input.GDSBORN').each(function(){if($(this).val()===''){message=samo.i18n('REQUIRED_FIELD_EMPTY');let field_title=$(this).data('field-title')||$(this).closest('tr').find('label:first').text();field_title=field_title.replace(/:$/,'');if(field_title){message=field_title+': '+message;}
$(this).errorField(message);is_ok=false;}});if(!is_ok){return false;}
samo.checkGDSActionResponse();});$gdsContainer.on('click','.load-external-freights',function(){var freightSelect=$gdsContainer.find('.freightTable input[data-checked=checked]');if(freightSelect.length){var $tr=$(freightSelect).parents('tr:first');if($tr.hasClass('superfreight')){$.notify(samo.i18n('SUPERFREIGHT_SELECTED'));return false;}else{var params={};params.ORDER_INC=$gdsContainer.data('order');var freights={};var freight_counter=-1;$gdsContainer.find('.freightTable input[data-checked=checked]').each(function(){let $self=$(this);if($self.val()>0){freight_counter++;let _freight_json=$self.data('json');let freight_json=$.extend({},_freight_json);freights[freight_counter]=freight_json;}});params.FREIGHTS=freights;$.post(_ROOT_URL+$.param({samo_action:'GDS_FREIGHT_SAVE'}),params,function(){$('#GDS').empty();$('#gdsContainer .overlay').addClass('hidden');},'script');}}});$gdsContainer.on('click','.close-external-freights',function(){$('#GDS').empty();$('#gdsContainer .overlay').addClass('hidden');});return true;}
samo.checkGDSActionResponse=function(frClass,guid,progress,target){var params={};var $gdsContainer=$('#gdsContainer');if(typeof frClass=='undefined'){var filterVal=$("select[name='class']").val();frClass=(filterVal==1||typeof filterVal=='undefined')?"Econom":(filterVal=='2'?"Business":"Comfort");}
$('._frmSendFreight').prop('disabled',true).trigger("chosen:updated");$('._frmTownsFreight').prop('disabled',true).trigger("chosen:updated");$gdsContainer.find('.freight_setup_dates input').prop('disabled',true);$gdsContainer.find('.gds_born input').prop('disabled',true);$gdsContainer.find('.load-external-freights').prop('disabled',true);if(!progress){progress=2.5;}
$('#freightsContainer').show();$gdsContainer.find('.result-progress').show();$gdsContainer.find('.freightsRes .messages').html(samo.i18n('FLIGHTS_LOAD'));$gdsContainer.find('.result-progress .blue').css('width',progress+'%');var delay=1;var $container=$gdsContainer.find('.FREIGHTSINFO');var $selects=$container.find('select');$selects.prop('disabled',true).addClass('samo-preloader');var $_get={};$('._frmTownsFreight').each(function(index,el){var $el=$(el),name=$el.attr('name'),val;val=name=='directonly'&&$el.prop('checked')?1:$el.val();params[name]=val;});if($module_container.find('.FREIGHT_DIRECT').length==1){params.FREIGHT_DIRECT=samo.dateAsString(samo.dateFromString($gdsContainer.find('.FREIGHT_DIRECT').val()),'yyyymmdd');}
if($module_container.find('.FREIGHT_BACK').length==1){params.FREIGHT_BACK=samo.dateAsString(samo.dateFromString($gdsContainer.find('.FREIGHT_BACK').val()),'yyyymmdd');}
$_get.samo_action='CHECK_GDS_ACTION_RESPONSE';params.fClass=(frClass&&frClass=='Business')?'Business':((frClass&&frClass=='Comfort')?'Comfort':'Econom');if(target){params.target=target;}
params.inf=$gdsContainer.find(".addinfant_cb").prop('checked')?1:0;params.ins=$gdsContainer.find(".INFANT_FREIGHT_PLACE").prop('checked')?1:0;$_get.extfr=1;$_get.doSearch=1;$_get.guid=guid;params.progress=progress;if(guid){$_get.doSearch=0;delay=3000;}
params['gdsBorn']=[];$gdsContainer.find('input.GDSBORN').each(function(i){params['gdsBorn'][i]={'key':$(this).data('key'),'val':$(this).val()};});setTimeout(function(){$.post(samo.ROUTES.cl_wizard.url+$.param($_get),params,false,'script');},delay);};samo.errorGDSActionResponse=function(){var $gdsContainer=$('#gdsContainer');var msg=arguments.length==1?arguments[0]:samo.i18n('FLIGHTS_LOAD_ERROR');$('._frmSendFreight').prop('disabled',false).trigger("chosen:updated");$('._frmTownsFreight').prop('disabled',false).trigger("chosen:updated");$gdsContainer.find('.freight_setup_dates input').prop('disabled',false);$gdsContainer.find('.gds_born input').prop('disabled',false);$gdsContainer.find('.load-external-freights').prop('disabled',true);$gdsContainer.find('.result-progress .blue').css('width','100%');$gdsContainer.find('.freightsRes .messages').html(msg);$gdsContainer.find('.result-progress').hide();$gdsContainer.find('.result-progress .blue').css('width','2.5%');$gdsContainer.find('.samo-preloader').removeClass('samo-preloader');$.notify({type:'error',text:msg,permanent:0});};samo.getGDSDataResponse=function(fClass,guid,target){let $gdsContainer=$('#gdsContainer');$gdsContainer.find('.result-progress .blue').css('width','100%');$gdsContainer.find('.freightsRes .messages').html('');$gdsContainer.find('.addinfant_cb').prop('disabled',false);$gdsContainer.find('.INFANT_FREIGHT_PLACE').prop('disabled',false);const $self=$(this),$container=$gdsContainer.find('.FREIGHTSINFO');$self.prop('disabled',true).addClass('samo-preloader');let $selects=$container.find('select');$selects.prop('disabled',true).addClass('samo-preloader');let params={};params.samo_action='EXTERNAL_FREIGHTS';params.fClass=fClass;params.inf=$(".addinfant_cb").prop('checked')?1:0;params.ins=$(".INFANT_FREIGHT_PLACE").prop('checked')?1:0;params.extfr=1;params.guid=guid;params.target=target;$.post(samo.ROUTES.cl_wizard.url+$.param(params),{},function(){let $gdsContainer=$('#gdsContainer');$self.prop('disabled',false).removeClass('samo-preloader');$container.find('.samo-preloader').prop('disabled',false).removeClass('samo-preloader');$container.find('select.freight:eq(0)').change();let filterByClass=$('select[name=class]');let filterByFlyDuration=$('#flyDurationSlider');if(filterByClass.length){let sValue=(params.fClass=='Econom')?1:(params.fClass=='Business'?2:3);filterByClass.find('option[value='+sValue+']').prop('selected',true);}
if(filterByFlyDuration.length){samo.filterSliders(filterByFlyDuration);}
$('#freightsContainer').off('click').on('click','.freightsFilter .hideLink a',function(){$($(this).parent().attr('data-hide-target')).toggle();return false;}).off('change').on('change','.freightsFilter select',function(){let selectName=$(this).attr('name');if(selectName=='flight_types'||selectName=='full_airline'){samo.refreshFreightTable();}else if(selectName=='class'||selectName=='target'){const classVal=$('.freightsFilter select[name="class"]').val();const classReq=(typeof classVal=='undefined'||classVal=='1')?"Econom":(classVal=='2'?"Business":"Comfort");const targetReq=$('.freightsFilter  select[name="target"]').val();$('.freightTable, .freightsFilter, .currency').html('');samo.checkGDSActionResponse(classReq,undefined,undefined,targetReq);}});$gdsContainer.find('.result-progress').hide();$gdsContainer.find('.result-progress .blue').css('width','2.5%');$('._frmSendFreight').prop('disabled',false).trigger("chosen:updated");$('._frmTownsFreight').prop('disabled',false).trigger("chosen:updated");$gdsContainer.find('.freight_setup_dates input').prop('disabled',false);$gdsContainer.find('.gds_born input').prop('disabled',false);$gdsContainer.on('click','tr[class*=_freightOffer-]',function(event){let offerHash=$(this).data('offerHash');let rchecked=$('input._dataCheckedFR'+offerHash).prop('checked');if(rchecked!==true){$('input[class*=_dataCheckedFR]').removeAttr('data-checked');$('input._dataCheckedFR'+offerHash).attr('data-checked','checked');$('input._dataCheckedFR'+offerHash+'[type=hidden]').attr('data-checked','checked');$('input._dataCheckedFR'+offerHash+'[type=radio]').prop('checked',true);unHightlight($(this),'checked');$('.freight_setup_next').addClass('hidden');$('._frmSendFreight').addClass('hidden');$('.load-external-freights').removeClass('hidden');$('#gdsContainer .load-external-freights').prop('disabled',false);}});$gdsContainer.on('mouseenter','tr[class*=_freightOffer-]',function(event){unHightlight($(this));});$gdsContainer.on('mouseup','input[class*=_dataCheckedFR]',function(event){$(this).parents('tr:first').trigger('click');event.preventDefault();});$gdsContainer.on('click','._freightPlanReplace',function(event){$(this).parent().click();var params=$(this).data();params.claimDocument=samo.claimDocumentGDS();$.post(getParams('EXTERNAL_FREIGHTS_PLANS'),params,null,'script');});$(document).on('click','._freightPlanTabPanel',function(){var tabid=$(this).data('tabid');$('._freightPlanTab').addClass('hidden');$('#freightPlanTab'+tabid).removeClass('hidden');$('._freightPlanTabPanel').each(function(index,el){$(el).removeClass('searchmode_selected');$(el).addClass('searchmode_not_selected');$('#freightPlanTabLabel'+$(el).data('tabid')).addClass('searchmode_button');});$('#freightPlanTabLabel'+tabid).removeClass('searchmode_button');$('#freightPlanTabPanel'+tabid).removeClass('searchmode_not_selected');$('#freightPlanTabPanel'+tabid).addClass('searchmode_selected');});$(document).on('click','.freightPlanReplaceButton',function(){var params=$(this).data();$.post(getParams('SET_FREIGHTS_PLAN'),params,null,'script');});},'script',function(){$.notify({type:'error',text:samo.i18n('FREIGHT_LOAD_FAILED'),permanent:0});$self.prop('disabled',false).removeClass('samo-preloader').css('display','block');$('._frmSendFreight').prop('disabled',false).trigger("chosen:updated");$('._frmTownsFreight').prop('disabled',false).trigger("chosen:updated");});};var unHightlight=function(obj,cssClass){if(typeof cssClass=='undefined'){cssClass='yellow';}
var offerHash=obj.data('offerHash');$('tr[class*=_freightOffer]').removeClass(cssClass);$('tr[class*=-'+offerHash+']').addClass(cssClass);};};samo.tr_lights=function(){var hashLi='',hashOld='old',lightLi='';var $table=$('#gdsGrid');if($table.find('tbody tr').length){$table.show();$table.find('tbody tr:not(.note):visible').each(function(){var trLi=$(this);hashLi=trLi.attr('data-offer-hash');trLi.removeClass('even').removeClass('odd');if(hashOld!==hashLi){lightLi=(lightLi==='odd')?'even':'odd';trLi.addClass(lightLi);hashOld=hashLi;}else{trLi.addClass(lightLi);}});}else{$table.hide();}};samo.filterSliders=function(){var $gdsContainer=$('#gdsContainer');var sliders=['flyDurationSlider','departTimeOnSlider','departTimeOffSlider'];var sections=['fly_duration','depart_time_on','depart_time_off'];for(var i=0;i<sliders.length;i++){var slider=document.getElementById(sliders[i]);if(slider){var min=isNaN(parseInt(samo.getValuesBySlideRange('min',sections[i])))?false:parseInt(samo.getValuesBySlideRange('min',sections[i]));var max=isNaN(parseInt(samo.getValuesBySlideRange('max',sections[i])))?false:parseInt(samo.getValuesBySlideRange('max',sections[i]));if(min&&max&&(min!=max)){noUiSlider.create(slider,{start:[min,max],behaviour:'drag-tap',connect:true,step:30,range:{'min':min,'max':max}});}}}
var flyDurationVals=[document.getElementById('fly-duration-value-lower'),document.getElementById('fly-duration-value-upper')];var departTimeOnVals=[document.getElementById('depart-time-on-value-lower'),document.getElementById('depart-time-on-value-upper')];var departTimeOffVals=[document.getElementById('depart-time-off-value-lower'),document.getElementById('depart-time-off-value-upper')];var flyDuration=document.getElementById('flyDurationSlider');var departTimeOn=document.getElementById('departTimeOnSlider');var departTimeOff=document.getElementById('departTimeOffSlider');if(typeof flyDuration.noUiSlider!=='undefined'){flyDuration.noUiSlider.on('update',function(values,handle){flyDurationVals[handle].innerHTML=((parseInt(values[handle]/ 60)<10)?'0':'')+parseInt(values[handle]/ 60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});flyDuration.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(flyDuration).parent().parent().hide();}
if(typeof departTimeOn.noUiSlider!=='undefined'){departTimeOn.noUiSlider.on('update',function(values,handle){departTimeOnVals[handle].innerHTML=((parseInt(values[handle]/ 60)<10)?'0':'')+parseInt(values[handle]/ 60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});departTimeOn.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(departTimeOn).parent().parent().hide();}
if(typeof departTimeOff.noUiSlider!=='undefined'){departTimeOff.noUiSlider.on('update',function(values,handle){departTimeOffVals[handle].innerHTML=((parseInt(values[handle]/ 60)<10)?'0':'')+parseInt(values[handle]/ 60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});departTimeOff.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(departTimeOff).parent().parent().hide();}
$gdsContainer.on('click','.sortbyduration',function(){if($(this).hasClass('asc')){$(this).removeClass('asc');$(this).addClass('desc');_gdsSort('fly_duration','desc');}else if($(this).hasClass('desc')){$(this).removeClass('desc');$(this).addClass('asc');_gdsSort('fly_duration','asc');}else{$(this).addClass('asc');_gdsSort('fly_duration','asc');}
return false;});$gdsContainer.on('click','.sortbysurcharge',function(){if($(this).hasClass('asc')){$(this).removeClass('asc');$(this).addClass('desc');_gdsSort('surcharge','desc');}else if($(this).hasClass('desc')){$(this).removeClass('desc');$(this).addClass('asc');_gdsSort('surcharge','asc');}else{$(this).addClass('asc');_gdsSort('surcharge','asc');}
return false;});function _gdsSort(field,type){type=type||'asc';var grid=document.getElementById('gdsGrid');var tbody=grid.getElementsByTagName('tbody')[0];var rowsArray=[].slice.call(tbody.rows);var tmpTable=[];var rowSpans=0;var rows=0;var i,p;for(i=0;i<rowsArray.length;i++){rowSpans=rowsArray[i].cells[0].rowSpan;if(i==rows){var toPush=[];for(p=0;p<rowSpans;p++){toPush[p]=rowsArray[i+p];}
var params=JSON.parse(rowsArray[i].dataset.bindFilter);toPush[p]=params[field];tmpTable.push(toPush);rows=i+rowSpans;}}
var compare=function(rowA,rowB){return rowA[rowA.length-1]-rowB[rowB.length-1];};tmpTable.sort(compare);if(type=='desc'){tmpTable.reverse();}
grid.removeChild(tbody);for(i=0;i<tmpTable.length;i++){for(p=0;p<(tmpTable[i].length-1);p++){tbody.appendChild(tmpTable[i][p]);}}
grid.appendChild(tbody);samo.tr_lights();}};samo.refreshFreightTable=function(){var flyDurationEl=document.getElementById('flyDurationSlider');var departTimeOnEl=document.getElementById('departTimeOnSlider');var departTimeOffEl=document.getElementById('departTimeOffSlider');var flyDuration=typeof flyDurationEl.noUiSlider!='undefined'?flyDurationEl.noUiSlider.get():[0,999999999];var departTimeOn=typeof departTimeOnEl.noUiSlider!='undefined'?departTimeOnEl.noUiSlider.get():[0,999999999];var departTimeOff=typeof departTimeOffEl.noUiSlider!='undefined'?departTimeOffEl.noUiSlider.get():[0,999999999];var airlineF=$(".freightsFilter select[name='full_airline'] option:selected");var flightTypesF=$(".freightsFilter select[name='flight_types'] option:selected");$('.freightTable tr').each(function(){$(this).show();var trFilter=JSON.parse($(this).attr('data-bind-filter'));if(airlineF.length&&airlineF.val()!=0){if(trFilter['full_airline']!=airlineF.val()){$(this).hide();}}
if(flightTypesF.length&&flightTypesF.val()!=0){if(trFilter['flight_types']!=flightTypesF.val()){$(this).hide();}}
if(trFilter['fly_duration_on']<parseInt(flyDuration[0])||trFilter['fly_duration_off']<parseInt(flyDuration[0])){$(this).hide();}
if(trFilter['fly_duration_on']>parseInt(flyDuration[1])||trFilter['fly_duration_off']>parseInt(flyDuration[1])){$(this).hide();}
if(trFilter['depart_time_on']<parseInt(departTimeOn[0])){$(this).hide();}
if(trFilter['depart_time_on']>parseInt(departTimeOn[1])){$(this).hide();}
if(trFilter['depart_time_off']<parseInt(departTimeOff[0])){$(this).hide();}
if(trFilter['depart_time_off']>parseInt(departTimeOff[1])){$(this).hide();}});var messagesBlock=$('.freightsRes .messages');if($('.freightTable tr:visible').length==0){messagesBlock.html(samo.i18n('NO_FREIGHTS'));$('.freight_setup_next').addClass('hidden');$('._frmSendFreight').removeClass('hidden');$('.load-external-freights').addClass('hidden');}else{messagesBlock.html('');$('.freight_setup_next').addClass('hidden');$('._frmSendFreight').addClass('hidden');$('.load-external-freights').removeClass('hidden');}
samo.tr_lights();};samo.getValuesBySlideRange=function(type,section){var min=999999999;var max=0;$(".freightTable tr:visible").each(function(){var data=JSON.parse($(this).attr('data-bind-filter'));if(section!='fly_duration'){if(data[section]<min){min=data[section];}
if(data[section]>max){max=data[section];}}else{if(data.fly_duration_on<min){min=data.fly_duration_on;}
if(data.fly_duration_off<min){min=data.fly_duration_off;}
if(data.fly_duration_on>max){max=data.fly_duration_on;}
if(data.fly_duration_off>max){max=data.fly_duration_off;}}});if(type=='min'){return min;}
if(type=='max'){return max+1;}
return false;};samo.claimDocumentGDS=function(){var freight_counter=-1;let $gdsContainer=$('#gdsContainer');var claimDocument={};claimDocument['transports']=[];var freightSelect='.freightTable input[data-checked=checked]';$gdsContainer.find(freightSelect).each(function(){var $self=$(this);if($self.val()>0){freight_counter++;var freight=$self;var routeindex=$self.data('routeindex');var _freight_json=freight.data('json'),_freight_seats=freight.data('seats');if(typeof _freight_seats=='undefined'){_freight_seats=samo.frplacement_seats[_freight_json.key];}
var freight_json=$.extend({},_freight_json),freight_seats=$.extend({},_freight_seats);var clients=[];if(typeof freight_json.clients!='undefined'){clients=[];$(freight_json.clients).each(function(){var client={peopleKey:this.peopleKey,common:this.common,};if(freight_seats&&typeof freight_seats[client.common]!='undefined'){client.seatKey=freight_seats[client.common]['inc'];client.seatName=freight_seats[client.common]['name'];if(typeof freight_seats[client.common]['full_coupe']!=='undefined'){client.full_coupe=freight_seats[client.common]['full_coupe'];}}
clients.push(client);});freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}else{$gdsContainer.find('.GDSBORN').each(function(){let x=$(this).data('key');if(freight_seats&&freight_seats[x]){clients.push({'peopleKey':x,'common':x,'seatKey':freight_seats[x]['inc'],'seatName':freight_seats[x]['name']});}else{clients.push({'peopleKey':x,'common':x});}});if(routeindex!='undefined'){freight_json.routeIndex=routeindex;}
freight_json.count=$gdsContainer.find('.GDSBORN').length;freight_json.addinfant=0;freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}}});return claimDocument;};$.expr.pseudos.textbegin=function(obj,index,meta,stack){return(obj.textContent||obj.innerText||jQuery(obj).text()||'').indexOf(meta[3])==0;};$(samo.cl_wizard);})(samo.jQuery);