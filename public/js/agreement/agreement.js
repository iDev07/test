(function($){samo.agreement=function(){var _ROOT_URL=samo.ROUTES.agreement.url;var $module_container=$('#agreement');var $last=null;samo.download_in_progress=false;samo.cache_controls($module_container);$module_container.on('click','a.dog',function(e){$last=e;samo.delayed_download(e);});var download_agreement=function(event,href){samo.download_in_progress=true;if(event==null){var click=false;var params=samo.parseURL(href).params;$.each($module_container.find('a.dog'),function(i,v){var p=samo.parseURL($(v).attr('href')).params;if(p.INC==params.INC&&click==false){var test=true;$.each(p,function(key,row){if(p[key]!=params[key]){test=false;}});if(test){click=true;$(v).attr('href',href).click();}}});}else{$(event.target).attr('href',href);samo.delayed_download(event);}};$('body').on('click','a.next',function(e){e.stopPropagation();e.preventDefault();if(samo.download_in_progress===false){download_agreement($last,$(this).attr('href'));}});samo.reset_download_in_progress=function(){samo.download_in_progress=false;}
samo.display_ndog=function(result){$($last.target).parents('tr:first').find('td.ndog').text(result.ndog);};var check_fields=function(){var is_ok=true,$popup=$('#new_reason');samo.field.clear_errors($popup);$popup.find('.required').not('label').each(function(){if(!$(this).val().length){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}});if(is_ok){$popup.find('.date').each(function(){if(this.value.length&&!$.valid_date(this)){is_ok=samo.field.error(samo.i18n('DATE_FORMAT_TITLE'),this);return false;}});}
return is_ok;};$('body').on('click','#REASON_FORM_SUBMIT',function(e){e.stopPropagation();e.preventDefault();if(check_fields()){var $link=$($last.target);var href=$('#REASON_FORM').attr('action');$link.data('post-form','#REASON_FORM');download_agreement($last,href);$link.removeData('post-form');}});samo.download_last=function(id){var $link=$($last.target);$link.attr('href',$link.attr('href')+'&SAVEFORM='+id);$.modal.close();};samo.reason_form_load=function(){$('#new_reason').find('.date').datePicker({direction:false});samo.helpalt_field($('#new_reason'));};$module_container.on('click','.e_doc_btn_attach',function(e){var $btn=$(this),data=$btn.parents('tr:first').data();var contracts_document_inc=parseInt(data.contracts_document,10);var doctype=parseInt(data.doctype,10);$.getScript(_ROOT_URL+$.param({samo_action:'E_DOC',CONTRACTS_DOCUMENT_INC:contracts_document_inc,EDOC_UPLOAD_DOCTYPE:doctype}));});$module_container.on('click','.e_doc_btn_detach',function(e){var $btn=$(this),data=$btn.parents('tr:first').data();var contracts_document_inc=parseInt(data.contracts_document,10);var doctype=parseInt(data.doctype,10);$.getScript(_ROOT_URL+$.param({samo_action:'E_DOC_DETACH',CONTRACTS_DOCUMENT_INC:contracts_document_inc,EDOC_UPLOAD_DOCTYPE:doctype}));});$('body').on('click','#E_DOC_BTN_UPLOAD',function(e){var contracts_document_inc=$(this).parents('#e_doc:first').data('contracts_document_inc');var $elements=$('#edoc_file');var doctype=$(this).parents('#e_doc:first').data('doctype');var upload_format=$(this).parents('#e_doc:first').data('upload_format');var upload_max_size=$(this).parents('#e_doc:first').data('upload_size');if(samo.check_file_extension($elements,upload_format,upload_max_size)){var load_btn=samo.loadBtn;samo.loadBtn=$(this);$.ajax({async:true,dataType:'iframe script',type:'POST',url:_ROOT_URL+$.param({CONTRACTS_DOCUMENT_INC:contracts_document_inc,EDOC_UPLOAD_DOCTYPE:doctype,samo_action:'UPLOAD_EDOC',is_js:1}),fileInput:$elements});samo.loadBtn=load_btn;}});};$(samo.agreement);})(samo.jQuery);