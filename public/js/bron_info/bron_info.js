(function($){samo.frplacement_available=1;samo.frplacement_blocked=2;samo.MINLONGINT=-2147483647;samo.frplacement_seats={};samo.frplacement_titles={};samo.ForceBoardingAllow=null;samo.bron_info=function(){var _ROOT_URL=samo.ROUTES.bron.url,$module_container=$('#bron_info');samo.cache_controls($module_container);samo.controls.bron=$module_container.find('button.bron');samo.controls.calc=$module_container.find('button.calc');samo.controls.additional_services=$module_container.find('button.additional_services');samo.controls.offered_additional_service=$module_container.find('button.offered_additional_service');samo.controls.CLAIM_NOTE=$module_container.find('.CLAIM_NOTE');var $handleControls=$module_container.find('.human,.lastlname,input[name*=BORN],select[name*=PLACEBORN],input[name*=PSERIE],input[name*=PNUMBER],input[name*=PVALID],select[name*=NATIONALITY]');var oldValues=null;$handleControls.on('blur',function(){oldValues=compareValuesHandleControls($handleControls,oldValues);});var CATCLAIM=$.getParameter('CATCLAIM',true);if(CATCLAIM){samo.jQuery('#bron-info-link-to-page').append('<a class="external" title="'+samo.i18n('BRON_ID')+'">'+samo.i18n('BRON_ID')+'</a>').find('.external').on('click',function(){return samo.popupText(this,CATCLAIM,true);});}
function compareValuesHandleControls($controls,oldValues){var newValues='';$controls.each(function(){newValues+=$(this).val();});if(newValues!=oldValues){button_disable(1,'bron');}
return newValues;}
samo.freightInfant()
$module_container.find(".tourists-tabs .tourist").find('[name*="[HUMAN]"]').on('change',function(){let touristType=$(this).val();let touristId=$(this).data('tourist-inc');$('#tourist'+touristId).data('human',touristType);$('#bron_info').find('.ASERVICES tbody tr').not('.note, .freightInfo').each(function(){let service=$(this).data('json');if(typeof service==='undefined'){return;}
let tourists=service.clients;let isTouristPresent=false;tourists.forEach(function(tourist,index){if(tourist.peopleKey==touristId){isTouristPresent=true;if(tourist.human!==touristType){if(touristType==='MR'||touristType==='MRS'){if(service.allowed_adult){tourist.human=touristType;}else{tourists.splice(index,1);$.notify({text:samo.i18n('REMOVE_ADULT_SERVICE')+' '+service.name,type:'message'});}}
if(touristType==='CHD'){if(service.allowed_child){tourist.human=touristType;}else{tourists.splice(index,1);$.notify({text:samo.i18n('REMOVE_CHILD_SERVICE')+' '+service.name,type:'message'});}}}}});if(!isTouristPresent){if((touristType==='MR'||touristType==='MRS')&&service.allowed_adult){tourists.push({'peopleKey':touristId,'common':touristId,'human':touristType});$.notify({text:samo.i18n('ADD_ADULT_SERVICE')+' '+service.name,type:'message'});}
if(touristType==='CHD'&&service.allowed_child){tourists.push({'peopleKey':touristId,'common':touristId,'human':touristType});$.notify({text:samo.i18n('ADD_CHILD_SERVICE')+' '+service.name,type:'message'});}}
if(tourists.length===0){$(this).remove();}else{let compositionTourists=samo.compositionTourists(tourists);service.clients=tourists;service.count=tourists.length-service.addinfant;$(this).data('json',service);$(this).find('.tourists_count').text(tourists.length);$(this).find('.tourists_composition').attr('title',compositionTourists.toString());}});});window.onbeforeunload=function(){var modified=false;$module_container.find('input').each(function(){var a=this;if((a.nodeName=='INPUT'&&(a.type=='checkbox'||a.type=='radio')&&a.defaultChecked!=a.checked)||(a.nodeName=='INPUT'&&a.defaultValue!=a.value&&{'text':true,'hidden':true,'file':true,'password':true}[a.type])){modified=true;}});if(!modified){return window.undefined;}
return samo.i18n('UNLOAD_WARNING');};var $contract_url=$('#contract_url');if($contract_url.length>0){samo.download_file=function(url){$contract_url.attr('href',url).on('click',function(e){e.preventDefault();$(this).gdocsViewer();}).removeClass('hidden');};$contract_url.one('click',samo.delayed_download).click();}
function msg(message){$.notify({text:message,type:'error'});}
function button_disable(bron,button){button=button||'bron';samo.controls[button].prop('disabled',bron);}
var init_resultset=function(selector){$module_container.find(selector).find('table.res').each(function(){var $table=$(this);if($table.find('tbody tr').length){$table.show().find('tbody tr:not(.note):odd').removeClass('even').addClass('odd').end().find('tbody tr:not(.note):even').removeClass('odd').addClass('even');}else{$table.hide();}});};let serviceTransport=function(){let $container=$('#additional_services_transport');let changes=false;let services=[];let transportKey;$container.find(':checkbox').each(function(){transportKey=$(this).closest('tr').data('json').transportKey
if(this.defaultChecked!=this.checked){changes=true;return false;}});$('.ASERVICES_TRANSPORT_INFO').find('tr[data-freight-id="'+transportKey+'"]').remove()
changes=changes||$container.find('tr[changed=1]').length;$container.find('.mainservice').filter(':checked').each(function(){let $tr=$(this).parents('tr:first');let data=$tr.data();let service_json=data.json;let mainserviceuid=data.mainserviceuid;let serviceNote=$container.find('.note-'+mainserviceuid+' .service_note').html();let service_price=$tr.find('span.service_price').html();if($tr.find('.service_dates').length){let $option=$tr.find('.service_dates').find('option:selected');service_json.uid=$option.val();service_json.datebeg=$option.data('datebeg');service_json.dateend=$option.data('dateend');}
services[mainserviceuid]={'service':service_json,'serviceNote':serviceNote,'service_price':service_price};services[mainserviceuid].service.count=services[mainserviceuid].service.clients.length;});$container.find('.tourist_service').filter(':checked').each(function(){let mainserviceuid=$(this).data('mainserviceuid');let people=$(this).data('people');let human=$(this).data('human');if(!services[mainserviceuid]){let service=$container.find('tr[data-mainserviceuid='+mainserviceuid+']');let service_json=service.data('json');service_json.clients=[{'peopleKey':people,'common':people,'human':human}];let serviceNote=$container.find('.note-'+mainserviceuid+' .service_note').html();let service_price=service.find('span.bron_service_price').html();if(service.find('.service_dates').length){let $option=service.find('.service_dates').find('option:selected');service_json.uid=$option.val();service_json.datebeg=$option.data('datebeg');service_json.dateend=$option.data('dateend');}
services[mainserviceuid]={'service':service_json,'serviceNote':serviceNote,'service_price':service_price};}else{services[mainserviceuid].service.clients.push({'peopleKey':people,'common':people,'human':human});}
services[mainserviceuid].service.count=services[mainserviceuid].service.clients.length;});$('.ASERVICES_TRANSPORT_INFO').css('display','none');let tpl=$('#services-tpl').html();let content=ejs.render(tpl,{services:services});$('.ASERVICES_TRANSPORT_INFO').append(content);}
var init_services=function(){$('.ASERVICES').find('.date').datePicker();$('.ASERVICES').find('.FREIGHTINFO_PORT').chosen();$('.ASERVICES').find('.FREIGHTINFO_TIME').mask('99:99');$('.ASERVICES').find('.FREIGHTINFO_TIME_BACK').mask('99:99');init_resultset('.ASERVICES');$module_container.find('.additional_services').off('click').on('click',function(){var params={};params.SERVCATEGORY=$(this).data('inc');params.claimDocument=samo.claimDocument(false);params.freightIdForServises=-1;if(params.claimDocument===false){return false;}
$.post(getParams('SHOW_ADDITIONAL_SERVICES'),params,function(){var $container=$('#additional_services');$container.find('select.service_dates').on('change',function(){var $tr=$(this).parents('tr:first');$tr.attr('changed',1);});$container.find('.tourist_service').on('click',function(){var mainserviceuid=$(this).data('mainserviceuid');var service=$container.find('tr[data-mainserviceuid='+mainserviceuid+']');service.find('span.bron_service_price').addClass('line_through');});$('#ADD_ADDITIONAL_SERVICES').on('click',function(){let changes=false;$container.find(':checkbox').each(function(){if(this.defaultChecked!=this.checked){changes=true;return false;}});changes=changes||$container.find('tr[changed=1]').length;if(changes){var services=[];$container.find('.mainservice').filter(':checked').each(function(){var $tr=$(this).parents('tr:first');var data=$tr.data();var service_json=data.json;var mainserviceuid=data.mainserviceuid;var serviceNote=$container.find('.note-'+mainserviceuid+' .service_note').html();var service_price=$tr.find('span.service_price').html();if($tr.find('.service_dates').length){var $option=$tr.find('.service_dates').find('option:selected');service_json.uid=$option.val();service_json.datebeg=$option.data('datebeg');service_json.dateend=$option.data('dateend');}
services[mainserviceuid]={'service':service_json,'serviceNote':serviceNote,'service_price':service_price};services[mainserviceuid].service.count=services[mainserviceuid].service.clients.length;});$container.find('.tourist_service').filter(':checked').each(function(){let mainserviceuid=$(this).data('mainserviceuid');let people=$(this).data('people');let human=$(this).data('human');if(!services[mainserviceuid]){let service=$container.find('tr[data-mainserviceuid='+mainserviceuid+']');let service_json=service.data('json');service_json.clients=[{'peopleKey':people,'common':people,'human':human}];let serviceNote=$container.find('.note-'+mainserviceuid+' .service_note').html();let service_price=service.find('span.bron_service_price').html();if(service.find('.service_dates').length){let $option=service.find('.service_dates').find('option:selected');service_json.uid=$option.val();service_json.datebeg=$option.data('datebeg');service_json.dateend=$option.data('dateend');}
services[mainserviceuid]={'service':service_json,'serviceNote':serviceNote,'service_price':service_price};}else{services[mainserviceuid].service.clients.push({'peopleKey':people,'common':people,'human':human});}
services[mainserviceuid].service.count=services[mainserviceuid].service.clients.length;});$('.ASERVICES').css('display','none');var tpl=$('#services-tpl').html();var content=ejs.render(tpl,{services:services});var servcategory=$(this).data('inc');$('.ASERVICES_'+servcategory).html(content);samo.disablePrice();$(document).triggerHandler('ReloadServices',['RELOADSERVICES']);}
$.modal.close();});button_disable(0,'calc');},'script');});};var init_insures=function(){init_resultset('.INSURESINFO');};var pernight=function(){$('input.pernight').on('change',function(){button_disable(1,'bron');});}
init_services();init_insures();pernight();samo.frplacement_save=function(button,$pTable,$targetResult,additionalServicesTransport){button.disabled=true;var data=null,seats={},seats_count=0,titles=[],$peoples=$pTable.find('tbody tr'),$people=null;$peoples.each(function(){$people=$(this);data=$people.data();if(data.inc){seats[data.people]={'inc':data.inc,'name':data.name};if(typeof data.full_coupe!=='undefined'){seats[data.people].full_coupe=data.full_coupe;}
titles.push($people.find('.frplacement').text());seats_count++;}});var freight=$pTable.data('freight');if(Object.keys(seats).length>0){samo.frplacement_seats[freight]=seats;samo.frplacement_titles[freight]=titles.join(", ");}else{delete samo.frplacement_seats[freight];delete samo.frplacement_titles[freight];}
serviceTransport();let params={freight:freight};params.claimDocument=samo.claimDocument(false);$.post(getParams('CHECK_FRPLACEMENT'),params,function(){button.disabled=false;if($targetResult.length||additionalServicesTransport.length){samo.init_frplacement_bron($targetResult);var $target=$targetResult.parents('select');if($target.length){samo.init_frplacement_bron($target);}}else{samo.redraw_frplacement_bron_gds();}
if(samo.ForceBoardingAllow){checkFreights();}
init_services();},'script');};samo.redraw_frplacement_bron_gds=function(){var $btns=$module_container.find('span.button');if($btns.length){var add_infant=Number($module_container.find('.addinfant_cb').prop('checked'))||0;var $tour_info=$module_container.find('.tour_info');var peoplecount=parseInt($tour_info.data('peoplecount'));var pcount=peoplecount+add_infant;$btns.each(function(){var freightKey=$(this).data('freight');if(typeof freightKey!='undefined'){var $btn=$(this);if(typeof samo.frplacement_seats[freightKey]!=='undefined'){var seats=Object.keys(samo.frplacement_seats[freightKey]),scount=seats.length;var title='';if(typeof samo.frplacement_titles[freightKey]!='undefined'){title=samo.frplacement_titles[freightKey]+", ";}
if(scount>pcount){delete samo.frplacement_seats[freightKey][seats[scount-1]];scount=Object.keys(samo.frplacement_seats[freightKey]).length;}
if(scount==pcount){$btn.addClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHANGE'));}
if(scount<pcount){$btn.removeClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHOOSE'));}}else{$btn.removeClass('seats').attr('data-title',samo.i18n('FRPLACEMENT_CHOOSE'));}}});}};samo.init_frplacement_bron_gds=function(){var disabled=false;$module_container.find('.freightTable').on('click','span.button',function(){if(disabled){return false;}
disabled=true;var freight=$(this).data('freight');var params={freight:freight};params.claimDocument=samo.claimDocument(false);params.maxWidth=$module_container.find('.claim_info').width();params.maxHeight=$(window).height();if(samo.frplacement_seats[freight]){params.seats=samo.frplacement_seats[freight];}
$.post(getParams('CHOOSE_FRPLACEMENT'),params,function(){disabled=false;},'script');});};samo.init_frplacement_bron_gds();samo.init_frplacement_bron=function(event){var target=(typeof event.target!='undefined')?event.target:event;var $select=$(target),$btn=$select.parents('tr:first').find('td.frplacement .button'),$option=$select.find('option:selected'),data=$option.data();var freightKey=$option.val();var $all=$module_container.find('.freights tbody tr').not('.note');var $first_option=$all.first().find('select').find('option:selected');var $first_frplacement=$first_option.data('frplacement');let freightServiceAvailable=$first_option.data('freight-service-available');if((data&&data.frplacement==samo.frplacement_available&&$first_frplacement!=samo.frplacement_blocked)||(typeof freightServiceAvailable!='undefined'&&freightServiceAvailable.length&&freightServiceAvailable!=0)){var disabled=false;if($btn.length===0){$btn=$select.parents('tr:first').find('td.frplacement').append('<span class="button">&nbsp;</span>');}
$('td.frplacement > .button, i[data-name="editFreight"]').off("click").on('click',function(){if(disabled){return false;}
disabled=true;var $option=$(this).parents('tr:first').find('select option:selected');if($option.length===0){$option=$('#freightsContainer').find("select option[value='"+$(this).data('freight-id')+"']:selected");}
var params={freight:$option.val()};params.claimDocument=samo.claimDocument(false);params.maxWidth=$module_container.find('.claim_info').width();params.maxHeight=$(window).height();if(typeof samo.frplacement_seats[params.freight]!='undefined'){params.seats=samo.frplacement_seats[params.freight];}
params.freightIdForServises=$option.val();$.post(getParams('CHOOSE_FRPLACEMENT'),params,function(){disabled=false;},'script');});if(typeof samo.frplacement_seats[freightKey]!=='undefined'){var seats=Object.keys(samo.frplacement_seats[freightKey]),scount=seats.length,pcount=parseInt($select.parents('tr:first').find('.fr_peoplecount').text());if(!pcount){var add_infant=Number($module_container.find('.addinfant_cb').prop('checked'))||0;var $tour_info=$module_container.find('.tour_info');var peoplecount=parseInt($tour_info.data('peoplecount'));pcount=peoplecount+add_infant;}
var title='';if(typeof samo.frplacement_titles[freightKey]!='undefined'){title=samo.frplacement_titles[freightKey]+", ";}
if(scount>pcount){delete samo.frplacement_seats[freightKey][seats[scount-1]];scount=Object.keys(samo.frplacement_seats[freightKey]).length;}
if(scount==pcount){$btn.addClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHANGE'));}
if(scount<pcount){$btn.removeClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHOOSE'));}
$select.on('change',function(){$btn.removeClass('seats').attr('data-title',samo.i18n('FRPLACEMENT_CHOOSE'));});}else{$btn.parent().find('td.frplacement').removeClass('seats').attr('data-title',samo.i18n('FRPLACEMENT_CHOOSE'));}}else{if($btn.length){$btn.remove();}}};$module_container.find('.NOTECLAIM').on('keyup',function(){if(this.value.length>512){this.value=this.value.substr(0,512);$(this).addClass('error');return false;}
$(this).removeClass('error');}).end().find(samo.controls.bron).on('click',function(){button_disable(1,'calc');button_disable(1,'bron');var $contract=$('#CONRACTAGREE');if($contract.length&&!$contract.is(':checked')){$contract.parents('td:first').addClass('error').get(0).scrollIntoView(true);$contract.on('click',function(){if(this.checked){$contract.parents('td:first').removeClass('error');}});button_disable(0,'calc');return false;}else{$contract.parents('td:first').removeClass('error');}
var $agree_processing_personal_data=$('#AGREE_PROCESSING_PERSONAL_DATA');if($agree_processing_personal_data.length&&!$agree_processing_personal_data.is(':checked')){$agree_processing_personal_data.parents('td:first').parents('td:first').addClass('error').get(0).scrollIntoView(true);$agree_processing_personal_data.on('click',function(){if(this.checked){$agree_processing_personal_data.parents('td:first').parents('td:first').removeClass('error');}});button_disable(0,'calc');return false;}else{$agree_processing_personal_data.parents('td:first').parents('td:first').removeClass('error');}
var is_ok=true;is_ok=checkTouristFields()&&is_ok;if(samo.ROUTES.bron.url.indexOf('bron_person')!=-1){is_ok=checkPersonInfo()&&is_ok;}
if(is_ok){if(checkFreights()&&checkServices()){var params={};var $note=$module_container.find('.NOTECLAIM');params.note=($note.length)?$note.val().substring(0,512):'';params.claimDocument=samo.claimDocument(true);if(params.claimDocument==false){return false;}
var $promocode=$module_container.find('.PROMOCODE');params.promo_codetext=($promocode.length)?$promocode.val().trim():'';var $contacts=$module_container.find('.contacts');params.CONTACTS=($contacts.length)?$contacts.val().trim():'';var $origin=$module_container.find('.ORIGIN');params.ORIGIN=($origin.length)?$origin.val():0;var claim_note='';samo.controls.CLAIM_NOTE.find(':checked').each(function(){var val_addit=(samo.controls.CLAIM_NOTE).find('input[name=addit_'+this.value+']').val()||'';if(val_addit){val_addit='{'+val_addit.replace(/[{|}|\|]/g,' ')+'}';}
claim_note=claim_note+this.value+val_addit+'|';});params.claim_note=claim_note;var $preorder=$module_container.find('#CALCULATED_CLAIM');if($preorder.length&&$preorder.is(':checked')){params.CALCULATED_CLAIM=1;}
$.post(getParams('BRON'),params,null,'script');}}
return true;}).end().find('.freights').on('change','select',function(){var $this=$(this);if($this.val()>0){var $all=$module_container.find('.freights tbody tr').not('.note');var empty_select=$all.find('option:selected[value=0]').length;var $value=$this.find('option:selected');var data=$value.data('json');let timeOut=0;if($all.last().has($this).length){if(empty_select==0){$(document).triggerHandler('ReloadServices',['RELOADSERVICES_INSURES']);timeOut=3000;}
setTimeout(function(){$module_container.find('.freights select').each(function(){samo.init_frplacement_bron(this);})},timeOut);}else if($all.first().has($this).length){if(data.external==0||samo.external_packet==1){var params={};params.TOFREIGHTINC=$this.val();params.FRCLASS=data.onlineclass;params.BACKFREIGHTINC=$all.last().find('select').val();var $frplacement=$all.first().find('option:selected').data('frplacement');params.FRPLACEMENT=0;if(typeof $frplacement!='undefined'){params.FRPLACEMENT=$frplacement;}
$module_container.find('.freights select').each(function(){$(this).prop('disabled',true);});$.post(getParams('TOFREIGHTINC'),params,function(){var $last=$module_container.find('.freights tbody tr').not('.note').last().find('select');if($last.length){$last.change();}else{if(empty_select==0){$(document).triggerHandler('ReloadServices',['RELOADSERVICES_INSURES']);}}
$module_container.find('.freights select').each(function(){$(this).prop('disabled',false);samo.init_frplacement_bron(this);});},'script');}else{if(empty_select==0){$(document).triggerHandler('ReloadServices',['RELOADSERVICES_INSURES']);}}}
var $note=$this.parents('tr').next('.note');if($note.is('.banner-container')){$note=$note.next('.note');}
var note=$value.data('note');var tariff=$value.data('tariff-info');if(note||tariff){var content='';if(note){content+=note;}
if(tariff){content+=tariff;}
$note.removeClass('hidden').find('td').html(content);}else{$note.addClass('hidden');}}
samo.disablePrice();samo.freightInfant();}).on('focus','select',function(e){var seats_exists=false;$(this).parents('.freights:first').find('select option:selected').each(function(){if($(this).data('seats')){seats_exists=true;}});if(seats_exists){$.notify({text:samo.i18n('FRPLACEMENT_FREIGHT_CHANGE_NOTICE'),iconClass:'ui-icon-alert',styleClass:'ui-state-highlight'});}}).find('select').each(function(){$(this).chosen();samo.init_frplacement_bron(this);}).end().end().find('.ASERVICES, .ASERVICES_TRANSPORT_INFO').on('click','.fa-cart-plus',function(e){$(this).parents('tr:first').attr('data-selected',1).find('td').removeClass('line_through');$(this).parents('tr:first').attr('data-selected',1);$(this).removeClass('fa-cart-plus').addClass('fa-circle-xmark');}).end().find('.ASERVICES, .ASERVICES_TRANSPORT_INFO').on('click','.fa-circle-xmark',function(){$(this).parents('tr:first').attr('data-selected',0).find('td').addClass('line_through');$(this).removeClass('fa-circle-xmark').addClass('fa-cart-plus');samo.disablePrice();}).end().find('.INSURESINFO').on('click','.delete_additional_insure',function(){delete_insure($(this).parents('tr:first'),1);}).end().find('.INSURESINFO').on('click','.offered_additional_insure',function(e){var $button=$(this),$tr=$button.parents('tr:first'),data=$tr.data();var insure_clicked=data.inc;var insure_clicked_type=data.insuretype;var insure_clicked_uid=data.uid;$tr.attr('data-selected',1);$button.removeClass('offered_additional_insure').addClass('delete_additional_insure');$button.text(samo.LANG.BTN_DELETE);$module_container.find('.INSURESINFO table.res tbody tr').not('.note').each(function(){var $current=$(this),data=$(this).data();var insure=data.inc;var insure_type=data.insuretype;var insure_required=data.required;if(insure_clicked_type==insure_type&&insure!=insure_clicked&&!insure_required){delete_insure($current,0);}
if(data.json.headUid==insure_clicked_uid){$current.attr('data-selected',1);}});}).end().find('.additional_insures').on('click',function(){var params={};params.claimDocument=samo.claimDocument(false);$.post(getParams('SHOW_ADDITIONAL_INSURES'),params,function(){var $container=$('#additional_insures').on('click','input:checkbox',function(){var $cbx=$(this);var $tr=$cbx.parents('tr:first');var complete=$cbx.data('complete');var insuretype=$tr.data('insuretype');var maininsureuid=$tr.data('maininsureuid');var tbody=$cbx.parents('tbody:first');var ttable=$cbx.parents('table:first');var tr=$cbx.parents('tr:first');if($cbx.is('.maininsure')){if(!$cbx.prop('checked')){$tr.find('input.inscust:checkbox:not(:disabled)').prop('checked',false);if(complete){ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureuid='+maininsureuid+'] input:checkbox:not(:disabled)').prop('checked',false);}}else{if(ttable.find('tr[data-insuretype='+insuretype+'] input.maininsure:checkbox[data-complete=1]:disabled').length||tbody.find('tr[data-insuretype='+insuretype+'] input.maininsure:checkbox:disabled').length){msg(samo.i18n('BRON_CHOOSE_SAME_INSURE')+': '+$cbx.data('insure_type_name'));return false;}
if(complete){ttable.find('tr[data-insuretype='+insuretype+'] input:checkbox:not(:disabled)').prop('checked',false);ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureuid='+maininsureuid+'] input.maininsure:checkbox[data-complete=1]:not(:disabled)').prop('checked',true);$.each(ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureuid='+maininsureuid+'] input.maininsure:checkbox[data-complete=1]:not(:disabled):checked'),function(){$.each($(this).parents('tr:first').find('input.inscust:checkbox[data-complete=1]:not(:disabled):checked'),function(){tr.find('input.inscust:checkbox[data-complete=1][value='+$(this).val()+']:not(:disabled)').prop('checked',true);});});}else{tbody.find('tr[data-insuretype='+insuretype+'] input:checkbox:not(:disabled)').prop('checked',false);$cbx.prop('checked',true);$.each(ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureuid='+maininsureuid+'] input.maininsure:checkbox:not(:disabled):checked'),function(){$.each($(this).parents('tr:first').find('input.inscust:checkbox[data-complete=1]:not(:disabled):checked'),function(){tr.find('input.inscust:checkbox[data-complete=1][value='+$(this).val()+']:not(:disabled)').prop('checked',true);});});}}}else{if(!$cbx.prop('checked')){ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureuid='+maininsureuid+'] input.inscust:checkbox[data-complete=1][value='+$cbx.val()+']:not(:disabled)').prop('checked',false);}else{var $main_cbx=$tr.find('input:first');if(!$main_cbx.prop('checked')){msg(samo.i18n('BRON_CHOOSE_MAIN_INSURE')+': '+$tr.find('label:first').text());return false;}
if(complete){$.each(ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureuid='+maininsureuid+'] input.maininsure:checkbox:not(:disabled):checked'),function(){$(this).parents('tr:first').find('input.inscust:checkbox[data-complete=1][value='+$cbx.val()+']:not(:disabled)').prop('checked',true);});}}}});$('#ADD_ADDITIONAL_INSURES').on('click',function(){var changes=false;$container.find(':checkbox').each(function(){if(this.defaultChecked!=this.checked){changes=true;return false;}});if(changes){var insures=[];$container.find('.maininsure').filter(':checked').each(function(){var $tr=$(this).parents('tr:first'),data=$tr.data();var insure_json=data.json;var maininsureuid=data.maininsureuid;var people=data.people;insure_json.clients=[{'peopleKey':people,'common':people}];if(!insures[maininsureuid]){insures[maininsureuid]={'insure':insure_json,'inscusts':[]};}else{insures[maininsureuid].insure.clients.push({'peopleKey':people,'common':people});}
insures[maininsureuid].insure.count=insures[maininsureuid].insure.clients.length;$tr.find('input.inscust').filter(':checked').each(function(){var inscust=$(this).val();var data=$(this).data();var inscust_json=data.json;inscust_json.clients=[{'peopleKey':people,'common':people}];if(!insures[maininsureuid]['inscusts'][inscust]){insures[maininsureuid]['inscusts'][inscust]={'inscust':inscust_json};}else{insures[maininsureuid]['inscusts'][inscust]['inscust'].clients.push({'peopleKey':people,'common':people});}
insures[maininsureuid]['inscusts'][inscust]['inscust'].count=insures[maininsureuid]['inscusts'][inscust]['inscust'].clients.length;});});$('.INSURESINFO').css('display','none');var tpl=$('#insures-tpl').html();var content=ejs.render(tpl,{insures:insures});$('.INSURESINFO').html(content);samo.disablePrice();$(document).triggerHandler('ReloadServices',['RELOADINSURES']);}
$.modal.close();});button_disable(0,'calc');},'script');}).end().find('#CALCULATED_CLAIM').on('click',function(){if(this.checked){samo.controls.bron.addClass('preorder-btn').text(samo.LANG.BTN_SAVE);}else{samo.controls.bron.removeClass('preorder-btn').text(samo.LANG.BTN_BRON);}}).end().find('select.alternate_hotels').on('change',function(){var $hotel=$(this).find('option:selected');var hotel_json=$hotel.data('json');var $tr=$(this).parents('tr:first');var $link=$tr.find('a.hotel-info');$tr.data('json',hotel_json);$tr.attr('data-json',JSON.stringify(hotel_json));$link.attr('href',hotel_json.www);$(document).triggerHandler('ReloadServices',['RELOADSERVICES']);if(hotel_json.checkintime!==''&&hotel_json.addcheckintime!==''&&hotel_json.checkintime!==hotel_json.addcheckintime){pernight_container=$tr.find('.pernight_container');pernight_container.addClass('visible');pernight_container.find('#pernight_1').click();pernight_container.find('#pernight_1').val(hotel_json.pernight).attr('name','pernight_'+hotel_json.key);pernight_container.find('#pernight_2').val(hotel_json.addpernight).attr('name','pernight_'+hotel_json.key);pernight_container.find("label[for='pernight_1']").text(hotel_json.checkintime);pernight_container.find("label[for='pernight_2']").text(hotel_json.addcheckintime);}else{$tr.find('.pernight_container').removeClass('visible');}}).each(function(){var $hotel=$(this).find('option:selected');var hotel_json=$hotel.data('json');var $tr=$(this).parents('tr:first');var $link=$tr.find('a.hotel-info');$tr.data('json',hotel_json);$tr.attr('data-json',JSON.stringify(hotel_json));if(hotel_json.www){$link.attr('href',hotel_json.www).show();}else{$link.hide();}
$(this).chosen();if(hotel_json.checkintime!==''&&hotel_json.addcheckintime!==''&&hotel_json.checkintime!==hotel_json.addcheckintime){pernight_container=$tr.find('.pernight_container');pernight_container.addClass('visible');pernight_container.find('#pernight_1').click();pernight_container.find('#pernight_1').val(hotel_json.pernight).attr('name','pernight_'+hotel_json.key);pernight_container.find('#pernight_2').val(hotel_json.addpernight).attr('name','pernight_'+hotel_json.key);pernight_container.find("label[for='pernight_1']").text(hotel_json.checkintime);pernight_container.find("label[for='pernight_2']").text(hotel_json.addcheckintime);}else{$tr.find('.pernight_container').removeClass('visible');}});var delete_insure=function($insure,confirmation){var go=true;if(confirmation){go=false;if(confirm(samo.i18n('BTN_CONFIRM_DELETE_INSURE'))){go=true;}}
if(go){var headuid=$insure.data('uid');$module_container.find('.INSURESINFO tbody tr').each(function(){var maininsureuid=$(this).data('maininsureuid');if(maininsureuid==headuid){$(this).remove();}});$insure.remove();init_insures();samo.disablePrice();}};function syncBuyer(peopleInc){var $tourist=$module_container.find(".tourists-tabs .tourist[data-peopleinc="+peopleInc+"]");var syncBuyerFio=function(){let touristName=compoundName($tourist,'NAME');if(touristName){$module_container.find('input[name="frm[phys_byer][-1][NAME]"]').val(touristName);}else{let touristLName=compoundName($tourist,'LNAME');$module_container.find('input[name="frm[phys_byer][-1][NAME]"]').val(touristLName);}};$tourist.find('[name$="_NAME]"]').on('keyup.sync',syncBuyerFio);$tourist.find('[name$="_LNAME]"]').on('keyup.sync',syncBuyerFio);syncBuyerFio();var $tourist_field=null;const common_contacts=$module_container.find('.SAVE_COMMON_CONTACTS').prop('checked');$.each(['PSERIE','PNUMBER','PGIVEN','PGIVENORG','MOBILE','EMAIL','BORN','NATIONALITY','IDENTITY_DOCUMENT'],function(){var field=this;if(field=='NATIONALITY'||field=='IDENTITY_DOCUMENT'){$tourist_field=$module_container.find('select[name="frm[People]['+peopleInc+']['+field+']"]');if($tourist_field.length==1){if(field=='IDENTITY_DOCUMENT'){let selectedOptions=$tourist_field.find('option').clone();let $buyerIDENTITY_DOCUMENT=$module_container.find('select[name="frm[phys_byer][-1]['+field+']"]');$buyerIDENTITY_DOCUMENT.find('option').remove();$buyerIDENTITY_DOCUMENT.append(selectedOptions);}
$tourist_field.on('select.sync',function(){let $selectBuyer=$module_container.find('select[name="frm[phys_byer][-1]['+field+']"]');$selectBuyer.find('option[value='+$(this).val()+']').prop('selected',true);}).triggerHandler('select.sync');$tourist_field.on('change',function(){$(this).triggerHandler('select.sync');});}}else{$tourist_field=$module_container.find('input[name="frm[People]['+peopleInc+']['+field+']"]');if($tourist_field.length==1||(common_contacts&&(field=='PHONE'||field=='EMAIL'||field=='MOBILE'))){if(common_contacts&&(field=='PHONE'||field=='EMAIL'||field=='MOBILE')){$tourist_field=$module_container.find('input[name="frm[People][-1]['+field+']"]');$tourist_field.on('keyup.sync',function(){$module_container.find('input[name="frm[phys_byer][-1]['+field+']"]').val(this.value);}).triggerHandler('keyup.sync');}else{$tourist_field.on('keyup.sync',function(){$module_container.find('input[name="frm[phys_byer][-1]['+field+']"]').val(this.value.toUpperCase());}).triggerHandler('keyup.sync');if(field=='PGIVEN'||field=='BORN'){$tourist_field.on('blur',function(){$(this).triggerHandler('keyup.sync');});}}}}});}
$module_container.find('[name*="[BORN]"]').on('change.datepicker',function(){$module_container.find('.ASERVICES span.bron_service_price').addClass('line_through');});function init_visas($container){$container.find('select.visa').each(function(){if($(this).is(':visible')){$(this).find('option[value="0"]').html('');var options={placeholder_text_single:samo.i18n('EMPTY_VISA')};$(this).chosen(options).trigger("chosen:updated");}});}
$module_container.find('[name*="[PLACEBORN]"]').on('change',function(){samo.ReloadTouristDetail($(this),0);});$module_container.find('[name*="[NATIONALITY]"]').on('change',function(){samo.ReloadTouristDetail($(this),1);});samo.ReloadTouristDetail=function($select,load_identity_document){var $tourist=$select.closest('.tourist, .BUYERINFO');var load_visas=$tourist.find('.visa').length>0;if(load_visas||load_identity_document){var params={};params.TOURIST_ID=$tourist.data('peopleinc');params.PLACEBORN=$tourist.find('[name*="[PLACEBORN]"]').val();params.NATIONALITY=$tourist.find('[name*="[NATIONALITY]"]').val();params.LOAD_IDENTITY_DOCUMENT=load_identity_document;$.post(getParams('RELOADPEOPLEDETAIL'),params,function(){if(load_visas){init_visas($tourist);}
if(load_identity_document){$tourist.find('[name*="[IDENTITY_DOCUMENT]"]').triggerHandler('change');}});}};function reloadGdsFreights(){if(samo.external_freights>0){var event;if(samo.external_freights==4&&$module_container.find('._frmSendFreight').length>0){$('#freightsContainer').empty();event=$.Event('click');event.target=$module_container.find('._frmSendFreight')[0];$(document).trigger(event);}else{if($module_container.find('._frmTownsFreight').length>0){$('#freightsContainer').empty();event=$.Event('click');event.target=$module_container.find('._frmSendFreight')[0];$(document).trigger(event);}else{if($module_container.find('#freightsContainer select.freight').length==0){var filterVal=$("select[name='class']").val();var classVal=(filterVal==1||typeof filterVal=='undefined')?"Econom":(filterVal==2?"Business":"Comfort");$module_container.find('.load-external-freights').css('display','inline').triggerHandler('click',classVal);$module_container.find('.freightTable, .freightsFilter, .currency').html('');}}}}}
function init_tourists(){addinfant_cb_toggle();var $tourists=$module_container.find(".tourists-tabs .tourist").not('.ainfant');samo.tourist_helpers($tourists);init_visas($tourists);$module_container.find('.SAVE_AS_BUYER').on('click',function(){if(this.checked){$module_container.find('.SAVE_AS_BUYER').not(this).prop('checked',false).each(function(){var self=this;var $tourist=$module_container.find('.tourist').filter(function(){return $(this).data('peopleinc')==self.value;});$tourist.find('input').off('keyup.sync');$tourist.find('select').off('select.sync');});var peopleInc=this.value;syncBuyer(peopleInc);let $phys_byer=$module_container.find('.BUYERINFO')
let $people_list=$phys_byer.find('[name*="[PEOPLE_LIST]"]');$people_list.find('option[value='+peopleInc+']').prop('selected',true);}else{$module_container.find('.tourist').find('input').off('keyup.sync');$module_container.find('.tourist').find('select').off('select.sync');}}).end().find('.SAVE_COMMON_CONTACTS').on('click',function(){const self=this;const $tourists=$module_container.find('.tourist').filter(function(){return $(this).data('peopleinc')!=self.value;});const $fieldContainers=$tourists.find('[name*="[PHONE]"],[name*="[EMAIL]"],[name*="[MOBILE]"]').parent().parent();if(this.checked){$fieldContainers.addClass('hidden');}else{$fieldContainers.removeClass('hidden');}}).end().find('.NONEX_PATRONYMIC').on('click',function(){let label=$(this).parents('tr').prev().find('label');let input=$(this).parents('tr').prev().find('input');input.attr('disabled',this.checked);if(this.checked){label.removeClass('required');input.removeClass('required').val('');}else{label.addClass('required');input.addClass('required').focus();}}).end();$module_container.find('.addinfant_cb').on('click',function(){reloadGdsFreights();samo.infant_info();});$module_container.find('.INFANT_FREIGHT_PLACE').on('click',infant_freight_place_click);$module_container.find('select.visa').on('change',function(){var $tourist=$(this).closest('.tourist'),$vexpire=$tourist.find('[name*="[VEXPIRE]"]').closest('tr');if($vexpire){var $el=$vexpire.find('label,input');if($el.is('.required')){$el.addClass('default-required');}
if(parseInt(this.value)==-1&&$el.is('.default-required')){$el.addClass('required');}else{$el.removeClass('required');}}
samo.disablePrice();}).each(function(){$(this).triggerHandler('change');});}
function infant_freight_place_click(){var inf_id=$('#infant_add').find('.ainfant').data('peopleinc');const infant_freight_place=Boolean($('#infant_add').find('.INFANT_FREIGHT_PLACE').prop('checked'));if(infant_freight_place){$module_container.find('td.fr_peoplecount').each(function(){$(this).html(parseInt($(this).data('peoplecount'))+1);samo.disablePrice();});}else{$module_container.find('td.fr_peoplecount').each(function(){$(this).html($(this).data('peoplecount'));samo.disablePrice();});}
$module_container.find('.ASERVICES tbody tr[data-selected="1"]').not('.note, .freightInfo').each(function(){var service=$(this).data('json');var clients=service.clients;if(service.serviceCategoryKey==samo.SERVCATEGORY_FUEL_SURCHARGE){$(clients).each(function(i){if(this.peopleKey==inf_id){if(infant_freight_place){service.count++;service.addinfant=0;$.notify({text:samo.i18n('ADD_INFANT_SERVICE')+' '+service.name,type:'message'});}else{service.count--;service.addinfant=1;$.notify({text:samo.i18n('REMOVE_INFANT_SERVICE')+' '+service.name,type:'message'});}}});}
$(this).data('json',service)
$(this).find('.service_count').html(service.count+(service.addinfant?'+'+samo.i18n('BRON_INFANT'):''));});reloadGdsFreights();$module_container.find('.freights select').each(function(){samo.init_frplacement_bron(this);});}
samo.infant_info=function(){samo.disablePrice();var $cb=$module_container.find('.addinfant_cb');var status=($cb.prop('checked'))?'block':'none';var add_infant=$cb.prop('checked');var inf_id=$('#infant_add').find('.ainfant').data('peopleinc');var mainPeopleInc=$('#infant_add').find('.ainfant').data('mainpeopleinc');var $tour_info=$module_container.find('.tour_info');var peoplecount=parseInt($tour_info.data('peoplecount'));$module_container.find('.addinfant').css('display',status).end().find('.INSURESINFO tbody tr').each(function(){var insure=$(this).data('json');var clients=insure.clients;if(add_infant){if(clients.length==peoplecount){insure.count=insure.count+1;clients.push({'peopleKey':inf_id,'common':inf_id});$.notify({text:samo.i18n('ADD_INFANT_INST'),type:'message'});var id_to=null,id_from=null;if(id_to==null){id_to=$module_container.find('#infant_add input.frm-input:first').attr('name').replace(/frm\[People\]\[([-\d]+)\]\[[\w_]+\]/,'$1');id_from=$module_container.find('.tourist:first input.frm-input:first').attr('name').replace(/frm\[People\]\[([-\d]+)\]\[[\w_]+\]/,'$1');}
$.each(['PSERIE','PNUMBER','PVALID','PGIVEN','PGIVENORG','NATIONALITY','VEXPIRE'],function(i,v){$module_container.find('#infant_add input[name="frm[People]['+id_to+']['+v+']"]').val($module_container.find('.tourist:first input[name="frm[People]['+id_from+']['+v+']"]').val());});}}else{$(clients).each(function(i){if(this.peopleKey==inf_id&&!add_infant){insure.count=insure.count-1;clients.splice(i,1);$.notify({text:samo.i18n('REMOVE_INFANT_INST'),type:'message'});}});}
if(insure.count==0){$(this).remove();}else{insure.clients=clients;$(this).data('json',insure).find('.insure_count').html(insure.count);}});if(!add_infant){const $infantPlace=$('#infant_add').find('.INFANT_FREIGHT_PLACE');if($infantPlace.prop('checked')){$infantPlace.prop('checked',false);infant_freight_place_click();}}
$module_container.find('.ASERVICES tbody tr').not('.note, .freightInfo').each(function(){let service=$(this).data('json');if(typeof service==='undefined'){return;}
let tourists=service.clients;if(add_infant&&service.allowed_infant){let foundInfant=false;$(tourists).each(function(i){if(this.peopleKey==inf_id){foundInfant=true;return false;}});if(!foundInfant){tourists.push({'peopleKey':inf_id,'common':inf_id,'human':'INF'});service.addinfant=1;$.notify({text:samo.i18n('ADD_INFANT_SERVICE')+' '+service.name,type:'message'});}}else{$(tourists).each(function(i){if(this.peopleKey==inf_id){tourists.splice(i,1);service.addinfant=0;$.notify({text:samo.i18n('REMOVE_INFANT_SERVICE')+' '+service.name,type:'message'});return false;}});}
if(tourists.length===0){$(this).remove();}else{let compositionTourists=samo.compositionTourists(tourists);service.clients=tourists;service.count=tourists.length;$(this).data('json',service);$(this).find('.tourists_count').text(service.count);$(this).find('.tourists_composition').attr('title',compositionTourists.toString());}});if(!add_infant){$.event.trigger('FreightDelPlace');}else{let $addinfant=$module_container.find('.addinfant');samo.tourist_helpers($addinfant);init_visas($addinfant);}
samo.freightInfant();};samo.agreement=function(){$('#agreement').on('click',function(){this.disabled=true;$(this).off('click');$.post(getParams('AGREE'),{},null,'script');});};samo.buyer_fields_events=function(){let $phys_byer=$module_container.find('.BUYERINFO')
$phys_byer.find('[name*="[BUYER_TYPE]"]').off('change').on('change',function(){samo.buyer_fields();});$phys_byer.find('[name*="[NATIONALITY]"]').off('change').on('change',function(){samo.ReloadTouristDetail($phys_byer,1);});let $people_list=$phys_byer.find('[name*="[PEOPLE_LIST]"]');if($people_list.length){let $tourists=$module_container.find(".tourists-tabs .tourist").not('.CHD').not('.INF');;$tourists.each(function(){let $tourist=$(this);let inc=$tourist.data('peopleinc');let name=samo.i18n('TOURIST')+' â„–'+Math.abs(inc);$people_list.append($('<option>',{value:inc,text:name}));});$people_list.on('change',function(){let peopleInc=$(this).val();$module_container.find('.SAVE_AS_BUYER').prop('checked',false);$module_container.find('.tourist').find('input').off('keyup.sync');$module_container.find('.tourist').find('select').off('select.sync');$module_container.find('.SAVE_AS_BUYER[value='+peopleInc+']').prop('checked',true);if(peopleInc!=samo.MINLONGINT){syncBuyer(peopleInc);}});}
$phys_byer.find('.date').datePicker();$phys_byer.find('select').chosen();$phys_byer.find('[name*="[IDENTITY_DOCUMENT]"]').triggerHandler('change');$phys_byer.find('[name*="[SEND_GIS]"]').off('click').on('click',function(){let disabled=true;if(this.checked){disabled=false;}
let _buyer=$phys_byer.find('input[name*="[phys_byer]"], select[name*="[phys_byer]"]').not('[type=hidden]').not('input[name*="[SEND_GIS]"]');if(_buyer.length){_buyer.each(function(){$(this).prop('disabled',disabled);let $tr=$(this).parents('tr:first');if(disabled){$tr.addClass('hidden');}else{$tr.removeClass('hidden');}});$phys_byer.find('.date').datePicker();}});}
samo.buyer_fields=function(){let $phys_byer=$module_container.find('.BUYERINFO');let params={};params.BUYER_TYPE=$phys_byer.find('[name*="[BUYER_TYPE]"]').val();$.post(getParams('RELOAD_BUYER_FIELDS'),params,function(){samo.buyer_fields_events();},'script');}
samo.buyer_fields_events();samo.GDSByRouteInit=function(){var $places=$module_container.find('.seats-counter-container select.places');var clients=[];var placeCount=0;if($places.length){$places.each(function(){var $place=$(this),data=$place.data(),common=$place.val();clients.push({'peopleKey':data.key,'common':(common==0)?data.key:common});if(common==0){placeCount++;}});}
$('#freightsContainer select').each(function(){if(clients.length>0){$(this).find('option').each(function(){var $freight=$(this),data=$freight.data('json');data.clients=clients;data.count=1;data.fixedClients=1;$freight.data('json',data);});}
samo.init_frplacement_bron(this);}).chosen();};samo.checkGDSActionResponse=function(frClass,guid,progress,target){var params={};if(!guid){var $places=$module_container.find('.seats-counter select.places');if($places.length>0){var places=[];var checkCommonPlaces=true;var commonPlaces=[];$places.each(function(){var place={},$select=$(this),data=$select.data();delete data.chosen;delete data.jqv;place=data;if(this.value==0){place.with_place=1;}else{place.with_place=0;place.place_key=this.value;}
place.with_place=this.value==0?1:0;if(!place.with_place){if(!commonPlaces.includes(place.place_key)){commonPlaces.push(place.place_key);}else{checkCommonPlaces=false;$select.errorField(samo.i18n('FRPLACEMENT_CHANGE'))}}
places.push(place);});if(!checkCommonPlaces){return false;}
params.places=places;}}
if(typeof frClass=='undefined'){var filterVal=$("select[name='class']").val();frClass=(filterVal==1||typeof filterVal=='undefined')?"Econom":(filterVal=='2'?"Business":"Comfort");}
button_disable(1,'bron');$('._frmSendFreight').prop('disabled',true);$('._frmTownsFreight').prop('disabled',true);$module_container.find('.freight_setup_dates input').prop('disabled',true);$module_container.find('.load-external-freights').prop('disabled',true);if(!progress){progress=2.5;}
$('.freightsTableBlock .external_freight_note').html('');$('#freightsContainer').show();$module_container.find('.result-progress').show();$module_container.find('.freightsRes .messages').html(samo.i18n('FLIGHTS_LOAD'));$module_container.find('.result-progress .blue').css('width',progress+'%');var delay=1;var $container=$module_container.find('.FREIGHTSINFO');var $selects=$container.find('select');$selects.prop('disabled',true).addClass('samo-preloader');var $_get={};$('._frmTownsFreight').each(function(index,el){var $el=$(el),name=$el.attr('name'),val;val=name=='directonly'&&$el.prop('checked')?1:$el.val();params[name]=val;});$_get.CATCLAIM=$.getParameter('CATCLAIM',true);params.CURRENCY=$.getParameter('CURRENCY',true);if($module_container.find('.FREIGHT_DIRECT').length==1){params.FREIGHT_DIRECT=samo.dateAsString(samo.dateFromString($module_container.find('.FREIGHT_DIRECT').val()),'yyyymmdd');}
if($module_container.find('.FREIGHT_BACK').length==1){params.FREIGHT_BACK=samo.dateAsString(samo.dateFromString($module_container.find('.FREIGHT_BACK').val()),'yyyymmdd');}
$_get.claim_guid=samo.claim_guid;$_get.samo_action='CHECK_GDS_ACTION_RESPONSE';params.fClass=(frClass&&frClass=='Business')?'Business':((frClass&&frClass=='Comfort')?'Comfort':'Econom');if(target){params.target=target;}
params.inf=$module_container.find(".addinfant_cb").prop('checked')?1:0;params.ins=$module_container.find(".INFANT_FREIGHT_PLACE").prop('checked')?1:0;$_get.extfr=1;$_get.doSearch=1;$_get.guid=guid;params.progress=progress;if(guid){$_get.doSearch=0;delay=3000;samo.jQuery('#search_id_btn').remove();samo.jQuery('#freightsContainer').append('<a class="external" id="search_id_btn" title="'+samo.i18n('SEARCH_ID')+'">'+samo.i18n('SEARCH_ID')+'</a>').find('.external').on('click',function(){return samo.popupText(this,guid,true);});}
setTimeout(function(){$.post(samo.ROUTES.bron.url+$.param($_get),params,false,'script');},delay);};samo.errorGDSActionResponse=function(){var msg=arguments.length==1?arguments[0]:samo.i18n('FLIGHTS_LOAD_ERROR');$('._frmSendFreight').prop('disabled',false);$('._frmTownsFreight').prop('disabled',false);$module_container.find('.freight_setup_dates input').prop('disabled',false);$module_container.find('.load-external-freights').prop('disabled',false);$module_container.find('.result-progress .blue').css('width','100%');$module_container.find('.freightsRes .messages').html(msg);$module_container.find('.result-progress').hide();$module_container.find('.result-progress .blue').css('width','2.5%');$module_container.find('.FREIGHTSINFO .samo-preloader').removeClass('samo-preloader');$.notify({type:'error',text:msg,permanent:0});};samo.getGDSDataResponse=function(fClass,guid,target){$module_container.find('.result-progress .blue').css('width','100%');$module_container.find('.freightsRes .messages').html('');$module_container.find('.addinfant_cb').prop('disabled',false);$module_container.find('.INFANT_FREIGHT_PLACE').prop('disabled',false);var $self=$(this),$container=$module_container.find('.FREIGHTSINFO');$self.prop('disabled',true).addClass('samo-preloader');var $selects=$container.find('select');$selects.prop('disabled',true).addClass('samo-preloader');var params={};params.CATCLAIM=$.getParameter('CATCLAIM',true);params.CURRENCY=$.getParameter('CURRENCY',true);params.claim_guid=samo.claim_guid;params.samo_action='EXTERNAL_FREIGHTS';params.fClass=fClass;params.inf=$(".addinfant_cb").prop('checked')?1:0;params.ins=$(".INFANT_FREIGHT_PLACE").prop('checked')?1:0;params.extfr=1;params.guid=guid;params.target=target;$.post(samo.ROUTES.bron.url+$.param(params),{},function(){$self.prop('disabled',false).removeClass('samo-preloader');$container.find('.samo-preloader').prop('disabled',false).removeClass('samo-preloader');$container.find('select.freight:eq(0)').change();var filterByClass=$('select[name=class]');var filterByFlyDuration=$('#flyDurationSlider');if(filterByClass.length){var sValue=(params.fClass=='Econom')?1:(params.fClass=='Business'?2:3);filterByClass.find('option[value='+sValue+']').prop('selected',true);$module_container.find('.load-external-freights').hide();}
if(filterByFlyDuration.length){samo.filterSliders(filterByFlyDuration);}
$('#freightsContainer').off('click').on('click','.freightsFilter .hideLink a',function(){$($(this).parent().attr('data-hide-target')).toggle();return false;}).off('change').on('change','.freightsFilter select',function(){var selectName=$(this).attr('name');if(selectName=='flight_types'||selectName=='full_airline'){samo.refreshFreightTable();}else if(selectName=='class'||selectName=='target'){const classVal=$('.freightsFilter select[name="class"]').val();const classReq=(typeof classVal=='undefined'||classVal=='1')?"Econom":(classVal=='2'?"Business":"Comfort");const targetReq=$('.freightsFilter  select[name="target"]').val();$('.freightTable, .freightsFilter, .currency').html('');samo.checkGDSActionResponse(classReq,undefined,undefined,targetReq);}});$module_container.find('.result-progress').hide();$module_container.find('.result-progress .blue').css('width','2.5%');$module_container.find('.load-external-freights').prop('disabled',false);$('._frmSendFreight').prop('disabled',false);$('._frmTownsFreight').prop('disabled',false);$module_container.find('.freight_setup_dates input').prop('disabled',false);$('#btnDeleteFreightExternal').show();function freight_info(select){var $this=$(select);var $note=$this.parents('tr').next('.note:first');var $value=$this.find('option:selected');var note=$value.data('note');var tariff=$value.data('tariff-info');if(note||tariff){var content='';if(note){content+=note;}
if(tariff){content+=tariff;}
$note.removeClass('hidden').find('td').html(content);}else{$note.addClass('hidden');}}
$module_container.find('.freights select.freight').on('change',function(){freight_info($(this));$(document).triggerHandler('ReloadServices',['RELOADSERVICES_INSURES']);});$module_container.find('.freights select.freight').each(function(){freight_info(this);});if($module_container.find('.freights select.freight').length){$(document).triggerHandler('ReloadServices',['RELOADSERVICES_INSURES']);}},'script',function(){$.notify({type:'error',text:samo.i18n('FREIGHT_LOAD_FAILED'),permanent:0});$self.prop('disabled',false).removeClass('samo-preloader').css('display','block');$('._frmSendFreight').prop('disabled',false);$('._frmTownsFreight').prop('disabled',false);});};samo.freight_note=function(freight,note){var $value=$module_container.find('.freights select option[value="'+freight+'"]');var $note=$value.parents('tr').next('.note:first');if(note){var freight_note=$value.data('note');var freight_tariff=$value.data('tariff-info');var content='';if(freight_note){content+=freight_note;}
if(freight_tariff){content+=freight_tariff;}
content+='<hr>'+note;$note.removeClass('hidden').find('td').html(content);}};samo.bron_form=function(){var $loadExternalFreights=$module_container.find('.load-external-freights').on('click',function(e,flag){$module_container.find('.addinfant_cb').prop('disabled',true);$module_container.find('.INFANT_FREIGHT_PLACE').prop('disabled',true);if(typeof samo.external_freights!='undefined'&&samo.external_freights==1){$(this).hide();$(samo.controls.FREIGHTSINFO).empty();$.getScript(getParams('EXTERNAL_FREIGHTS_FILTERS'),function(){samo.checkGDSActionResponse(flag);});}else{samo.checkGDSActionResponse(flag);}});if(typeof samo.external_freights!='undefined'&&samo.external_freights==2){$loadExternalFreights.css('display','none').triggerHandler('click','autoload');}
$module_container.css('display','block');button_disable(1,'bron');samo.controls.BACKFREIGHTS=$module_container.find('td.BACKFREIGHTS');samo.controls.freights=$module_container.find('div.freights');$module_container.find('.checklistbox').on('click',function(e){if($(e.target).is('a.help')){e.preventDefault();window.open(e.target.href,'_blank');}}).find('a.help').attr('title',samo.i18n('DETAIL')).end().end().find('div.freights').each(function(){var name=this.name||$(this).attr('name')||this.className;samo.controls[name]=this;}).end();var maxWidth=0;samo.controls.CLAIM_NOTE.find('input').on('click',function(){samo.controls.CLAIM_NOTE.find('input[name=addit_'+this.value+']').prop('disabled',!this.checked);}).end().find('label.has_input').each(function(){maxWidth=Math.max($(this).width(),maxWidth);}).each(function(){$(this).width(maxWidth+3);});samo.disablePrice=function(){$(samo.controls.CLAIMPRICE).addClass('not-actual');$module_container.find('.CLAIMPRICE_NOTICE').css('display','block');button_disable(1);};$(samo.controls.calc).on('click',function(){if(checkFreights()&&checkHotels()&&checkServices()){var params={};params.claimDocument=samo.claimDocument(false);if(params.claimDocument==false){return false;}
var $promocode=$module_container.find('.PROMOCODE');params.promo_codetext=($promocode.length)?$promocode.val().trim():'';button_disable(1,'calc');button_disable(1,'bron');$.post(getParams('CALC'),params,null,'script');}});$(document).on('ajaxError',function(){button_disable(0,'calc');});$(document).on('ReloadServices',function(e,action){var params={};button_disable(1,'calc');button_disable(1,'bron');params.claimDocument=samo.claimDocument(false);if(action=='RELOADSERVICES'){params.freightIdForServises=-1}
var url=getParams(action,{});params.freight=$('#frplacement_peoples').data('freight');$.post(url,params,function(){$module_container.find('.services_container').css('display','block');init_services();button_disable(0,'calc');},'script');});init_tourists();samo.tourist_helpers($module_container.find('.BUYERINFO'));$module_container.find('.ORIGIN').find('option[value="0"]').html('').end().chosen({placeholder_text_single:samo.i18n('REQUIRED_FIELD_EMPTY')});};function addinfant_cb_toggle(){if(typeof(samo.freeinfant)!='undefined'&&samo.freeinfant>0){$module_container.find('div .add_inf').css('display','block');if(typeof(samo.freeinfant_checked)!='undefined'&&samo.freeinfant_checked>0){samo.infant_info();}}else{$module_container.find('div .add_inf').css('display','none');}}
var compoundName=function($tourist,suffix){var parts=[],selector,$field;var fields=['LASTNAME','FIRSTNAME'];var nonex_patronymic=$tourist.find('[name*="[PATRONYMIC_'+suffix+'_NONEX_PATRONYMIC]"]').prop('checked')?true:false;if(!nonex_patronymic){fields.push('PATRONYMIC');}
$.each(fields,function(i,prefix){selector='[name*="['+prefix+'_'+suffix+']"]';$field=$tourist.find(selector);if($field.length){parts.push($field.val());}});var name=parts.join(samo.FIO_DELIMETER);return name.toUpperCase().substr(0,64);};samo.claimDocument=function(is_bron){var claimDocument={};var $tourists=$module_container.find(".tourists-tabs .tourist");var add_infant=Number($module_container.find('.addinfant_cb').prop('checked'))||0;var $tour_info=$module_container.find('.tour_info');var checkin=$tour_info.data('checkin');var checkout=$tour_info.data('checkout');var peoplecount=parseInt($tour_info.data('peoplecount'));var peoples=peoplecount+add_infant;var _peoples=-1*peoples;var inf_id=$('#infant_add').find('.ainfant').data('peopleinc');var add_inf_inc=$module_container.find('.addinfant_cb').val();var freight_counter=-1;var service_counter=-1;const common_contacts=$module_container.find('.SAVE_COMMON_CONTACTS').prop('checked');claimDocument['peoples']=[];if(!add_infant){$tourists=$tourists.not('.ainfant');}
var clients,x,is_ok=true;if(is_ok&&add_infant){var $tourist=$tourists.first();var human=$tourist.find('[name*="[HUMAN]"]').val();if(typeof human!='undefined'&&human!='MR'&&human!='MRS'){msg(samo.i18n('FIRST_HUMAN_TOURIST'));is_ok=false;}}
$tourists.each(function(i){if(is_ok){var ppl={},date,$field,name,lname,$tourist=$(this);ppl['key']=$tourist.data('peopleinc');ppl['sex']=$tourist.find('[name*="[MALE]"]').filter(':checked').val();ppl['human']=$tourist.find('[name*="[HUMAN]"]').val();if($tourist.is('.ainfant')){if(ppl['human']){ppl['human']='INF';}
ppl['additional']=1;}
if($tourist.find('[name*="[LASTNAME_NAME]"]').length){name=compoundName($tourist,'NAME');if($tourist.find('[name*="[LASTNAME_LNAME]"]').length){lname=compoundName($tourist,'LNAME');}else{lname=name;}}else{lname=compoundName($tourist,'LNAME');name=lname;}
ppl['name']=name;ppl['name_nonex_patronymic']=$tourist.find('[name*="[PATRONYMIC_NAME_NONEX_PATRONYMIC]"]').prop('checked')?1:0;ppl['lname']=lname;ppl['lname_nonex_patronymic']=$tourist.find('[name*="[PATRONYMIC_LNAME_NONEX_PATRONYMIC]"]').prop('checked')?1:0;date=valid_date($tourist.find('[name*="[BORN]"]'),is_bron);is_ok=(date!==false);if(is_ok){ppl['born']=date;ppl['identity_document']=$tourist.find('[name*="[IDENTITY_DOCUMENT]"]').val()||samo.IDENTITY_NODOCUMENT;ppl['pserie']=($tourist.find('[name*="[PSERIE]"]').val()||"").toUpperCase();ppl['pnumber']=($tourist.find('[name*="[PNUMBER]"]').val()||"").toUpperCase();date=valid_date($tourist.find('[name*="[PVALID]"]'),is_bron);is_ok=(false!==date);if(is_ok){ppl['pexpire']=date;date=valid_date($tourist.find('[name*="[PGIVEN]"]'),is_bron);is_ok=(date!==false);if(is_ok){ppl['pgiven']=date;$field=$tourist.find('[name*="[PGIVENORG]"]');ppl['pgivenorg']=$field.length?$field.val():'';ppl['nationalityKey']=$tourist.find('[name*="[NATIONALITY]"]').val()||samo.MINLONGINT;ppl['bornplaceKey']=$tourist.find('[name*="[PLACEBORN]"]').val()||samo.MINLONGINT;$field=$tourist.find('[name*="[ADDRESS]"]');ppl['address']=$field.length?$field.val():'';$field=$tourist.find('[name*="[PHONE]"]');ppl['phone']=common_contacts&&i!=0?claimDocument['peoples'][0]['phone']:($field.length?$field.val():'');$field=$tourist.find('[name*="[MOBILE]"]');ppl['mobile']=common_contacts&&i!=0?claimDocument['peoples'][0]['mobile']:($field.length?$field.val():'');$field=$tourist.find('[name*="[EMAIL]"]');ppl['email']=common_contacts&&i!=0?claimDocument['peoples'][0]['email']:($field.length?$field.val():'');ppl['vexpire']=valid_date($tourist.find('[name*="[VEXPIRE]"]'),is_bron);$field=$tourist.find('[name*="[PLACEBORNDETAIL]"]');ppl['bornplaceDetail']=$field.length?$field.val():'';$field=$tourist.find('[name*="[INN]"]');ppl['inn']=$field.length?$field.val():'';}}}
$.each(ppl,function(key,val){ppl[key]=typeof val==='string'?val.trim():val;});claimDocument['peoples'][i]=ppl;}});if(!is_ok){return false;}
claimDocument['transports']=[];freightSelect='.FREIGHTSINFO tbody .freight';if(samo.external_freights!='undefined'&&(samo.external_freights==1||samo.external_freights==2)){if(samo.external_freights!=1||$module_container.find(freightSelect).length==0){freightSelect='.freightTable input[data-checked=checked]';}}
$module_container.find(freightSelect).each(function(){var $self=$(this);if($self.val()>0){freight_counter++;var freight=null;var routeindex=$self.data('routeindex');if(this.tagName=='SELECT'){freight=$self.find('option:selected');}else{freight=$self;}
var _freight_json=freight.data('json'),_freight_seats=freight.data('seats');if(typeof _freight_seats=='undefined'){_freight_seats=samo.frplacement_seats[_freight_json.key];}
var freight_json=$.extend({},_freight_json),freight_seats=$.extend({},_freight_seats);var clients=[];if(typeof freight_json.clients!='undefined'){clients=[];$(freight_json.clients).each(function(){var client={peopleKey:this.peopleKey,common:this.common,};if(freight_seats&&typeof freight_seats[client.common]!='undefined'){client.seatKey=freight_seats[client.common]['inc'];client.seatName=freight_seats[client.common]['name'];if(typeof freight_seats[client.common]['full_coupe']!=='undefined'){client.full_coupe=freight_seats[client.common]['full_coupe'];}}
clients.push(client);});freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}else{if(add_infant&&!$module_container.find('.INFANT_FREIGHT_PLACE').is(':checked')){var freight_json2=$.extend({},freight_json);if(freight_seats&&freight_seats[-1]){clients.push({'peopleKey':-1,'common':-1,'seatKey':freight_seats[-1]['inc'],'seatName':freight_seats[-1]['name']});clients.push({'peopleKey':inf_id,'common':-1});}else{clients.push({'peopleKey':-1,'common':-1});clients.push({'peopleKey':inf_id,'common':-1});}
freight_json2.classKey=freight_json.adultinfclass;freight_json2.frplaceKey=freight_json.adultinffrplace;if(routeindex!='undefined'){freight_json2.routeIndex=routeindex;}
freight_json2.count=1;freight_json2.addinfant=1;freight_json2.clients=clients;claimDocument['transports'][freight_counter]=freight_json2;if(peoplecount>1){clients=[];for(x=-2;x>_peoples;x--){if(freight_seats&&freight_seats[x]){clients.push({'peopleKey':x,'common':x,'seatKey':freight_seats[x]['inc'],'seatName':freight_seats[x]['name']});}else{clients.push({'peopleKey':x,'common':x});}}
freight_counter++;if(routeindex!='undefined'){freight_json.routeIndex=routeindex;}
freight_json.count=clients.length;freight_json.addinfant=0;freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}}else{for(x=-1;x>=_peoples;x--){if(freight_seats&&freight_seats[x]){clients.push({'peopleKey':x,'common':x,'seatKey':freight_seats[x]['inc'],'seatName':freight_seats[x]['name']});}else{clients.push({'peopleKey':x,'common':x});}}
if(routeindex!='undefined'){freight_json.routeIndex=routeindex;}
freight_json.count=peoples;freight_json.addinfant=0;freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}}}});claimDocument['hotels']=[];$module_container.find('.HOTELSINFO tbody tr').filter(function(){let selector_clone=$(this).clone();var hotel_json=selector_clone.data('json');return typeof hotel_json!=='undefined';}).each(function(i){let selector_clone=$(this).clone();var hotel_json=selector_clone.data('json');var j=-1*(i+1);var clients=[];for(var x=-1;x>=_peoples;x--){clients.push({'peopleKey':x,'common':j});}
if(hotel_json.checkintime!==''&&hotel_json.addcheckintime!==''&&hotel_json.checkintime!==hotel_json.addcheckintime){let pernight=$(this).parent().find('[name=pernight_'+hotel_json.key+']:checked')
hotel_json.pernight=pernight.val();hotel_json.checkintime=$(this).parent().find('#label_'+pernight.attr('id')).data('checkintime');hotel_json.checkouttime=$(this).parent().find('#label_'+pernight.attr('id')).data('checkouttime');}else{hotel_json.pernight=undefined;hotel_json.checkintime=undefined;hotel_json.checkouttime=undefined;}
hotel_json.addcheckintime=undefined;hotel_json.addcheckouttime=undefined;hotel_json.addpernight=undefined;hotel_json.addinfant=add_infant;hotel_json.clients=clients;claimDocument['hotels'][i]=hotel_json;});claimDocument['services']=[];$module_container.find('.ASERVICES table tbody tr[data-selected="1"], .ASERVICES_TRANSPORT_INFO table tbody tr[data-selected="1"]').not('.note, .freightInfo').each(function(){service_counter++;var service_json=$(this).data('json');var service=$.extend({},service_json);if($(this).find('.service_dates').length){var $option=$(this).find('.service_dates').find('option:selected');service.uid=$option.val();service.datebeg=$option.data('datebeg');service.dateend=$option.data('dateend');}
if($(this).data('needfreightinfo')){var mainserviceuid=$(this).data('uid');var $freightinfotr=$module_container.find('.ASERVICES table.res tbody tr.freightInfo[data-mainserviceuid="'+mainserviceuid+'"]');service.freightinfo_port=$freightinfotr.find('.FREIGHTINFO_PORT').val();var $option=$freightinfotr.find('.FREIGHTINFO_PORT').find('option:selected');service.freightinfo_town=$option.data('town');service.freightinfo_terminal=$option.data('terminal');service.freightinfo_freight=$freightinfotr.find('.FREIGHTINFO_FREIGHT').val();service.freightinfo_freight_back=$freightinfotr.find('.FREIGHTINFO_FREIGHT_BACK').val();service.freightinfo_date=$freightinfotr.find('.FREIGHTINFO_DATE').val();service.freightinfo_date_back=$freightinfotr.find('.FREIGHTINFO_DATE_BACK').val();service.freightinfo_time=$freightinfotr.find('.FREIGHTINFO_TIME').val();service.freightinfo_time_back=$freightinfotr.find('.FREIGHTINFO_TIME_BACK').val();}
claimDocument['services'][service_counter]=service;});$module_container.find('.INSURESINFO table.res tbody tr[data-selected="1"]').not('.note').each(function(){service_counter++;var insure=$(this).data('json');insure.addinfant=add_infant;claimDocument['services'][service_counter]=insure;});var vises={};$tourists.each(function(i){var $tourist=$(this);var peopleinc=$tourist.data('peopleinc');$tourist.find('select.visa').each(function(){if($(this).find('option').length){var $select=$(this).find('option:selected');var info=$select.data('json'),inc=parseInt(info.key,10);if(inc!=0){var clients=[];if(!vises[inc]){clients.push({'peopleKey':peopleinc,'common':i});info['datebeg']=checkin;info['dateend']=checkout;info['count']=1;info['addinfant']=add_infant;info['clients']=clients;vises[inc]=info;}else{var tmp=vises[inc].clients;tmp.push({'peopleKey':peopleinc,'common':i});vises[inc].count++;}}}});});for(var inc in vises){service_counter++;claimDocument['services'][service_counter]=vises[inc];}
let $buyer=$module_container.find('.BUYERINFO');if($buyer.length){let buyerFields=$buyer.find('input[name*="[phys_byer]"], select[name*="[phys_byer]"]').not('[type=hidden]').not(':disabled');var _buyer=claimDocument['buyer']={};buyerFields.each(function(){var name=this.name.match(/\[([^\]\[]*)\]$/)[1];var val=$.controlValue(this);_buyer[name]=typeof val==="string"?val.trim():val;});}
return claimDocument;};samo.update_backfreights=function(){samo.controls.BACKFREIGHTS=$module_container.find('td.BACKFREIGHTS');};samo.post_calc=function(price){$module_container.find('.toggle_details').on('click',function(){var $self=$(this);if($self.data('show')==$self.text()){$($module_container.find('td.commission_block div.COMMISSIONS')).slideDown(function(){$self.text($self.data('hide'));});}else{$($module_container.find('td.commission_block div.COMMISSIONS')).slideUp(function(){$self.text($self.data('show'));});}});$module_container.find('.CLAIMPRICE_NOTICE').css('display','none');$module_container.find('.services_container').css('display','block');init_services();if(price.stop_bron){button_disable(1,'bron');}else{button_disable(0,'bron');}
button_disable(0,'calc');};samo.calc_save_error=function(message){button_disable(1,'bron');button_disable(0,'calc');msg(message);};samo.calc_service_error=function(message,uid){button_disable(1,'bron');button_disable(0,'calc');var found=false;$module_container.find('.ASERVICES table.res tbody tr').not('.note, .freightInfo').each(function(){var service_json=$(this).data('json');$(this).removeClass('unavailable_order');if(service_json.uid==uid){found=true;$(this).addClass('unavailable_order').find('td:last').html('<button class="delete_additional_service">'+samo.i18n('BTN_DELETE')+'</button>');$(this).errorField(message);$module_container.find('.services_container').get(0).scrollIntoView(true);}});if(!found){msg(samo.i18n('BRON_SERVICE_ERROR'));}};var error_tourist=samo.error_tourist=function(message,field){samo.field.error(message,field);button_disable(0,'calc');return false;};function checkTouristFields(){var checkout=$module_container.find('.tour_info').data('checkout');var $tourists=$module_container.find('.tourists-tabs .tourist');if(!$module_container.find('input.addinfant_cb').prop('checked')){$tourists=$tourists.not('.ainfant');}
$module_container.find('.tourists-tabs .error').each(function(){samo.field.clear_error(this);});var is_ok=true;$tourists.each(function(){$(this).find('[name*="[PSERIE]"],[name*="[PNUMBER]"]').not(':disabled').each(function(){$(this).val($(this).val().trim());if(!$.RegexpValue(this)){is_ok=false;return false;}});if(is_ok){$(this).find('.required').not('label').each(function(){const $self=$(this);if(!$self.parent().parent().is('.hidden')){if(!$self.val().length){is_ok=error_tourist(samo.i18n('REQUIRED_FIELD_EMPTY'),this);}}});}});if(!is_ok){button_disable(0,'calc');}
return is_ok;}
var error_buyer=error_tourist;function checkPersonInfo(){var is_ok=true;$module_container.find('.CLAIMINFO input[name*="[phys_byer]"]').each(function(){samo.field.clear_error(this);if($(this).is('.required')&&!this.value.trim().length){is_ok=error_buyer(samo.i18n('REQUIRED_FIELD_EMPTY'),this);}});if(!is_ok){button_disable(0,'calc');}
return is_ok;}
function getParams(action){var result={};$.each(['CATCLAIM','TICKET','INSURE','SERVICE','CURRENCY'],function(){var param=$.getParameter(this,true);if(param){result[this]=param;}});result.claim_guid=samo.claim_guid;result.samo_action=action;if(arguments[1]){$.extend(result,arguments[1]);}
return _ROOT_URL+$.param(result);}
function checkFreights(){if($module_container.find('.claim_info').is('.ticket')){return true;}
if($module_container.find('.claim_info').is('.insure')){return true;}
if($module_container.find('.claim_info').is('.service')){return true;}
var is_ok=true;if(samo.ground_handling!='undefined'&&samo.ground_handling==true){if(samo.external_freights!='undefined'&&samo.external_freights==2){if($module_container.find('input[name=freight4table]').length&&!$module_container.find('input[name=freight4table]:checked').length){button_disable(1,'bron');button_disable(0,'calc');msg(samo.i18n('NO_FLIGHT_SELECTED'));return false;}}
if(samo.external_freights!='undefined'&&samo.external_freights==4){if($module_container.find('#freightsContainer select.freight').length!=$module_container.find('#freightsContainer .frplacement .button.seats').length){$module_container.find('#freightsContainer .frplacement .button').not('.seats').triggerHandler('click');return false;}}}else{if(samo.external_freights!='undefined'&&samo.external_freights==2){if(!$module_container.find('input[name=freight4table]:checked').length||$module_container.find('input[name=freight4table]:checked').val()==""){button_disable(1,'bron');button_disable(0,'calc');msg(samo.i18n('NO_FLIGHT_SELECTED'));return false;}}else{if($module_container.find('.freights table tbody tr:not(.note)').length!==$module_container.find('.freights table tbody select').length||$module_container.find('.freights table tbody select option:selected[value=0]').length>0){button_disable(1,'bron');button_disable(0,'calc');msg(samo.i18n('NO_FREIGHTS'));return false;}
$module_container.find('.freights table tbody select').each(function(){var current_freightData=$(this).find('option:selected').data();var arrival=current_freightData.json.datetrgtime;var arrival_onlineclass=current_freightData.json.onlineclass;var nextrouteindex=parseInt($(this).data('routeindex'))+1;var next_freightSelect=$module_container.find('.FREIGHTSINFO tbody select.freight[data-routeindex='+nextrouteindex+']:first');var next_freightData=next_freightSelect.find('option:selected').data();if(next_freightData){var next_onlineclass=next_freightData.json.onlineclass;if(samo.FreightCrossClasses=='0'&&arrival_onlineclass!=next_onlineclass){samo.field.error(samo.i18n('FREIGHTCROSSCLASSES_DISABLE'),next_freightSelect);is_ok=false;return false;}
if(arrival){var departure=next_freightData.json.datesrctime;if(departure){arrival=new Date(arrival);arrival.setMilliseconds(samo.BetweenFreightMinTime*60*1000);departure=new Date(departure);if(arrival>departure){is_ok=false;samo.field.error(samo.i18n('BETWEEN_FREIGHT_MINTIME'),next_freightSelect);return false;}}}}});}
if(samo.ForceBoarding){let $freightsWithFrplacement;if(samo.external_freights!='undefined'&&(samo.external_freights==1||samo.external_freights==2)){$freightsWithFrplacement=$module_container.find('.freightTable tr.checked[data-frplacement="1"]');}else{$freightsWithFrplacement=$module_container.find('.FREIGHTSINFO .frplacement .button').closest('tr');}
if($freightsWithFrplacement.length>0){const $seats=$freightsWithFrplacement.find('.button.seats');if($seats.length!=$freightsWithFrplacement.length){if(samo.ForceBoardingAllow==null){samo.ForceBoardingAllow=confirm(samo.ForceBoarding);}}else{samo.ForceBoardingAllow=null;is_ok=true;}
let notSeatsFirst=$('.frplacement').not('.seats').find('.button').first();if(samo.ForceBoardingAllow&&notSeatsFirst.length>0){is_ok=false;notSeatsFirst.trigger('click');}}}}
return is_ok;}
function checkHotels(){var $result=true,$hotel=$module_container.find('.main_hotel'),$room=$module_container.find('.main_room'),$htplace=$module_container.find('.main_htplace'),$meal=$module_container.find('.main_meal');if($hotel.length&&$hotel.val()==null){msg(samo.i18n('NO_HOTEL'));$result=false;}
if($result&&$room.length&&$room.val()==null){msg(samo.i18n('NO_ROOM'));$result=false;}
if($result&&$htplace.length&&$htplace.val()==null){msg(samo.i18n('NO_HTPLACE'));$result=false;}
if($result&&$meal.length&&$meal==null){msg(samo.i18n('NO_MEAL'));$result=false;}
if(!$result){button_disable(0,'calc');}
return $result;}
function checkServices(){var is_ok=true;$module_container.find('.ASERVICES table.res tbody tr[data-selected="1"]').not('.note, .freightInfo').each(function(){if($(this).data('needfreightinfo')){var mainserviceuid=$(this).data('uid');var $freightinfotr=$module_container.find('.ASERVICES table.res tbody tr.freightInfo[data-mainserviceuid="'+mainserviceuid+'"]');const $port=$freightinfotr.find('.FREIGHTINFO_PORT'),port=$port.val();if(!port){$port.errorField(samo.i18n('NO_FREIGHTINFO'));is_ok=false;return false;}
const $freight=$freightinfotr.find('.FREIGHTINFO_FREIGHT'),freight=$freight.val();if(!freight){$freight.errorField(samo.i18n('NO_FREIGHTINFO'));is_ok=false;return false;}
const $date=$freightinfotr.find('.FREIGHTINFO_DATE'),date=$date.val();if(!date){$date.errorField(samo.i18n('NO_FREIGHTINFO'));is_ok=false;return false;}
const $time=$freightinfotr.find('.FREIGHTINFO_TIME'),time=$time.val();if(!time){$time.errorField(samo.i18n('NO_FREIGHTINFO'));is_ok=false;return false;}}});return is_ok;}
samo.bron_form();samo.initHotelPopup($module_container,{source:'.HOTELSINFO table',object:'.link-hotel'});var unHightlight=function(obj,cssClass){if(typeof cssClass=='undefined'){cssClass='yellow';}
var offerHash=obj.data('offerHash');$('tr[class*=_freightOffer]').removeClass(cssClass);$('tr[class*=-'+offerHash+']').addClass(cssClass);};$(document).on('click','tr[class*=_freightOffer-]',function(event){var offerHash=$(this).data('offerHash');var rchecked=$('input._dataCheckedFR'+offerHash).prop('checked');if(rchecked!==true){$('input[class*=_dataCheckedFR]').removeAttr('data-checked');$('input._dataCheckedFR'+offerHash).attr('data-checked','checked');$('input._dataCheckedFR'+offerHash+'[type=hidden]').attr('data-checked','checked');$('input._dataCheckedFR'+offerHash+'[type=radio]').prop('checked',true);unHightlight($(this),'checked');button_disable(1,'bron');var params={};params.claimDocument=samo.claimDocument(false);$.post(getParams('LOADSERVICES'),params,init_services,'script');}});$(document).on('mouseenter','tr[class*=_freightOffer-]',function(event){unHightlight($(this));});$(document).on('mouseup','input[class*=_dataCheckedFR]',function(event){$(this).parent().parent().trigger('click');event.preventDefault();});$(document).on('click','._freightPlanReplace',function(event){button_disable(1,'calc');$(this).parent().click();var params=$(this).data();params.claimDocument=samo.claimDocument(false);var success=function(){button_disable(0,'calc');};$.post(getParams('EXTERNAL_FREIGHTS_PLANS'),params,success,'script');});$(document).on('click','._freightPlanTabPanel',function(){var tabid=$(this).data('tabid');$('._freightPlanTab').addClass('hidden');$('#freightPlanTab'+tabid).removeClass('hidden');$('._freightPlanTabPanel').each(function(index,el){$(el).removeClass('searchmode_selected');$(el).addClass('searchmode_not_selected');$('#freightPlanTabLabel'+$(el).data('tabid')).addClass('searchmode_button');});$('#freightPlanTabLabel'+tabid).removeClass('searchmode_button');$('#freightPlanTabPanel'+tabid).removeClass('searchmode_not_selected');$('#freightPlanTabPanel'+tabid).addClass('searchmode_selected');});$(document).on('click','.freightPlanReplaceButton',function(){var params=$(this).data();$.post(getParams('SET_FREIGHTS_PLAN'),params,function(){$(document).triggerHandler('ReloadServices',['LOADSERVICES']);},'script');});$(document).on('click','._frmFreightConfig',function(){var $source=$module_container.find('.SOURCEPOINT'),$target=$module_container.find('.TARGETPOINT');if(!$source.val()){$source.errorField(samo.i18n('NOT_SET_TOWN'));return false;}
if(!$target.val()){$target.errorField(samo.i18n('NOT_SET_TOWN'));return false;}
$module_container.find('.freight_setup_next').css('visibility','hidden');$module_container.find('._frmTownsFreight').one('change',function(){$module_container.find('.freight_setup_dates').hide();$module_container.find('.freight_setup_next').css('visibility','visible');$module_container.find('.freight_setup_dates .date').val('');$('#freightsContainer').hide().find('.external_freight_note').empty().end().find('.freightTable').empty();});var params={};$module_container.find('._frmTownsFreight').each(function(index,el){var $el=$(el),name=$el.attr('name'),val;val=name=='directonly'&&$el.prop('checked')?1:$el.val();params[name]=val;});params.CATCLAIM=$.getParameter('CATCLAIM',true);params.CURRENCY=$.getParameter('CURRENCY',true);params.claim_guid=samo.claim_guid;params.samo_action='EXTERNAL_FREIGHTS_CONFIGURE';var data={claimDocument:samo.claimDocument(false)};$.post(_ROOT_URL+$.param(params),data,function(){var $tr=$module_container.find('.freight_setup_dates');var $places=$module_container.find('.seats-counter');$tr.css('display','table-row');$places.css('display','table');$tr.find('input.frm-input').addClass('date').datePicker();$places.find('select').chosen({disable_search:false});},'script');});$(document).on('click','._frmSendFreight',function(){$module_container.find('.FREIGHTSINFO').find('.freightsFilter,.freightsRes,.external_freight_note').show();$module_container.find('.freightsFilter').html('');$module_container.find('.FREIGHTSINFO tbody.freightTable:eq(0)').html('');var $POINT;$POINT=$module_container.find('.SOURCEPOINT');if(!$POINT.val()){$POINT.errorField(samo.i18n('NOT_SET_TOWNFROMINC'));return;}else{$POINT.removeClass('error');}
$POINT=$module_container.find('.TARGETPOINT');if(!$POINT.val()){$POINT.errorField(samo.i18n('NOT_SET_TOWNTO'));return;}else{$POINT.removeClass('error');}
$('#btnDeleteFreightExternal').hide();samo.checkGDSActionResponse();});$module_container.on('click','#btnDeleteFreightExternal',function(){button_disable(1,'bron');$(this).hide();$module_container.find('.freightsTableBlock .external_freight_note').html('');$module_container.find('.FREIGHTSINFO').find('.freightsFilter,.freightsRes,.external_freight_note').hide();$module_container.find('.EXTERNALFREIGHT').html('');$('#tblTownsFreight').hide();$('#freightsContainer').hide();$module_container.find('.freightsFilter').html('');$module_container.find('.FREIGHTSINFO tbody.freightTable:eq(0)').html('');$('#btnTownsFreight').show();});$module_container.on('click','#btnTownsFreight',function(){$.getScript(getParams('EXTERNAL_FREIGHTS_SEARCH'),function(){$('#btnTownsFreight').hide();$('#btnDeleteFreightExternal').show();$('#tblTownsFreight').show().find('._chosen').each(function(index,el){$(el).chosen({enable_split_word_search:false,search_contains:true,disable_search:(typeof $(el).data('disable_search')=='undefined'?false:true)});});});});samo.showBanners=function(list){var tpl=$('#banner-tpl').html(),content,$tr,selector,$oldBanners;if(tpl){$module_container.find('.hotels select.alternate_hotels').each(function(){var $tr=$(this).parents('tr:first');$(this).find('option').each(function(){var data=$(this).data('json');$tr.removeClass('HotelInc_'+data.key);$tr.removeClass('DateBeg_'+samo.dateAsString(samo.dateFromString(data.datebeg),'yyyymmdd'));$tr.removeClass('DateEnd_'+samo.dateAsString(samo.dateFromString(data.dateend),'yyyymmdd'));});var data=$(this).find('option:selected').data('json');$tr.addClass('HotelInc_'+data.key);$tr.addClass('DateBeg_'+samo.dateAsString(samo.dateFromString(data.datebeg),'yyyymmdd'));$tr.addClass('DateEnd_'+samo.dateAsString(samo.dateFromString(data.dateend),'yyyymmdd'));});$oldBanners=$module_container.find('.claim_banner');$.each(list,function(idx,row){var $message=$module_container.find('#banner_'+row.Inc);if(!$message.length){$tr=$module_container.find('.TOURINFO .tour_info tbody tr:first');if(row.Hotel!=null){selector='.HOTELSINFO .HotelInc_'+row.Hotel;if(row.HotelDateBeg!=null){selector+='.DateBeg_'+samo.dateAsString(samo.dateFromString(row.HotelDateBeg),'yyyymmdd');}
if(row.HotelDateEnd!=null){selector+='.DateEnd_'+samo.dateAsString(samo.dateFromString(row.HotelDateEnd),'yyyymmdd');}
$tr=$module_container.find(selector);}else if(row.Freight!=null){selector='.FREIGHTSINFO .FreightInc_'+row.Freight;if(row.FreightDateBeg!=null){selector+='.DateBeg_'+samo.dateAsString(samo.dateFromString(row.FreightDateBeg),'yyyymmdd');}
if(row.FreightDateEnd!=null){selector+='.DateEnd_'+samo.dateAsString(samo.dateFromString(row.FreightDateEnd),'yyyymmdd');}
$tr=$module_container.find(selector).parents('tr:first');}
if($tr.length){var colspan=$tr.children().length;$tr.after('<tr class="banner-container note"><td colspan="'+colspan+'" class="claim_banner" id="banner_'+row.Inc+'"></td></tr>');$message=$module_container.find('#banner_'+row.Inc);}}
$oldBanners=$oldBanners.not($message);if($oldBanners.length){$oldBanners.parents('tr:first').remove();}
content=ejs.render(tpl,{banner:row});$message.html(content);});}};};samo.tr_lights=function(){var hashLi='',hashOld='old',lightLi='';var $table=$('#gdsGrid');if($table.find('tbody tr').length){$table.show();$table.find('tbody tr:not(.note):visible').each(function(){var trLi=$(this);hashLi=trLi.attr('data-offer-hash');trLi.removeClass('even').removeClass('odd');if(hashOld!==hashLi){lightLi=(lightLi==='odd')?'even':'odd';trLi.addClass(lightLi);hashOld=hashLi;}else{trLi.addClass(lightLi);}});}else{$table.hide();}};samo.filterSliders=function(){var sliders=['flyDurationSlider','departTimeOnSlider','departTimeOffSlider'];var sections=['fly_duration','depart_time_on','depart_time_off'];for(var i=0;i<sliders.length;i++){var slider=document.getElementById(sliders[i]);if(slider){var min=isNaN(parseInt(samo.getValuesBySlideRange('min',sections[i])))?false:parseInt(samo.getValuesBySlideRange('min',sections[i]));var max=isNaN(parseInt(samo.getValuesBySlideRange('max',sections[i])))?false:parseInt(samo.getValuesBySlideRange('max',sections[i]));if(min&&max&&(min!=max)){noUiSlider.create(slider,{start:[min,max],behaviour:'drag-tap',connect:true,step:30,range:{'min':min,'max':max}});}}}
var flyDurationVals=[document.getElementById('fly-duration-value-lower'),document.getElementById('fly-duration-value-upper')];var departTimeOnVals=[document.getElementById('depart-time-on-value-lower'),document.getElementById('depart-time-on-value-upper')];var departTimeOffVals=[document.getElementById('depart-time-off-value-lower'),document.getElementById('depart-time-off-value-upper')];var flyDuration=document.getElementById('flyDurationSlider');var departTimeOn=document.getElementById('departTimeOnSlider');var departTimeOff=document.getElementById('departTimeOffSlider');if(typeof flyDuration.noUiSlider!=='undefined'){flyDuration.noUiSlider.on('update',function(values,handle){flyDurationVals[handle].innerHTML=((parseInt(values[handle]/ 60)<10)?'0':'')+parseInt(values[handle]/ 60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});flyDuration.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(flyDuration).parent().parent().hide();}
if(typeof departTimeOn.noUiSlider!=='undefined'){departTimeOn.noUiSlider.on('update',function(values,handle){departTimeOnVals[handle].innerHTML=((parseInt(values[handle]/ 60)<10)?'0':'')+parseInt(values[handle]/ 60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});departTimeOn.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(departTimeOn).parent().parent().hide();}
if(typeof departTimeOff.noUiSlider!=='undefined'){departTimeOff.noUiSlider.on('update',function(values,handle){departTimeOffVals[handle].innerHTML=((parseInt(values[handle]/ 60)<10)?'0':'')+parseInt(values[handle]/ 60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});departTimeOff.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(departTimeOff).parent().parent().hide();}
$('.sortbyduration').on('click',function(){if($(this).hasClass('asc')){$(this).removeClass('asc');$(this).addClass('desc');_gdsSort('fly_duration','desc');}else if($(this).hasClass('desc')){$(this).removeClass('desc');$(this).addClass('asc');_gdsSort('fly_duration','asc');}else{$(this).addClass('asc');_gdsSort('fly_duration','asc');}
return false;});$('.sortbysurcharge').on('click',function(){if($(this).hasClass('asc')){$(this).removeClass('asc');$(this).addClass('desc');_gdsSort('surcharge','desc');}else if($(this).hasClass('desc')){$(this).removeClass('desc');$(this).addClass('asc');_gdsSort('surcharge','asc');}else{$(this).addClass('asc');_gdsSort('surcharge','asc');}
return false;});function _gdsSort(field,type){type=type||'asc';var grid=document.getElementById('gdsGrid');var tbody=grid.getElementsByTagName('tbody')[0];var rowsArray=[].slice.call(tbody.rows);var tmpTable=[];var rowSpans=0;var rows=0;var i,p;for(i=0;i<rowsArray.length;i++){rowSpans=rowsArray[i].cells[0].rowSpan;if(i==rows){var toPush=[];for(p=0;p<rowSpans;p++){toPush[p]=rowsArray[i+p];}
var params=JSON.parse(rowsArray[i].dataset.bindFilter);toPush[p]=params[field];tmpTable.push(toPush);rows=i+rowSpans;}}
var compare=function(rowA,rowB){return rowA[rowA.length-1]-rowB[rowB.length-1];};tmpTable.sort(compare);if(type=='desc'){tmpTable.reverse();}
grid.removeChild(tbody);for(i=0;i<tmpTable.length;i++){for(p=0;p<(tmpTable[i].length-1);p++){tbody.appendChild(tmpTable[i][p]);}}
grid.appendChild(tbody);samo.tr_lights();}};samo.refreshFreightTable=function(){var flyDurationEl=document.getElementById('flyDurationSlider');var departTimeOnEl=document.getElementById('departTimeOnSlider');var departTimeOffEl=document.getElementById('departTimeOffSlider');var flyDuration=typeof flyDurationEl.noUiSlider!='undefined'?flyDurationEl.noUiSlider.get():[0,999999999];var departTimeOn=typeof departTimeOnEl.noUiSlider!='undefined'?departTimeOnEl.noUiSlider.get():[0,999999999];var departTimeOff=typeof departTimeOffEl.noUiSlider!='undefined'?departTimeOffEl.noUiSlider.get():[0,999999999];var airlineF=$(".freightsFilter select[name='full_airline'] option:selected");var flightTypesF=$(".freightsFilter select[name='flight_types'] option:selected");$('.freightTable tr').each(function(){$(this).show();var trFilter=JSON.parse($(this).attr('data-bind-filter'));if(airlineF.length&&airlineF.val()!=0){if(trFilter['full_airline']!=airlineF.val()){$(this).hide();}}
if(flightTypesF.length&&flightTypesF.val()!=0){if(trFilter['flight_types']!=flightTypesF.val()){$(this).hide();}}
if(trFilter['fly_duration_on']<parseInt(flyDuration[0])||trFilter['fly_duration_off']<parseInt(flyDuration[0])){$(this).hide();}
if(trFilter['fly_duration_on']>parseInt(flyDuration[1])||trFilter['fly_duration_off']>parseInt(flyDuration[1])){$(this).hide();}
if(trFilter['depart_time_on']<parseInt(departTimeOn[0])){$(this).hide();}
if(trFilter['depart_time_on']>parseInt(departTimeOn[1])){$(this).hide();}
if(trFilter['depart_time_off']<parseInt(departTimeOff[0])){$(this).hide();}
if(trFilter['depart_time_off']>parseInt(departTimeOff[1])){$(this).hide();}});var messagesBlock=$('.freightsRes .messages');if($('.freightTable tr:visible').length==0){messagesBlock.html(samo.i18n('NO_FREIGHTS'));}else{messagesBlock.html('');}
samo.tr_lights();};samo.getValuesBySlideRange=function(type,section){var min=999999999;var max=0;$(".freightTable tr:visible").each(function(){var data=JSON.parse($(this).attr('data-bind-filter'));if(section!='fly_duration'){if(data[section]<min){min=data[section];}
if(data[section]>max){max=data[section];}}else{if(data.fly_duration_on<min){min=data.fly_duration_on;}
if(data.fly_duration_off<min){min=data.fly_duration_off;}
if(data.fly_duration_on>max){max=data.fly_duration_on;}
if(data.fly_duration_off>max){max=data.fly_duration_off;}}});if(type=='min'){return min;}
if(type=='max'){return max+1;}
return false;};samo.price_chart=function(){$.require('//www.gstatic.com/charts/loader.js',function(){google.charts.load('current',{packages:['corechart','bar'],language:samo.LANG.locale});google.charts.setOnLoadCallback(samo.googlePriceChart);});samo.helpalt_field($('#search_stat'),'hover');};samo.calendarPrice=function(){if(typeof resultPrices!=='undefined'){var calendar=$("#calendarPrice"),_ROOT_URL=samo.ROUTES.bron.url,params={};var rollR=calendar.find(".roll.right");var rollL=calendar.find(".roll.left");var colDates=calendar.find('.colDates');var abbrDayNames=samo.i18n('DATE_ABBR_DAY_NAMES');var abbrMonthNames=samo.i18n('DATE_ABBR_MONTH_NAMES');var priceDates=$.map(resultPrices.priceList,function(value,index){var seg=index.split('.');return[seg[2]+seg[1]+seg[0]];});priceDates=priceDates.sort();priceDates=$.map(priceDates,function(value,index){var year=value.substr(0,4);var month=value.substr(4,2);var day=value.substr(6,2);return[day+'.'+month+'.'+year];});samo.rollCalendar=function(position){var cellDateIndexFirst,cellDateIndexLast,incrementDate;if(position=='right'){rollL.css('visibility','visible');cellDateIndexFirst=6;cellDateIndexLast=0;incrementDate=1;}else{rollR.css('visibility','visible');cellDateIndexFirst=0;cellDateIndexLast=6;incrementDate=-1;}
var dt=samo.dateFromString(colDates.find('th:eq('+cellDateIndexFirst+')').attr('data-index'));dt.setDate(dt.getDate()+incrementDate);var rd=samo.dateAsString(dt,'dd.mm.yyyy'),oDate=rd.split('.'),strDate=oDate[0]+' '+
abbrMonthNames[(new Date(oDate[2]+'-'+oDate[1]+'-'+oDate[0])).getMonth()]+' , '+
abbrDayNames[(new Date(oDate[2]+'-'+oDate[1]+'-'+oDate[0])).getDay()];colDates.find('th:eq('+cellDateIndexLast+')').remove();var th='<th class="relative dates" data-index="'+rd+'">'+strDate+'</th>';if(position=="right"){colDates.append(th);}else{colDates.prepend(th);}
var lastDate=samo.dateFromString(priceDates[priceDates.length-1]),firstDate=samo.dateFromString(priceDates[0]),thisDate=samo.dateFromString(rd);if(position=='right'&&(lastDate<=thisDate)){rollR.css('visibility','hidden');}else if(position=='left'&&(firstDate>=thisDate)){rollL.css('visibility','hidden');}
var prices=resultPrices.prices[rd];calendar.find('.rows').each(function(){var template='<td class="cells"></td>',elClass,elTitle;var row=$(this),nights=row.find('th.relative.dates').text();row.find('td:eq('+cellDateIndexLast+')').remove();if(typeof prices!=='undefined'&&typeof prices[nights]!=='undefined'){elTitle="<div class='text-center'><b>"+prices.datestr+" | "+
samo.i18n('PRICE_CALENDAR_NIGHTS')+nights+"</b><br>"+prices[nights]+" ";if(prices.diff[nights]>0){elTitle+=" <span class='red'><b>"+prices.diff[nights]+" "+resultPrices.currency+"</b></span> <div class='arrowUp'></div>";}else if(prices.diff[nights]<0){elTitle+="<span class='green'><b>"+prices.diff[nights].toString().substr(1)+" "+
resultPrices.currency+"</b></span> <div class='arrowDown'></div>";}
if(prices.color[nights]!='white'){elTitle+='<br><b>';if(prices.color[nights]=='green'){elTitle+=samo.i18n('TOUR_SEARCH_MOMENT_CONFIRM');elClass='bgreen';}
elTitle+='</b>';}
if(nights==resultPrices.nights&&rd==resultPrices.checkIn){elClass+=' selected ';}
elTitle+="</div>";template='<td class="cells price '+elClass+'">';elClass=prices.color[nights];template+='<div class="flexContainer" data-type="'+elClass+'" '+'title="'+elTitle+'" data-catclaim="'+prices.catclaim[nights]+'"><div class="fcontent">';var tmpClass='',tmpPrice=0,tmpArrow='';if(prices.diff[nights]>0){tmpClass=' cloudred';tmpPrice='+'+prices.diff[nights];tmpArrow='<span class="arrowUp"></span>';}else if(prices.diff[nights]<0){tmpClass=' cloud';tmpPrice=prices.diff[nights];tmpArrow='<span class="arrowDown"></span>';}else{tmpPrice=prices.priceNumber[nights];}
template+='<div class="content'+tmpClass+'">'+tmpPrice+' '+resultPrices.currency+tmpArrow;template+='</div></div></div>';}
var vEl=$(template),bullet=vEl.find('.flexContainer');bullet.msgBullet({showOn:'hover',bulletText:bullet.attr('title'),bulletType:bullet.attr('data-type'),delay:1});bullet.on('click',function(){params.CATCLAIM=bullet.attr('data-catclaim');document.location.href=_ROOT_URL+$.param(params);});if(position=='right'){row.append(vEl);}else{row.find('th:eq(0)').after(vEl);}});};rollR.on('click',function(){samo.rollCalendar('right');samo.refreshCalendar();});rollL.on('click',function(){samo.rollCalendar('left');samo.refreshCalendar();});samo.refreshCalendar=function(){calendar.find("td").on('mouseenter',function(){calendar.find("th").each(function(){if($(this).hasClass("dates")){$(this).removeClass('hoveredDate');}});var td=$(this);var col=td.parent().children().index(td)-1;var row=td.parent().parent().children().index(td.parent());var dateRow=calendar.find("tbody th.dates:eq("+row+")");var colRow=calendar.find("thead th.dates:eq("+col+")");dateRow.addClass('hoveredDate');colRow.addClass('hoveredDate');});calendar.find("th").on('mouseenter',function(){calendar.find("th").each(function(){if($(this).hasClass("dates")){$(this).removeClass('hoveredDate');}});});};calendar.find('td.price div.flexContainer').each(function(){$(this).msgBullet({showOn:'hover',bulletText:$(this).attr('title'),bulletType:$(this).attr('data-type'),delay:1});$(this).on('click',function(){params.CATCLAIM=$(this).attr('data-catclaim');document.location.href=_ROOT_URL+$.param(params);});});samo.helpalt_field($('#calendarPrice'),'hover');if(calendar.length){samo.refreshCalendar();}}};samo.compositionTourists=function(tourists){let compositionTourists={toString:function(){let compositionString='';for(let key in this){if(key!=='toString'){compositionString=compositionString+key+'('+this[key]+') ';}}
return compositionString;}};$(tourists).each(function(i){if(this.human==='MR'||this.human==='MRS'){compositionTourists.ADL=(compositionTourists.ADL||0)+1;}else{compositionTourists[this.human]=(compositionTourists[this.human]||0)+1;}});return compositionTourists;}
function valid_date(field,is_bron){var value='';if(field.length&&field.clearVal().length){value=$.controlValue(field.get(0));value=parseInt(value);if(value>20790000||value<19010000){return error_tourist(samo.i18n('INCORRECT_DATE'),field);}}
return value;}
samo.freightInfant=function(){if($('.addinfant_cb').prop('checked')){let isInfantPlaceAvailable=true;$('select.freight').each(function(){if($(this).children("option:selected").data('children-place-in-avia')!==1){isInfantPlaceAvailable=false;return;}});if(isInfantPlaceAvailable){$('[data-name="INFANT_FREIGHT_PLACE"]').show();}else{$('[data-name="INFANT_FREIGHT_PLACE"]').hide();if($('#INFANT_FREIGHT_PLACE').prop('checked')){$('#INFANT_FREIGHT_PLACE').prop('checked',false);$.notify({text:samo.i18n('BRON_INFANT_TRANSPORT_NOT_PLACE'),type:'message'});}}}}
$(samo.bron_info);$(samo.calendarPrice);$('.samo_container').find('input.int').on('keypress',samo.key_press_filter);})(samo.jQuery);