if(typeof samo.acquiring=='undefined'){(function($){samo.acquiring={};const self=samo.acquiring;self.work=function(moduleName){const $container=$('#acquiring_'+moduleName+'_container');const $form=$container.find('form');let getPayData=true;let wasSubmited=false;$('[name=amount]').on('change',changeToPay).change();function changeToPay(){const amo=$('input[name=amount]');const max=parseFloat(amo.data('max'));let val=amo.val();val=parseFloat(val.replace(',','.'));const left_to_pay=$('input[name=left_to_pay]');if(!isNaN(val)&&max>=val){left_to_pay.val((max-val).toFixed(2));}else{left_to_pay.val(0)}}
function loadNewPayData(showManual){const $loading=$form.find('.acquiring-loading-text');const $manual=$form.find('.acquiring_submit_manual');const $auto=$form.find('.acquiring_submit');$form.find('[name="ORDER"]').val('');$form.find('[name="CLAIM"]').val('');$form.find('[name="PEOPLE"]').val('');$form.find('[name="OPEOPLE"]').val('');const func=function(){if(showManual){$manual.show();}
setTimeout(function(){if(!$loading.is(':visible')&&!$manual.is(':visible')&&!$auto.is(':visible')){$auto.show();}
if($manual.is(':visible')||$loading.is(':visible')){$auto.hide();}},200);$loading.hide();};if($form.attr('method')==='POST'){$loading.show();let params={};params.samo_action='GET_PAY_DATA';params.merchant=$form.data('merchant');params.CLAIM=samo.CLAIM;$('input,textarea',$container).each(function(i,e){if(e.name!=='amount'||e.id==='pv_amount'){params[e.name]=e.value;}});$.ajax({url:samo.ROUTES[moduleName].url+$.param(params),dataType:"script",success:func,error:func});}else{func();}}
let html2=false;let amount_val=null;function preAmount(){if($form.find('input[name="amount"]').not('#pv_amount').length){html2=String($form.find('#pv_amount').get(0).outerHTML);amount_val=$form.find('#pv_amount').val();$form.find('#pv_amount').replaceWith('<span id="pv_amount_container"></span>');}}
function postAmount(){if(html2){$('#pv_amount_container').replaceWith(html2);$form.find('#pv_amount').val(amount_val);html2=false;}}
function checkAmount(){const amo=$('#pv_amount');let err=false;if(amo.length){let val=amo.val();val=parseFloat(val.replace(',','.'));if(isNaN(val)||val===0){val=0;err=samo.i18n('NO_CLAIM_PAYMENT');}else{let m=parseFloat(amo.data('max')).toFixed(2);if(m&&val>m){err=samo.i18n('PAYER_AMOUNT_BIG')+' '+m;}else{m=parseFloat(amo.data('min')).toFixed(2);if(val<m){err=samo.i18n('PAYER_AMOUNT_LITTLE')+' '+m;}}}
amo.val(val);if(err){amo.addClass('error');}else{amo.removeClass('error');}
if(err){amo.errorField(err);}}
return!err;}
window[moduleName+'_result']=function(getParams,altform=false){getPayData=false;const $amount=$form.find('#pv_amount');if(!wasSubmited){$amount.hide().after($amount.val());}
if(getParams){let $inp,ind;$form.find('input').remove();for(ind in getParams){$inp=$form.find('input[name="'+ind+'"]');if(!$inp.length){$inp=$('<input>').attr('type','hidden').attr('name',ind);$form.append($inp);}
$inp.val(getParams[ind]);}}
const $auto=$form.find('.acquiring_submit');$form.find('.acf-visible-field').prop('disabled',true);if(!wasSubmited){if(altform){samo.altform(getParams);}else{$auto.trigger('click').hide();}
wasSubmited=true;setTimeout(function(){loadNewPayData(true);},100);if(altform){$.modal.close();}}};$form.find('.acquiring_submit_manual','click',function(){getPayData=false;});$form.on('submit',function(){if(!checkAmount()){return false;}
if(!getPayData){$form.find('.acquiring_submit_manual').hide();if(wasSubmited){setTimeout(function(){postAmount();loadNewPayData(true);},100);}
preAmount();setTimeout(function(){postAmount();},100);return true;}
$form.find('.acquiring_submit').hide();loadNewPayData();return false;});if($.getParameter('DOPAY',true)==1){$form.submit();}};samo.confirmed_by_sms=function(moduleName){const $container=$('#acquiring_'+moduleName+'_sms_container');const $form=$container.find('form');$form.find('input#sms-code').prop('disabled',true);$form.find('button.acquiring-submit-sms').prop('disabled',true);$form.find('div.sms-confirmed').css('display','block');setTimeout(function(){$.modal.close();},10000);};})(samo.jQuery);}