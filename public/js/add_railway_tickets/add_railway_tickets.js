(function($){samo.frplacement_available=1;samo.frplacement_blocked=2;samo.frplacement_seats={};samo.frplacement_titles={};samo.add_railway_tickets=function(){var _ROOT_URL=samo.ROUTES.add_railway_tickets.url,$module_container=$('#claim_edit');samo.controls.calc=$module_container.find('button.claim_edit_calc');samo.controls.save=$module_container.find('button.claim_edit_save');$module_container.find('.claim_edit_close').on('click',function(){if(confirm(samo.i18n('CLAIM_EDIT_QUIT'))){samo.updateClaim(null);}});$module_container.find('._chosen').each(function(index,el){$(el).chosen({enable_split_word_search:false,search_contains:true,disable_search:(typeof $(el).data('disable_search')=='undefined'?false:true)});});$module_container.find('._frmFreightConfig').off('click').on('click',function(){var $source=$module_container.find('.SOURCEPOINT'),$target=$module_container.find('.TARGETPOINT');if(!$source.val()){$source.errorField(samo.i18n('NOT_SET_TOWN'));return false;}
if(!$target.val()){$target.errorField(samo.i18n('NOT_SET_TOWN'));return false;}
$module_container.find('.freight_setup_next').hide();$module_container.find('._frmTownsFreight').one('change',function(){$module_container.find('.freight_setup_dates').hide();$module_container.find('.freight_setup_next').show();$module_container.find('.freight_setup_dates .date').val('');$module_container.find('.seats-counter').hide();$module_container.find('.claim_edit_div_search').hide();samo.controls.calc.prop('disabled',true);samo.controls.save.prop('disabled',true);$module_container.find('.price_details').hide();$('#freightsContainer').hide().empty();});var params={};$module_container.find('._frmTownsFreight').each(function(index,el){var $el=$(el),name=$el.attr('name'),val;val=name=='directonly'&&$el.prop('checked')?1:$el.val();params[name]=val;});params.CLAIM=parseInt($module_container.data('claim'),10);params.guid=$module_container.data('guid');params.samo_action='EXTERNAL_FREIGHTS_CONFIGURE';$.post(_ROOT_URL+$.param(params),null,function(){var $tr=$module_container.find('.freight_setup_dates');var $places=$module_container.find('.seats-counter');$tr.css('display','table-row');$places.css('display','table');$module_container.find('.claim_edit_div_search').show();$tr.find('input.date').datePicker();$places.find('select').on('change',function(){samo.controls.calc.prop('disabled',true);samo.controls.save.prop('disabled',true);$module_container.find('.price_details').hide();$('#freightsContainer').hide().empty();});$tr.find('input.date').on('change.datepicker',function(){samo.controls.calc.prop('disabled',true);samo.controls.save.prop('disabled',true);$module_container.find('.price_details').hide();$('#freightsContainer').hide().empty();});$places.find('select').chosen({disable_search:false});},'script');});$module_container.on('click','._frmSendFreight',function(){var $POINT;$POINT=$module_container.find('.SOURCEPOINT');if(!$POINT.val()){$POINT.errorField(samo.i18n('NOT_SET_TOWNFROMINC'));return;}else{$POINT.removeClass('error');}
$POINT=$module_container.find('.TARGETPOINT');if(!$POINT.val()){$POINT.errorField(samo.i18n('NOT_SET_TOWNTO'));return;}else{$POINT.removeClass('error');}
samo.checkGDSActionResponse();});samo.checkGDSActionResponse=function(frClass,guid,progress,target){var params={};if(!guid){var $places=$module_container.find('.seats-counter select.places');if($places.length>0){var places=[];var checkCommonPlaces=true;var commonPlaces=[];$places.each(function(){var place={},$select=$(this),data=$select.data();delete data.chosen;delete data.jqv;place=data;if(this.value==0){place.with_place=1;}else{place.with_place=0;place.place_key=this.value;}
place.with_place=this.value==0?1:0;if(!place.with_place){if(!commonPlaces.includes(place.place_key)){commonPlaces.push(place.place_key);}else{checkCommonPlaces=false;$select.errorField(samo.i18n('FRPLACEMENT_CHANGE'))}}
places.push(place);});if(!checkCommonPlaces){return false;}
params.places=places;}}
$module_container.find('._frmSendFreight').prop('disabled',true);$module_container.find('._frmTownsFreight').prop('disabled',true);$module_container.find('.freight_setup_dates input').prop('disabled',true);$module_container.find('.seats-counter select.places').prop('disabled',true);if(!progress){progress=2.5;}
$('#freightsContainer').show();$module_container.find('.result-progress').show();$module_container.find('.freightsRes .messages').html(samo.i18n('FLIGHTS_LOAD'));$module_container.find('.result-progress .blue').css('width',progress+'%');var delay=1;var $container=$module_container.find('.FREIGHTSINFO');var $selects=$container.find('select');$selects.prop('disabled',true).addClass('samo-preloader');var $_get={};$('._frmTownsFreight').each(function(index,el){var $el=$(el),name=$el.attr('name'),val;val=name=='directonly'&&$el.prop('checked')?1:$el.val();params[name]=val;});$_get.CLAIM=parseInt($module_container.data('claim'),10);$_get.guid=$module_container.data('guid');if($module_container.find('.FREIGHT_DIRECT').length==1){params.FREIGHT_DIRECT=samo.dateAsString(samo.dateFromString($module_container.find('.FREIGHT_DIRECT').val()),'yyyymmdd');}
if($module_container.find('.FREIGHT_BACK').length==1){params.FREIGHT_BACK=samo.dateAsString(samo.dateFromString($module_container.find('.FREIGHT_BACK').val()),'yyyymmdd');}
$_get.samo_action='CHECK_GDS_ACTION_RESPONSE';params.fClass=(frClass&&frClass=='Business')?'Business':((frClass&&frClass=='Comfort')?'Comfort':'Econom');if(target){params.target=target;}
$_get.extfr=1;$_get.doSearch=1;$_get.guid=guid;params.progress=progress;if(guid){$_get.doSearch=0;delay=3000;samo.jQuery('#search_id_btn').remove();samo.jQuery('#freightsContainer').append('<a class="external" id="search_id_btn" title="'+samo.i18n('SEARCH_ID')+'">'+samo.i18n('SEARCH_ID')+'</a>').find('.external').on('click',function(){return samo.popupText(this,guid,true);});}
setTimeout(function(){$.post(_ROOT_URL+$.param($_get),params,false,'script');},delay);};samo.errorGDSActionResponse=function(){var msg=arguments.length==1?arguments[0]:samo.i18n('FLIGHTS_LOAD_ERROR');$module_container.find('._frmSendFreight').prop('disabled',false);$module_container.find('._frmTownsFreight').prop('disabled',false);$module_container.find('.freight_setup_dates input').prop('disabled',false);$module_container.find('.seats-counter select.places').prop('disabled',false);$module_container.find('.price_details').hide();$module_container.find('.result-progress .blue').css('width','100%');$module_container.find('.freightsRes .messages').html(msg);$module_container.find('.result-progress').hide();$module_container.find('.result-progress .blue').css('width','2.5%');$.notify({type:'error',text:msg,permanent:0});};samo.getGDSDataResponse=function(fClass,guid,target){$module_container.find('.result-progress .blue').css('width','100%');$module_container.find('.freightsRes .messages').html('');var $self=$(this),$container=$module_container.find('.FREIGHTSINFO');$self.prop('disabled',true).addClass('samo-preloader');var $selects=$container.find('select');$selects.prop('disabled',true).addClass('samo-preloader');var params={};params.CLAIM=parseInt($module_container.data('claim'),10);params.guid=$module_container.data('guid');params.samo_action='EXTERNAL_FREIGHTS';params.fClass=fClass;params.extfr=1;params.guid=guid;params.target=target;$.post(_ROOT_URL+$.param(params),{},function(){$self.prop('disabled',false).removeClass('samo-preloader');$container.find('.samo-preloader').prop('disabled',false).removeClass('samo-preloader');$container.find('select.freight:eq(0)').change();$module_container.find('.result-progress').hide();$module_container.find('.result-progress .blue').css('width','2.5%');$module_container.find('._frmSendFreight').prop('disabled',false);$module_container.find('._frmTownsFreight').prop('disabled',false);$module_container.find('.freight_setup_dates input').prop('disabled',false);$module_container.find('.seats-counter select.places').prop('disabled',false);$module_container.find('.freights select.freight').on('change',function(){samo.controls.save.prop('disabled',true);var $this=$(this);var $note=$this.parents('tr').next('.note:first');var $value=$this.find('option:selected');var note=$value.data('note');var tariff=$value.data('tariff-info');if(note||tariff){var content='';if(note){content+=note;}
if(tariff){content+=tariff;}
$note.removeClass('hidden').find('td').html(content);}else{$note.addClass('hidden');}
let freightKeyOld=$this.data('freightKeyOld');$this.data('freightKeyOld',$this.val());if(typeof samo.frplacement_seats[freightKeyOld]!=='undefined'){delete samo.frplacement_seats[freightKeyOld];}}).change();},'script',function(){$.notify({type:'error',text:samo.i18n('FREIGHT_LOAD_FAILED'),permanent:0});$self.prop('disabled',false).removeClass('samo-preloader').css('display','block');$module_container.find('._frmSendFreight').prop('disabled',false);$module_container.find('._frmTownsFreight').prop('disabled',false);$module_container.find('.freight_setup_dates input').prop('disabled',false);$module_container.find('.seats-counter select.places').prop('disabled',false);$module_container.find('.price_details').hide();});};samo.GDSByRouteInit=function(){var $places=$module_container.find('.seats-counter-container select.places');var clients=[];var placeCount=0;if($places.length){$places.each(function(){var $place=$(this),data=$place.data(),common=$place.val();clients.push({'peopleKey':data.key,'common':(common==0)?data.key:common});if(common==0){placeCount++;}});}
$('#freightsContainer select').each(function(){if(clients.length>0){$(this).find('option').each(function(){var $freight=$(this),data=$freight.data('json');data.clients=clients;data.count=1;data.fixedClients=1;$freight.data('json',data);});}
samo.init_frplacement_railway_tickets(this);}).chosen();if($('#freightsContainer select').length==2){samo.controls.calc.prop('disabled',false);}else{samo.controls.calc.prop('disabled',true);}};samo.init_frplacement_railway_tickets=function(event){var target=(typeof event.target!='undefined')?event.target:event;var $select=$(target),$btn=$select.parents('tr:first').find('td.frplacement .button'),$option=$select.find('option:selected'),data=$option.data();var freightKey=$option.val();$select.data('freightKeyOld',freightKey);var $all=$module_container.find('.freights tbody tr').not('.note');var $first_option=$all.first().find('select').find('option:selected');var $first_frplacement=$first_option.data('frplacement');if(data&&data.frplacement==samo.frplacement_available&&$first_frplacement!=samo.frplacement_blocked){if(!$btn.length){var disabled=false;$btn=$select.parents('tr:first').find('td.frplacement').append('<span class="button">&nbsp;</span>').find('.button').on('click',function(){if(disabled){return false;}
disabled=true;var $option=$(this).parents('tr:first').find('select option:selected');var params={freight:$option.val()};params.claimDocument=samo.claimDocument();params.maxWidth=$module_container.width();params.maxHeight=$(window).height();if(typeof samo.frplacement_seats[params.freight]!='undefined'){params.seats=samo.frplacement_seats[params.freight];}
var $_get={};$_get.CLAIM=parseInt($module_container.data('claim'),10);$_get.guid=$module_container.data('guid');$_get.samo_action='CHOOSE_FRPLACEMENT';$.post(_ROOT_URL+$.param($_get),params,function(){disabled=false;},'script');});}
if(typeof samo.frplacement_seats[freightKey]!=='undefined'){var seats=Object.keys(samo.frplacement_seats[freightKey]),scount=seats.length,pcount=parseInt($select.parents('tr:first').find('.fr_peoplecount').text());if(!pcount){var $tour_info=$module_container.find('.tour_info');var peoplecount=parseInt($tour_info.data('peoplecount'));pcount=peoplecount;}
var title='';if(typeof samo.frplacement_titles[freightKey]!='undefined'){title=samo.frplacement_titles[freightKey]+", ";}
if(scount>pcount){delete samo.frplacement_seats[freightKey][seats[scount-1]];scount=Object.keys(samo.frplacement_seats[freightKey]).length;}
if(scount==pcount){$btn.addClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHANGE'));}
if(scount<pcount){$btn.removeClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHOOSE'));}
$select.on('change',function(){$btn.removeClass('seats').attr('data-title',samo.i18n('FRPLACEMENT_CHOOSE'));});}else{$btn.removeClass('seats').attr('data-title',samo.i18n('FRPLACEMENT_CHOOSE'));}}else{if($btn.length){$btn.remove();}}};samo.claimDocument=function(){var claimDocument={};var freight_counter=-1;claimDocument['transports']=[];freightSelect='.FREIGHTSINFO tbody .freight';$module_container.find(freightSelect).each(function(){var $self=$(this);if($self.val()>0){freight_counter++;var freight=null;if(this.tagName=='SELECT'){freight=$self.find('option:selected');}else{freight=$self;}
var _freight_json=freight.data('json'),_freight_seats=freight.data('seats');if(typeof _freight_seats=='undefined'){_freight_seats=samo.frplacement_seats[_freight_json.key];}
var freight_json=$.extend({},_freight_json),freight_seats=$.extend({},_freight_seats);var clients=[];if(typeof freight_json.clients!='undefined'){clients=[];$(freight_json.clients).each(function(){var client={peopleKey:this.peopleKey,common:this.common,};if(freight_seats&&typeof freight_seats[client.common]!='undefined'){client.seatKey=freight_seats[client.common]['inc'];client.seatName=freight_seats[client.common]['name'];if(typeof freight_seats[client.common]['full_coupe']!=='undefined'){client.full_coupe=freight_seats[client.common]['full_coupe'];}}
clients.push(client);});freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}}});return claimDocument;};samo.unchoose_frplacement=function(freightKey){delete samo.frplacement_seats[freightKey];delete samo.frplacement_titles[freightKey];}
samo.frplacement_save_railway_tickets=function(button,$pTable,$targetResult){button.disabled=true;var data=null,seats={},seats_count=0,titles=[],$peoples=$pTable.find('tbody tr'),$people=null;$peoples.each(function(){$people=$(this);data=$people.data();if(data.inc){seats[data.people]={'inc':data.inc,'name':data.name};if(typeof data.full_coupe!=='undefined'){seats[data.people].full_coupe=data.full_coupe;}
titles.push($people.find('.frplacement').text());seats_count++;}});var freight=$pTable.data('freight');if(Object.keys(seats).length>0){samo.frplacement_seats[freight]=seats;samo.frplacement_titles[freight]=titles.join(", ");}else{delete samo.frplacement_seats[freight];delete samo.frplacement_titles[freight];}
var $_get={};$_get.CLAIM=parseInt($module_container.data('claim'),10);$_get.guid=$module_container.data('guid');$_get.samo_action='CHECK_FRPLACEMENT';var params={freight:freight};params.claimDocument=samo.claimDocument();$.post(_ROOT_URL+$.param($_get),params,function(){button.disabled=false;samo.controls.save.prop('disabled',true);var $target=$targetResult.parents('select');if($target.length){samo.init_frplacement_railway_tickets($target);}},'script');};samo.freight_note=function(freight,note){var $value=$module_container.find('.freights select option[value="'+freight+'"]');var $note=$value.parents('tr').next('.note:first');if(note){var freight_note=$value.data('note');var freight_tariff=$value.data('tariff-info');var content='';if(freight_note){content+=freight_note;}
if(freight_tariff){content+=freight_tariff;}
content+='<hr>'+note;$note.removeClass('hidden').find('td').html(content);}};function checkFreights(){let $freightsWithFrplacement;$freightsWithFrplacement=$module_container.find('.FREIGHTSINFO .frplacement .button').closest('tr');if($freightsWithFrplacement.length>0){const $seats=$freightsWithFrplacement.find('.button.seats');if($seats.length!=$freightsWithFrplacement.length){$freightsWithFrplacement.find('.button').not('.seats').first().trigger('click');return false;}}
return true;}
samo.controls.calc.on('click',function(){calcSave(0);});samo.controls.save.on('click',function(){calcSave(1);});calcSave=function($save){if(checkFreights()){var $_get={};$_get.CLAIM=parseInt($module_container.data('claim'),10);$_get.guid=$module_container.data('guid');$_get.samo_action='CALCSAVE';var params={};params['SAVE']=$save;params.claimDocument=samo.claimDocument(false);if(params.claimDocument==false){return false;}
samo.disableForm();$.post(_ROOT_URL+$.param($_get),params,function(){if(!$save){samo.enableForm();}},'script');}};};})(samo.jQuery);