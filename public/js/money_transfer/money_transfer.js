(function($){const $module_container=$('#money_transfer');samo.money_transfer=function(){samo.cache_controls($module_container);const _ROOT_URL=samo.ROUTES.money_transfer.url;const $TYPE=$module_container.find('.TYPE');const $ClaimFrom=$module_container.find('.claimFrom');const $ClaimTo=$module_container.find('.claimTo');const $Summa=$module_container.find('.summ');const $Currency=$module_container.find('.CURRENCY');let $right_side=$module_container.find('.right_side');const $BankBik=$right_side.find('input.bikBank');const $BankAccount=$right_side.find('.bankAccount');const $BankName=$right_side.find('.bankName');const $RecipientName=$right_side.find('.recipientName');const $CardNumber=$right_side.find('.cardNumber');const $BankBikRow=$right_side.find('.bikBankRow');const $BankAccountRow=$right_side.find('.bankAccountRow');const $BankNameRow=$right_side.find('.bikBankSearchRow');const $RecipientNameRow=$right_side.find('.recipientNameRow');const $CardNumberRow=$right_side.find('.cardNumberRow');const $RsSelect=$right_side.find('.rsSelect');$TYPE.chosen();let module_type=$TYPE.val();let with_bank_data=false;$ClaimTo.prop('disabled',module_type==='money_back');$module_container.find('.resultset').on('click','span.page',function(){getTransfers($(this).data('page'));}).on('click','.link.cancel',function(){const doc_inc=$(this).data('online-payment-return');if(!confirm(samo.i18n('CONFIRM_CANCEL_TRANSFER'))){return false;}
$.post(_ROOT_URL+$.param({transfer_inc:doc_inc,samo_action:'cancel_transfer'}),null,function(){getTransfers($(this).data('page'));});}).on('click','.link.reload',function(){const doc_inc=$(this).data('online-payment-return');samo.get_money_transfer_doc(doc_inc,this);}).on('click','.link.upload',function(){const $link=$(this);const $parentRow=$link.parents('.transition');const $table=$parentRow.parent();const doc_inc=$link.data('online-payment-return');const claim_from=$parentRow.find('td.claim-from').text();const doctype_row=$parentRow.data('doctype');const doctype=samo.doc_types[doctype_row];$table.find('.uploadRow').each(function(){$(this).remove();});$(uploadRow()).insertAfter($parentRow);$('#E_DOC_BTN_UPLOAD').on('click',function(){const $elements=$('#edoc_file');if(samo.check_file_extension($elements,doctype.upload_format.join(","),doctype.upload_size)){const load_btn=samo.loadBtn;samo.loadBtn=$(this);$.ajax({async:true,dataType:'iframe script',type:'POST',url:_ROOT_URL+$.param({CLAIM:claim_from,ONLINE_PAYMENT_RETURN:doc_inc,samo_action:'UPLOAD_EDOC',DOCTYPE:doctype_row,is_js:1}),fileInput:$elements});samo.loadBtn=load_btn;}});$('.cancelSend').on('click',function(){$(this).parents('.uploadRow').remove();});});function getTransfers(){$module_container.find('.resultset').empty().get(0).scrollIntoView();const page=parseInt(arguments[0],10)||1;let result={};result.CLAIMPAGE=page;result.samo_action='update_money';$.getScript(_ROOT_URL+$.param(result));}
$module_container.find('.check.button').on('click',function(){let params=getFields();if(params.isOk){params.samo_action='check_transfer';$.getScript(_ROOT_URL+$.param(params));}});$ClaimFrom.on('change keyup input',function(){preventChangeFields();if(this.value.match(/\D/g)){this.value=this.value.replace(/\D/g,'');}});$ClaimTo.on('change keyup input',function(){preventChangeFields();if(this.value.match(/\D/g)){this.value=this.value.replace(/\D/g,'');}});$TYPE.on('change',function(){module_type=$(this).val();rightSide(false);preventChangeFields();$ClaimTo.val('');$ClaimTo.prop('disabled',module_type==='money_back');});$Summa.on('blur',function(){$(this).val($(this).val().replace(",",".").replace(/\s+/g,''));});function preventChangeFields(){if(with_bank_data){$BankBik.val('');$BankName.text('');$BankName.data('bank-inc','');$BankAccount.val('');$RecipientName.val('');$CardNumber.val('');}
with_bank_data=false;$Summa.val('').prop('disabled',true);$Currency.text('');$module_container.find('.load.button').remove();$module_container.find('.check.button').show();$module_container.find('.buttonBlock a').remove();}
function uploadRow(){return'<tr class="uploadRow highlight">\n'+'            <td colspan="4"></td>\n'+'            <td colspan="4"><input type="file" id="edoc_file" name="edoc_file">\n'+'            <button id="E_DOC_BTN_UPLOAD">'+samo.i18n('MB_UPLOAD')+'</button>\n'+'            <button class="cancelSend">'+samo.i18n('MB_CANCEL')+'</button>\n'+'            </td>\n'+'        </tr>';}
function loadButton(){return'<span class="link load button">'+samo.i18n('MB_PREPARE')+'</span>';}
function getFields(){let result={};result.isOk=false;if(checkFields()){result.CLAIMFROM=parseInt($ClaimFrom.val());result.CLAIMTO=isNaN(parseInt($ClaimTo.val()))?null:parseInt($ClaimTo.val());result.SUMM=isNaN(parseFloat($Summa.val()))?null:parseFloat($Summa.val());result.CURRENCY=$Currency.val();result.TYPE=module_type;if(with_bank_data){result.BANK=parseInt($BankName.data('bank-inc'));result.BANK_ACCOUNT=$BankAccount.val();result.RECIPIENT_NAME=$RecipientName.val();result.CARD_NUMBER=$CardNumber.val();}else if(result.CLAIMTO==null){result.BANK=$RsSelect.find('option:selected').data('bank-inc');result.BANK_ACCOUNT=$RsSelect.val();}
result.isOk=true;}
return result;}
function checkFields(){let is_ok=true;$module_container.find('.left_side input.number').each(function(){if($(this).is(':enabled')){const $input=$(this);const value=parseInt($input.val());if(typeof value==='number'&&(!isNaN(value)||value<=0)){samo.field.clear_error($input);}else{is_ok=false;$input.errorField(samo.i18n('MB_FIELD_ERROR'));}}});if(with_bank_data){if($BankName.data('bank-inc')===""){is_ok=false;$BankBik.errorField(samo.i18n('REQUIRED_FIELD_EMPTY'));}
if(!$.NonEmptyValue($RecipientName,true)||!$.RegexpValue($RecipientName)){is_ok=false;}
if(!$.NonEmptyValue($CardNumber,true)||!$.RegexpValue($CardNumber)){is_ok=false;}
if(!$.NonEmptyValue($BankAccount,true)||!$.RegexpValue($BankAccount)){is_ok=false;}}
return is_ok;}
samo.get_money_transfer_doc=function(doc_inc,element){const $link=$(element);$('.link.load.button').hide();let params={};const $parentRow=$link.parents('.transition');params.samo_action='PDF_SAMOTOUR';params.transfer_inc=doc_inc
params.OWNER_FROM=$parentRow.data('owner-from');params.TOUR_FROM=$parentRow.data('tour-from');params.STATE_FROM=$parentRow.data('state-from');const e=$.Event('click');e.target=$link.get(0);const href=_ROOT_URL+$.param(params);$link.attr('href',href);samo.delayed_download(e);$('.link.upload').msgBullet({bulletText:samo.i18n('SIGNED_STATEMENT'),bulletType:'info',bulletPosition:'topLeft',showOn:'event'});};samo.money_transfer_checked=function(result){if(module_type==='money_back'){if(result['need_bank_details']===1){with_bank_data=true;findBank();}
rightSide(true,result['need_bank_details']);}
let $check=$('.check.button');$(loadButton()).insertAfter($check);$check.hide();$module_container.find('.load.button').on('click',function(){let params=getFields();if(params.isOk){$module_container.find('.resultset').empty().get(0).scrollIntoView();$.post(_ROOT_URL+'samo_action=new_transfer',params);}});$Summa.val(result['summa']);$Currency.text(result['currency_alias']);if(!with_bank_data){$Summa.prop('disabled',false);}};function findBank(){$BankBik.on('blur',function(){if($BankBik.val().length>=8){let result={};result.samo_action='get_bank';result.bik=$BankBik.val();$.getScript(_ROOT_URL+$.param(result));}else{$BankName.text(samo.i18n('BANK_NOT_FOUND'));$BankName.data('bank-inc','');}});}
function rightSide(show,need_bank_details=true){if(show){$right_side.show();if(need_bank_details){$BankBikRow.show();$BankNameRow.show();$BankAccountRow.show();$RecipientNameRow.show();$CardNumberRow.show();$RsSelect.hide();$right_side.find('.rsSelectRow').hide();}else{$BankBikRow.hide();$BankNameRow.hide();$BankAccountRow.hide();$RecipientNameRow.hide();$CardNumberRow.hide();$right_side.find('.rsSelectRow').show();$RsSelect.show();$RsSelect.chosen();}}else{$right_side.hide();}}
samo.money_transfer_bank_data=function(bank){$BankName.text(bank['Name']);$BankName.data('bank-inc',bank['Inc']);};};$(samo.money_transfer);})(samo.jQuery);