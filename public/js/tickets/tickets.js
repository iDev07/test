"use strict";(function($){var container=samo.initModuleContainer('tickets');samo.tickets=function(){var _ROOT_URL=samo.ROUTES.tickets.url,$module_container=container,DOLOAD=(parseInt($.getParameter('DOLOAD',true,$module_container))==1);var _controls=samo.cache_controls($module_container,'.flightType,.TOWNFROMINC,.TOWNTOINC,.AIRLINE,.CURRENCYINC,.CLASS,.ADULT,.CHILD,.INFANT,.CHECKIN,.CHECKOUT,.FREIGHTBACK,.YESPLACES,input[name=embed],.CHECKIN_DELTA,.CHECKOUT_DELTA,.DIRECT_FLIGHT,.ONEWAY');_controls.resultset=$module_container.find('.resultset');if(DOLOAD){initResultset();}
var chosenControls='.ADULT,.CHILD,.CLASS,.CURRENCYINC,.age1,.age2,.age3,.period,.flightType';var $extend=$module_container.find('.extend');$(chosenControls).each(function(){var $this=$(this);$this.chosen({enable_split_word_search:false,search_contains:true,disable_search:true});var chosenEl=$this.parent().find('.chosen-container');chosenEl.addClass($this.attr('name')+'_chosen');chosenEl.css('text-align','left');});$('.AIRLINE').chosen({placeholder_text:samo.i18n('AIRLINE_ANY'),enable_split_word_search:false,search_contains:true,allow_single_deselect:true});$(_controls.ONEWAY).on('click',function(){var oneWay=$(this).prop('checked')===false;if(oneWay){$extend.find('.CHECKOUT').val('');}
$extend.find('.CHECKOUT').prop('disabled',oneWay);$extend.find('.CHECKOUT_DELTA').prop('disabled',oneWay);$(_controls.FREIGHTBACK).val((+!oneWay).toString()).triggerHandler('change');});$module_container.find('.CHECKIN').on('change.datepicker',function(e,d){if(d){var params={};if('1'==$(_controls.FREIGHTBACK).val()){if(d.date>$(_controls.CHECKOUT).getDate()){params.value=d.formated;}
params.start=$(this).clearVal();$(_controls.CHECKOUT).datePicker(params);}}}).end().find('.CHECKOUT').on('change.datepicker',function(e,d){if(d){var $checkout=$(this),$checkin=$(_controls.CHECKIN);if($checkin.getDate()>$checkout.getDate()){$checkout.val($checkin.clearVal());}}}).on('focus',function(){$module_container.find('.FREIGHTBACK[value=1]').click();}).end().find('.TOWNFROMINC,.TOWNTOINC,.flightType').on('change',function(){var name=this.name||$(this).attr('name');if($.controlValue(name,false,$module_container)!==false){$module_container.find('.AIRLINE').val(0);$.getScript(getParams(name),null,true);}}).end().find('.FREIGHTBACK').on('change',function(){var $self=$(this);var oneWay=$self.val()=='0';$module_container.find('.CHECKOUT').prop('disabled',oneWay);$module_container.find('.CHECKOUT_DELTA').prop('disabled',oneWay);if(oneWay){$module_container.find('.CHECKOUT').val('').clearVal();}
$.getScript(getParams('FREIGHTBACK'),function(){var newDate='';var $checkout=$(_controls.CHECKOUT);if($self.val()=='1'){newDate=$checkout.data('calendar').first;if(newDate){var $checkin=$(_controls.CHECKIN);if($checkin.getDate()>$checkout.getDate()){newDate=$checkin.clearVal();$checkout.val(newDate);}}}else{$checkout.val('');$(_controls.CHECKOUT_DELTA).val('0');}},true);}).end().find('.port_revert,.reverttown').on('click',function(){var target=$(_controls.TOWNTOINC).val(),source=$(_controls.TOWNFROMINC).val();$(_controls.TOWNTOINC).val(source);if(!$(_controls.TOWNTOINC).val()){$(_controls.TOWNTOINC).append('<option value="'+source+'">'+$(_controls.TOWNFROMINC).find(':selected').text()+'</option>');}
$(_controls.TOWNTOINC).val(source);$(_controls.TOWNFROMINC).val(target).change();});$module_container.find('.CHILD').on('draw_child_ages',function(){var child_count=parseInt(this.value);var $child_ages=$module_container.find('.age');var $child_ages_count=$child_ages.length;var $pcountLabel=$module_container.find('.pcount_label');if(child_count>0){$pcountLabel.css('visibility','visible');for(var i=1;i<=$child_ages_count;i++){if(i<=child_count){var $age=$child_ages.filter('.age'+i);$module_container.find('.AGE'+i+'_chosen').css('visibility','visible');}else{$module_container.find('.AGE'+i+'_chosen').css('visibility','hidden');}}}else{$pcountLabel.css('visibility','hidden');$module_container.find('.age_wrapper .chosen-container').css('visibility','hidden');}}).on('change',function(){$(this).triggerHandler('draw_child_ages');}).triggerHandler('draw_child_ages');$module_container.find('.resultset').on('click','td.td_price span.price, .flight .bron',function(){if($(this).is('.stop')){$.notify({text:$(this).attr('title'),type:'error',disappearTime:3000});}else{if($(this).is('.bron')){var $data=$(this).data();var params={TICKET:$data.claim,CURRENCY:$data.catCurrency};window.open(samo.ROUTES.bron.url+$.param(params));}}}).end().find('input.date').datePicker().end().find('.CHECKOUT').on('blur',function(){var newDate=$(this).clearVal();if(newDate==''){$module_container.find('.FREIGHTBACK[value=0]').click();}});$module_container.find('.load').on('click',getPrices);$module_container.find('.TOWNFROMINC,.TOWNTOINC').chosen({no_results_text:samo.i18n('NOT_SET_TOWNFROMINC'),enable_split_word_search:false,search_contains:true});function getPrices(){if(!checkParams()){return;}
if($module_container.hasClass('fast')){window.open(getParams(false)+'&DOLOAD=1');}else{$.getScript(getParams('PRICES'),initResultset,true);}}
function checkParams(){if($(_controls.CHECKIN).clearVal()==''){$(_controls.CHECKIN).errorField(samo.i18n('CL_W_NO_DATE_BEG'));return false;}
if($(_controls.ONEWAY).is(':checked')&&$(_controls.CHECKOUT).clearVal()==''){$(_controls.CHECKOUT).errorField(samo.i18n('CL_W_NO_DATE_END'));return false;}
if(0==$(_controls.ADULT).val()&&0==$(_controls.CHILD).val()){$(_controls.ADULT).errorField(samo.i18n('CHOOSE_PEOPLE_COUNT'));return false;}
return $(_controls.TOWNTOINC).val()!=$(_controls.TOWNFROMINC).val();}
function getParams(action){var useGET=arguments[1]||false;var params={};if(action){params.samo_action=action;}
$.each(_controls,function(i,v){var name=v.name||$(v).attr('name');if(name){if(false==action&&'embed'==name){return false;}
var new_value=$(v).data('new-value');if(typeof new_value!='undefined'&&new_value){params[name]=new_value;$(v).data('new-value',false);}else{params[name]=$.controlValue(v,useGET);}
if(name=='TOWNFROMINC'||name=='TOWNTOINC'){var list=(params[name]+'').split('.');if(list.length==2){params[name]=list[0];params[name.replace(/TOWN/,'PORT')]=list[1];}else{params[name.replace(/TOWN/,'PORT')]='';}}
if((name=='CHECKIN_DELTA'||name=='CHECKOUT_DELTA')&&$(v).prop('checked')){params[name]=$(v).val();}}});if(params.CHILD){var $ages=[],age=0;for(var idx=1;idx<=params.CHILD;idx++){age=$module_container.find('.ages').find('.age'+idx).val();$ages.push(parseInt(age));}
params.AGES=$ages.sort(function(a,b){return a-b;}).join(',');}
params.ONEWAY=$(_controls.ONEWAY).is(':checked')?0:1;params.FREIGHTBACK=params.ONEWAY==1?0:1;return _ROOT_URL+$.param(params);}
$(document).on('click','._freightPlanTabPanel',function(){var tabid=$(this).data('tabid');$('._freightPlanTab').addClass('hidden');$('#freightPlanTab'+tabid).removeClass('hidden');$('._freightPlanTabPanel').each(function(index,el){$(el).removeClass('searchmode_selected');$(el).addClass('searchmode_not_selected');$('#freightPlanTabLabel'+$(el).data('tabid')).addClass('searchmode_button');});$('#freightPlanTabLabel'+tabid).removeClass('searchmode_button');$('#freightPlanTabPanel'+tabid).removeClass('searchmode_not_selected');$('#freightPlanTabPanel'+tabid).addClass('searchmode_selected');});$(document).on('click','.freightPlanReplaceButton',function(){var params={FARE:$(this).data('fareid')};$.post(_ROOT_URL+$.param({samo_action:'SET_FREIGHTS_PLAN'}),params,function(){},'script');});function initResultset(){var $legend=$module_container.find('.resultset').show();var $scrollTo=$module_container.find('#scrollto');var offset=($scrollTo.length?$scrollTo:$legend).offset();window.scrollTo(offset.left,offset.top);samo.helpalt_field($module_container.find('.resultset').not('.air-info'),'hover','bottomLeft');samo.helpalt_field($('.air-info'),'hover','centerLeft');$module_container.find('.src-line').each(function(){var l=$(this).find('.src-name').width()+11;var r=$(this).find('.trg-name').width()+11;var line=$(this).width()-(l+r+30);$(this).find('.line').css('width',line+'px');});$module_container.find('.ui-icon-suitcase').on('mousedown keypress',function(){var claim=$(this).parents('.places').find('.price').data('claim');var params={TICKET:claim};var url=_ROOT_URL+$.param({samo_action:'EXTERNAL_FREIGHTS_PLANS'});$.post(url,params,function(){},'script');});}
$module_container.find('.searchmodes .searchmode .searchmode_button').on('mousedown keypress',function(){var $self=$(this),params={};if(!$self.data('origHref')){$self.data('origHref',this.href);}
params['CHECKIN_BEG']=$.controlValue('CHECKIN',false,$module_container);if(1==$module_container.find("input[name=FREIGHTBACK]:radio:checked").val()){var checkout=$.controlValue('CHECKOUT',false,$module_container);var datebeg=samo.dateFromString(params['CHECKIN_BEG'],'yyyymmdd'),dateend=samo.dateFromString(checkout,'yyyymmdd');if(samo.dateAsString(datebeg)!=samo.dateAsString(dateend)){params['NIGHTS_FROM']=parseInt((dateend.getTime()-datebeg.getTime())/ 86400000);}}
params['CURRENCY']=$.controlValue('CURRENCYINC',false,$module_container);params['FREIGHT']=$.controlValue('YESPLACES',false,$module_container);params['ADULT']=$.controlValue('ADULT',false,$module_container);params['CHILD']=$.controlValue('CHILD',false,$module_container);if(params.CHILD){var $ages=[];$module_container.find('.ages').find('.age').each(function(){if(this.value.length){$ages.push(parseInt(this.value));}});params.AGES=$ages.sort(function(a,b){return a-b;}).join(',');}
let delimiter='';const currentUrl=samo.parseURL($self.data('origHref'));if(Object.keys(currentUrl.params).length){delimiter='&';}else{delimiter='?';}
this.href=samo.buildURL($self.data('origHref')+delimiter+$.param(params));return false;});};$(samo.tickets);})(samo.jQuery);