(function($){const container=samo.initModuleContainer('register_agency');samo.register_agency=function(){const _ROOT_URL=samo.ROUTES.register_agency.url,$module_container=container;const ownership_self_employed=(typeof samo.ownership_self_employed!='undefined')?samo.ownership_self_employed:1;const fromInnForm=$module_container.data('from-inn-form');let selected_state=$module_container.find('select.PARTNER_TOWN').find('option:selected').data('state');$module_container.find('select.PARTNER_TOWN').on('change',function(trigger){let selected_town=this.value;let new_selected_state=$(this).find('option:selected').data('state');if(new_selected_state!==selected_state||trigger.isTrigger===2){selected_state=new_selected_state;var ownership=$module_container.find('select.PARTNER_OWNERSHIP').val();$.getScript(_ROOT_URL+$.param({STATEFROM:selected_state,OWNERSHIP:ownership,samo_action:'updateLegalInfo'}));}
const phoneprefix=$(this).find('option:selected').data('phonePrefix');$module_container.find('select.PARTNER_METROSTATION').prop('disabled',true).val(0);if(selected_town>0){$module_container.find('input.PARTNER_PHONES_PREFIX').val(phoneprefix);$.getScript(_ROOT_URL+$.param({TOWN:selected_town,samo_action:'townChanged'}));}});if(samo.getInn!==null){$module_container.find("[name*='PARTNER_INN']").val(samo.getInn).prop("readonly",true)}
if(samo.getInn!==null&&samo.getInn.length>9&&samo.use_dadata){$.getScript(_ROOT_URL+$.param({query:samo.getInn,samo_action:'getSuggest',fromInnForm:fromInnForm}));}else{$module_container.find('select.PARTNER_TOWN').triggerHandler('change');}
samo.set_data_mask($module_container);samo.helpalt_field($module_container);const default_required=[$module_container.find('input[name*="[PARTNER_KPP]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_ORGAN]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_SERIE]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_NUMBER]"]').hasClass('required')];samo.bank_filter=function(){var $bik=$module_container.find('input.PARTNER_BIK');if($bik.length){var $bank=$module_container.find('.bank_name');var $hiddenbank=$module_container.find('input[name*="[PARTNER_BANK]"]');var val=$bik.val().trim(),found=false;if(val.length>0){$bank.removeClass('error');$bank.text('');var bankListFull=$bik.data('variants')||[];$.each(bankListFull,function(key,bank){if(val===bank.bik){$bank.text(bank.Name);$hiddenbank.val(bank.Inc);found=true;return true;}});if(!found){$bank.text(samo.i18n('BANK_NOT_FOUND')).addClass('error');}else{$bank.removeClass('error');}}else{$hiddenbank.val('');$bank.text('');}}};$module_container.find('select.PARTNER_OWNERSHIP').on('change',function(){var val=$(this).val();var $kpp=$module_container.find('input[name*="[PARTNER_KPP]"]');var $registration_organ=$module_container.find('input[name*="[PARTNER_REGISTRATION_ORGAN]"]');var $registration_serie=$module_container.find('input[name*="[PARTNER_REGISTRATION_SERIE]"]');var $registration_number=$module_container.find('input[name*="[PARTNER_REGISTRATION_NUMBER]"]');if(val===ownership_self_employed){$.each([$kpp,$registration_organ,$registration_serie,$registration_number],function(idx,el){el.parents('tr:first').find('label').removeClass('required');el.removeClass('required');});}else{$.each([$kpp,$registration_organ,$registration_serie,$registration_number],function(idx,el){if(default_required[idx]){el.parents('tr:first').find('label').addClass('required');el.addClass('required');}});}}).each(function(){$(this).triggerHandler('change');}).end().find('input.date').datePicker().end().find('input.PARTNER_OFFICIALNAME').on('focus',function(){$(this).val($(this).val().trim());if($(this).val()===''){$(this).val($('option:selected',$('select.PARTNER_OWNERSHIP',$module_container)).text());}}).on('blur',function(){let $name=$module_container.find('input.PARTNER_OFFICIALNAME'),val=$name.val().trim(),is_ok=false;$module_container.find('select.PARTNER_OWNERSHIP option').each(function(){if(val===$(this).text()){is_ok=true;}
if(is_ok){$name.val('');}});}).end().find('input[type=text]').on('keypress',samo.key_press_filter).end().find('input[name=save]').on('click',function(e){e.stopPropagation();e.preventDefault();if(check_fields()){var frm=document.getElementById('register_agency_form');var formData=new FormData(frm);$.ajaxSetup({processData:false,contentType:false});$.post(samo.ROOT_URL+$.param({samo_action:'savePartner'}),formData,null,'script');}}).end().find('select.PARTNER_METROSTATION').prop('disabled',true).end().find('input.PARTNER_BIK').on('keyup',function(e){var $bank=$module_container.find('.bank_name');$bank.text('');if(e.key==="Escape"){this.value='';}}).on('blur',samo.bank_filter);$('.PARTNER_TOWN,.PARTNER_METROSTATION',$module_container).each(function(){$(this).find('option').each(function(){if($(this).attr('data-search-string')){$(this).attr('data-search-string',$(this).attr('data-search-string')+' '+$(this).attr('data-search-string').fixKeyboardLayout());}});});$('.PARTNER_TOWN',$module_container).chosen({enable_split_word_search:false,search_contains:true});$module_container.find('.PARTPASS_TOWN').chosen({enable_split_word_search:false,search_contains:true});$module_container.find('.GUARANTEE_BANK').chosen({allow_single_deselect:true,enable_split_word_search:false,search_contains:true});$module_container.find('.GUARANTEE_CURRENCY').chosen({allow_single_deselect:true,disable_search:true,});var $metrostation=$module_container.find('.PARTNER_METROSTATION');if($metrostation.length>0){var options={placeholder_text_single:samo.i18n('SELECT_METRO')};if(!$metrostation.is('.required')){options.allow_single_deselect=true;}
$metrostation.chosen(options);}
$('.PARTNER_TAXATION,.PARTNER_OWNERSHIP,.PARTNER_DIRECTORPOSITION,.PARTNER_ACTIVITY',$module_container).chosen({disable_search:true});samo.renderMetroStation=function(){$('.PARTNER_METROSTATION option',$module_container).each(function(){var text=$(this).text();if(text){$(this).attr('data-search-string',(text+' '+text.fixKeyboardLayout()));}});};$('#recaptcha').on('click',function(){var $cap=$('#icaptcha'),$src=$cap.attr('src').replace(/_=\d+/,'');$cap.attr('src',$src+'_='+Number(new Date())).on('load',function(){$('#fcaptcha').val('');});});function check_fields(){var is_ok=true;samo.field.clear_errors($module_container);$module_container.find('.required').not('label, :disabled').each(function(){var currentValue=$(this).val();if($(this).hasClass('PARTNER_BANK')&&!currentValue.length){var bik=$module_container.find('.PARTNER_BIK');samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),bik);}else if(!currentValue.length){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}else{if(currentValue==0&&$(this).hasClass('PARTNER_TOWN')){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}
if(currentValue==0&&$(this).hasClass('PARTNER_OWNERSHIP')){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}
if($(this).hasClass('PARTNER_OFFICIALNAME')){var ownerShip=$module_container.find('.PARTNER_OWNERSHIP');if(ownerShip.val()==ownership_self_employed){if(currentValue.split(' ').length<3){is_ok=samo.field.error(samo.i18n('REQUIRED_FULL_FIO'),this);return false;}}}}});if(is_ok){$module_container.find('.date').each(function(){if(this.value.length&&!valid_date($.controlValue(this))){is_ok=samo.field.error(samo.i18n('DATE_FORMAT_TITLE'),this);return false;}});}
var el=$module_container.find('input.PARTNER_OFFICIALNAME');if(el.hasClass('required')){var val=el.val().trim();var ownership=$('select.PARTNER_OWNERSHIP option:selected',$module_container).text().trim();if(val==ownership){el.errorField(samo.i18n('OFFICIALNAME_EMPTY'));return false;}}
return is_ok;}
function valid_date(value){value=parseInt(value);if(value>20600000||value<19010000){return false;}
return value;}
if(samo.use_dadata){samo.dadata($module_container,_ROOT_URL);}
samo.address_dadata($module_container,_ROOT_URL);samo.bank_filter();samo.Map($module_container);};samo.dadata=function($module_container,_ROOT_URL){var innField=$module_container.find("[name*='PARTNER_INN']");function isStateInAutofillList(){let selectedStateIso3=$('select.PARTNER_TOWN option:selected',$module_container).data('iso3');return samo.autoFillCountryCodes.includes(selectedStateIso3);}
innField.keyup(function(){if(isStateInAutofillList()&&$(this).val().length>9){samo.delay(function(){$.getScript(_ROOT_URL+'samo_action=getSuggest&query='+innField.val());},1000);}});};samo.address_dadata=function($module_container,_ROOT_URL){var innField=$module_container.find("input").filter(function(){return this.name.match(/.*ADDRESS.*/);});var townField=$module_container.find("[name*='frm[Partner][0][PARTNER_TOWN]']");innField.on('keyup',function(){var elementInput=$(this);if(elementInput.val().length>3){samo.delay(function(){$.getScript(_ROOT_URL+$.param({query:elementInput.val(),samo_action:'getAddress',selector:elementInput.attr('name'),TOWN:townField.val()}));$("div.address_data").css('display','block');elementInput.after($("div.address_data"));},1000);}}).blur(function(){setTimeout(function(){$("div.address_data").css('display','none');},500);});};$(document).on("click",".address_real",function(){var input=$(this).parent().parent().prev();input.val($(this).text());$("div.address_data").css('display','none').empty();});samo.add_empty_option=function(el_name){var el=$('[name*="['+el_name+']"]');if(!el.find('option[value=0]').length){el.append('<option value="0" selected>---</option>');}};samo.save_partner_success=function(){$('.samo_container .Zebra_DatePicker').remove();};samo.datepicker_destroy=function(el){$(el).data('Zebra_DatePicker').destroy();};samo.disable_choosen=function(selector){container.find('.'+selector).data('chosen').is_disabled=true;};$(samo.register_agency);})(samo.jQuery);