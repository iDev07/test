(function($){samo.claim_edit=function(){var $module_container=$('#claim_edit');samo.tourist_helpers($module_container);samo.controls.calc=$module_container.find('button.claim_edit_calc');samo.controls.save=$module_container.find('button.claim_edit_save');var $tourist=$module_container.find('.tourist[data-uidpeople='+samo.uidNewPeople+']');$module_container.find('button.claim_edit_save').on('click',function(){var is_ok=true;$tourist.find('.required').not('label').each(function(){if(is_ok&&!$(this).val().length){is_ok=error_tourist(samo.i18n('REQUIRED_FIELD_EMPTY'),this);}});if(is_ok){calcSave(1);}});samo.controls.calc.on('click',function(){calcSave(0);});calcSave=function($save){var params={};params['documentGuid']=$module_container.data('documentguid');params['claim_edit_action']=$module_container.data('claim_edit_action');params['SAVE']=$save;let is_ok=false;if($module_container.data('claim_edit_action')=='add_people'){var field=$tourist.find('[name*="[BORN]"]');var date=valid_date(field);is_ok=(date!==false&&date!='');if(!is_ok){return error_tourist(samo.i18n('INCORRECT_DATE'),field);}
if(checkParentPeople($tourist)){is_ok=true;$module_container.find('.hotelVariant').each(function(){if($(this).val()==0){is_ok=false;$(this).errorField(samo.i18n('ACCOMODATION_EMPTY'));}});if(is_ok){params['uidPeople']=$tourist.data('uidpeople');if(isPeopleChange($tourist)){var ppl=prepareTourist($tourist);if(ppl){params['people']=ppl;}}}}}else{is_ok=true;}
if(is_ok){samo.disableForm();$.post(samo.ROUTES.claim_edit.url+$.param({samo_action:'CALCSAVE',CLAIM:$module_container.data('claim')}),params,function(){$module_container=$('#claim_edit');if($module_container.find('div.step3').length){$module_container.find('div.step3').get(0).scrollIntoView(false);}
samo.enableForm();},'script');}};$module_container.find('#PARENT_PEOPLE_UID').on('change',function(){if($(this).val()==''){fieldCannotBeEmpty(this);}
$(this).data('old2',$.controlValue(this));});function fieldCannotBeEmpty(field){var old=$(field).data('old2');if(!old){old=$(field).data('old');}
$(field).find('option[value='+old+']').prop('selected',true);samo.field.error(samo.i18n('CLAIM_EDIT_CANNOT_BE_EMPTY'),field);}
$module_container.find('.hotelVariant').on('change',function(){if($(this).val()){var params={};params['documentGuid']=$module_container.data('documentguid');params['claim_edit_action']=$module_container.data('claim_edit_action');params['uidNew']=$(this).val();let is_ok=false;if($module_container.data('claim_edit_action')=='add_people'){if(checkParentPeople($tourist)){params['uidPeople']=$tourist.data('uidpeople');if(isPeopleChange($tourist)){var ppl=prepareTourist($tourist);if(ppl){params['people']=ppl;}}
is_ok=true;}else{$(this).val($(this).data('old'));}}else{is_ok=true;}
if(is_ok){samo.disableForm();$.post(samo.ROUTES.claim_edit.url+$.param({samo_action:'CHANGEHOTEL',CLAIM:$module_container.data('claim')}),params,function(){samo.enableForm();},'script');}}});$module_container.find('.claim_edit_close').on('click',function(){if(confirm(samo.i18n('CLAIM_EDIT_QUIT'))){samo.updateClaim($module_container.data('documentguid'));}});$module_container.find('[name*="[BORN]"]').on('change.datepicker',function(){var date=valid_date($(this));if(date===false||date===''||$(this).data('old')!=date){$module_container.find('.claim_edit_block_orders').empty();$module_container.find('.step3').empty();$module_container.find('.blockParentPeople').remove();showBtnLoadOrder();showBtnCalc();showBtnSave();}});$module_container.find('.claim_edit_btn_load_order').on('click',function(){var field=$tourist.find('[name*="[BORN]"]');var date=valid_date(field);var is_ok=(date!==false&&date!='');if(!is_ok){return error_tourist(samo.i18n('INCORRECT_DATE'),field);}
if(checkParentPeople($tourist)){var params={};params['documentGuid']=$module_container.data('documentguid');params['claim_edit_action']=$module_container.data('claim_edit_action');params['uidPeople']=$tourist.data('uidpeople');if(isPeopleChange($tourist)){var ppl=prepareTourist($tourist);if(ppl){params['people']=ppl;}}
samo.disableForm();$.post(samo.ROUTES.claim_edit.url+$.param({samo_action:'LOADORDERVARIANTS',CLAIM:$module_container.data('claim')}),params,function(){samo.enableForm();},'script');}});$module_container.find('[name*="[PLACEBORN]"]').on('change',function(){samo.ReloadTouristDetail($(this),0);});$module_container.find('[name*="[NATIONALITY]"]').on('change',function(){samo.ReloadTouristDetail($(this),1);});$module_container.find('select.visa').on('change',function(){if($(this).val()==''){fieldCannotBeEmpty($(this));}else{var params={};params['documentGuid']=$module_container.data('documentguid');params['claim_edit_action']=$module_container.data('claim_edit_action');params['uidNew']=$(this).val();params['uidPeople']=$tourist.data('uidpeople');if(isPeopleChange($tourist)){var ppl=prepareTourist($tourist);if(ppl){params['people']=ppl;}}
samo.disableForm();$.post(samo.ROUTES.claim_edit.url+$.param({samo_action:'CHANGEVISA',CLAIM:$module_container.data('claim')}),params,function(){samo.enableForm();},'script');}});$module_container.find('#SEPARATE_PLACE, #APPLYTOFREIGHT, #APPLYTOINSURE, #APPLYTOSERVICE').on('change',function(){$module_container.find('.step3').css('display','none');samo.controls.calc.prop('disabled',false);samo.controls.save.prop('disabled',true);});$module_container.find('select.visa').each(function(){$(this).find('option[value="0"]').html('');var options={placeholder_text_single:samo.i18n('EMPTY_VISA')};$(this).chosen(options).trigger("chosen:updated");});function checkParentPeople($tourist){var $field=$tourist.find('#PARENT_PEOPLE_UID');if($field.length&&!$field.prop('disabled')&&$field.val()==''){return error_tourist(samo.i18n('PARENT_TOURIST_EMPTY'),$field);}
return true;}
function isPeopleChange($tourist){var is_change=false;$tourist.find('select, input').each(function(){if($(this).data('old')!=$.controlValue(this)){is_change=true;return false;}});return is_change;}
function prepareTourist($tourist){var ppl={},date,$field,is_ok;ppl['human']=$tourist.find('[name*="[HUMAN]"]').val();ppl['male']=$tourist.find('[name*="[MALE]"]').filter(':checked').val();ppl['uidPeople']=$tourist.data('uidpeople');$field=$tourist.find('[name*="[LASTNAME_NAME]"]');ppl['LASTNAME_NAME']=$field.length?$field.val().toUpperCase():'';$field=$tourist.find('[name*="[LASTNAME_LNAME]"]');ppl['LASTNAME_LNAME']=$field.length?$field.val().toUpperCase():'';$field=$tourist.find('[name*="[FIRSTNAME_NAME]"]');ppl['FIRSTNAME_NAME']=$field.length?$field.val().toUpperCase():'';$field=$tourist.find('[name*="[FIRSTNAME_LNAME]"]');ppl['FIRSTNAME_LNAME']=$field.length?$field.val().toUpperCase():'';$field=$tourist.find('[name*="[PATRONYMIC_NAME]"]');ppl['PATRONYMIC_NAME']=$field.length?$field.val().toUpperCase():'';$field=$tourist.find('[name*="[PATRONYMIC_LNAME]"]');ppl['PATRONYMIC_LNAME']=$field.length?$field.val().toUpperCase():'';date=valid_date($tourist.find('[name*="[BORN]"]'));is_ok=(date!==false);if(is_ok){ppl['born']=date!=''?date:null;ppl['identity_document']=$tourist.find('[name*="[IDENTITY_DOCUMENT]"] option:selected').data('uiddocument');$field=$tourist.find('[name*="[PSERIE]"]');ppl['pserie']=$field.length?$field.val().toUpperCase():'';$field=$tourist.find('[name*="[PNUMBER]"]');ppl['pnumber']=$field.length?$field.val().toUpperCase():'';date=valid_date($tourist.find('[name*="[PVALID]"]'));is_ok=(false!==date);if(is_ok){ppl['pvalid']=date!=''?date:null;date=valid_date($tourist.find('[name*="[PGIVEN]"]'));is_ok=(date!==false);if(is_ok){ppl['pgiven']=date!=''?date:null;$field=$tourist.find('[name*="[PGIVENORG]"]');ppl['pgivenorg']=$field.length?$field.val():'';ppl['nationality']=$tourist.find('[name*="[NATIONALITY]"]').val()||samo.MINLONGINT;ppl['placeborn']=$tourist.find('[name*="[PLACEBORN]"]').val()||samo.MINLONGINT;$field=$tourist.find('[name*="[ADDRESS]"]');ppl['address']=$field.length?$field.val():'';$field=$tourist.find('[name*="[PHONE]"]');ppl['phone']=$field.length?$field.val():'';$field=$tourist.find('[name*="[MOBILE]"]');ppl['mobile']=$field.length?$field.val():'';$field=$tourist.find('[name*="[EMAIL]"]');ppl['email']=$field.length?$field.val():'';date=valid_date($tourist.find('[name*="[VEXPIRE]"]'));is_ok=(date!==false);if(is_ok){ppl['vexpire']=date!=''?date:null;$field=$tourist.find('[name*="[PLACEBORNDETAIL]"]');ppl['placeborndetail']=$field.length?$field.val():'';$field=$tourist.find('[name*="[INN]"]');ppl['inn']=$field.length?$field.val():'';$field=$tourist.find('#PARENT_PEOPLE_UID');if($field.length&&$field.val()!=''){ppl['uidParentPeople']=$field.val();}
$field=$tourist.find('#SEPARATE_PLACE');if($field.length){ppl['separatePlace']=$field.is(':checked')?1:0;}
$field=$tourist.find('#APPLYTOFREIGHT');if($field.length){ppl['applyToFreight']=$field.is(':checked')?1:0;}
$field=$tourist.find('#APPLYTOINSURE');if($field.length){ppl['applyToInsure']=$field.is(':checked')?1:0;}
$field=$tourist.find('#APPLYTOSERVICE');if($field.length){ppl['applyToService']=$field.is(':checked')?1:0;}
$.each(ppl,function(key,val){ppl[key]=typeof val==='string'?val.trim():val;});return ppl;}}}}
return false;}
$module_container.find('#SEPARATE_PLACE').on('click',function(){if($tourist.find('#APPLYTOFREIGHT').is(':checked')){var disabled=false;if($(this).is(':checked')){disabled=true}
$tourist.find('#PARENT_PEOPLE_UID').prop('disabled',disabled);}});$module_container.find('#APPLYTOFREIGHT').on('click',function(){var disabled=false;if(!$(this).is(':checked')){disabled=true}
$tourist.find('#SEPARATE_PLACE').prop('disabled',disabled);if(!disabled&&$module_container.find('#SEPARATE_PLACE').length){$module_container.find('#SEPARATE_PLACE').triggerHandler('click');}else{$tourist.find('#PARENT_PEOPLE_UID').prop('disabled',disabled);}});samo.ReloadTouristDetail=function($select,load_identity_document){var load_visas=$tourist.find('.visa').length>0;if(load_visas||load_identity_document){var params={};params['documentGuid']=$module_container.data('documentguid');params['claim_edit_action']=$module_container.data('claim_edit_action');params['uidPeople']=$tourist.data('uidpeople');if(isPeopleChange($tourist)){var ppl=prepareTourist($tourist);if(ppl){params['people']=ppl;samo.disableForm();$.post(samo.ROUTES.claim_edit.url+$.param({samo_action:'UPDATEPEOPLE',CLAIM:$module_container.data('claim')}),params,function(){samo.enableForm();},'script');}}}};$module_container.find('.toggle_details').on('click',function(){var $self=$(this);if($self.data('show')==$self.text()){$($module_container.find('div.COMMISSIONS')).slideDown(function(){$self.text($self.data('hide'));});}else{$($module_container.find('div.COMMISSIONS')).slideUp(function(){$self.text($self.data('show'));});}});function valid_date(field){var value='';if(field.length&&field.clearVal().length){value=$.controlValue(field.get(0));value=parseInt(value);if(value>20790000||value<19010000){return error_tourist(samo.i18n('INCORRECT_DATE'),field);}}
return value;}
var error_tourist=function(message,field){samo.field.error(message,field);return false;};function showBtnLoadOrder(){if(samo.hotelsRequired){$module_container.find('.claim_edit_btn_load_order').removeClass('hidden');var disabled=false;if($module_container.find('.hotelVariant').length){disabled=true;}
$module_container.find('.claim_edit_btn_load_order').prop('disabled',disabled);}else{$module_container.find('.claim_edit_btn_load_order').addClass('hidden');}}
function showBtnCalc(){var display=false;var disabled=false;if(samo.hotelsRequired){if($module_container.find('.hotelVariant').length){display=true;}}else{display=true;}
if(display){samo.controls.calc.removeClass('hidden');if($module_container.find('.step3').length){disabled=true;}
samo.controls.calc.prop('disabled',disabled);}else{samo.controls.calc.addClass('hidden');}}
function showBtnSave(){var display=false;var disabled=true;if(samo.hotelsRequired){if($module_container.find('.hotelVariant').length){display=true;}}else{display=true;}
if(display){samo.controls.save.removeClass('hidden');if($module_container.find('.step3').length){disabled=false;}
samo.controls.save.prop('disabled',disabled);}else{samo.controls.save.addClass('hidden');}}
$module_container.find('[name*="[IDENTITY_DOCUMENT]"]').triggerHandler('change');$module_container.find('.hotelVariant').chosen();$module_container.find('#PARENT_PEOPLE_UID').chosen();$module_container.find('#APPLYTOFREIGHT').triggerHandler('click');$module_container.find('#SEPARATE_PLACE').triggerHandler('click');$module_container.find('select, input').each(function(){$(this).data('old',$.controlValue(this));});showBtnLoadOrder();showBtnCalc();showBtnSave();};})(samo.jQuery);