'use strict';(function($){$.fn.serializeArray=function(){var result={};var form=this;$(form).find('input,select,textarea').each(function(){var name=this.name||$(this).attr('name');if(name){var tag=this.tagName.toLowerCase();if(tag=='input'&&this.type=='radio'){if(!result[name]){result[name]=$(form).find('input:radio[name="'+name+'"]:checked').val();}}else if(tag=='textarea'){result[name]=$(this).val();}else{var fix=false;if(!$(this).is('.string')){fix=true;$(this).addClass('string');}
result[name]=$.controlValue(this,false);if(fix){$(this).addClass('string');}}}});return result;};var container=samo.initModuleContainer('reports');var _ROOT_URL=samo.ROUTES.reports.url,$module_container=container;samo.reports=function(){var $btn=$module_container.find('button.getReport');$module_container.find('.downloadLinkBlock').on('click','a.getReport',function(e){var $link=$(this);if(!$link.attr('download')){$link.data('post-form','.reportForm');samo.delayed_download(e);$link.removeData('post-form');var timer=setInterval(function(){var dnl=$module_container.find('a.getReport.in-progress');if(!dnl.length){clearInterval(timer);$btn.prop('disabled',false).css('display','block');}},250);return false;}});$btn.click(function(){$module_container.find('.resultset').empty();if(validateForm()){$btn.prop('disabled',true);$.post(_ROOT_URL+'samo_action=reloadReportParams',$module_container.find('.reportForm').serialize(),function(){if(validateForm()){var $link=$module_container.find(".downloadLinkBlock a.getReport");$link.html(samo.i18n('GENERATE_A_REPORT')).attr('href',$module_container.find('.reportForm').attr('action')).removeAttr('download').removeData();$link.show().click();}},'script');}});$module_container.find('.selectReport').on('change',function(){var template=parseInt(this.value);if(template){getReportParams(template);}else{$module_container.find(".reportParams").empty();$btn.hide();}
return false;});function validateForm(){var status=true;$module_container.find('.reportParams .required').not('label, :disabled').each(function(){var element=this;var tag=element.tagName.toLowerCase();if(tag=='textarea'){if(!element.value.trim().length){samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),element);status=false;return status;}}else{if($.controlValue(element)===''){samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),element);status=false;return status;}else{return samo.field.clear_error(element);}}});if(status){$module_container.find('.checklistbox').each(function(){$(this).append('<input type="hidden" name="'+$(this).attr('name')+'" value="'+$.controlValue(this)+'">');});}
return status;}
function hideDownloadLink(){$module_container.find('a.getReport').removeAttr('download').removeClass('samo-delayed-download').html('');}
samo.initReportForm=function(){$("select").chosen();if($module_container.find('.reportForm').length){samo.set_data_mask($module_container);samo.helpalt_field($module_container);$module_container.find('.date').datePicker().end().find('.reload').on('change',function(){$.post(_ROOT_URL+'samo_action=reloadReportParams',$module_container.find('.reportForm').serialize());}).end().find('button.next').on('click',function(e){e.preventDefault();if(validateForm()){$.post(_ROOT_URL+'samo_action=reloadReportParams',$module_container.find('.reportForm').serialize());}});$module_container.find('input,select').on('change',hideDownloadLink);hideDownloadLink();$btn.prop('disabled',false).css('display','block');}};function getReportParams(template){$.getScript(_ROOT_URL+
$.param({template:template,samo_action:'getReportParams'}));}
samo.initReportForm();if(parseInt(samo.parseURL(window.location.href).params.DOLOAD)==1){$btn.click();}};var oldDownloadResult=samo.download_result;samo.download_result=function(params){if(params.url){var parts=params.url.toLowerCase().split('.'),ext=parts[parts.length-1];if(ext=='html'){if($module_container.find('.resultset').length==0){$module_container.find('.downloadLinkBlock').append('<div class="resultset"></div>');}
var $link=$('.samo-delayed-download.in-progress').filter(function(){return $(this).data('guid')==params.guid;});if($link.data('progress')){clearInterval($link.data('progress'));$link.removeData('progress');$link.parent().find('.progressbar').remove();}
$link.off('download').off('click').removeClass('in-progress').hide();$module_container.find('.resultset').load(params.url,function(){$module_container.find('.resultset table').each(function(){$(this).removeAttr('width').removeAttr('border').removeAttr('cellspacing').removeAttr('cellpadding').addClass('res');});$module_container.find('.resultset table tr').each(function(){$(this).removeAttr('style');});$module_container.find('.resultset table td').each(function(){$(this).removeAttr('style');});});return true;}}
return oldDownloadResult(params);};$(samo.reports);})(samo.jQuery);