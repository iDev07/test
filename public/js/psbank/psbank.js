(function($){samo.psbank=function(){var $module_container=$('#psbank'),$form=$('#PSBANK_FORM');samo.set_data_mask($module_container);samo.helpalt_field($module_container);$module_container.find('input.date').datePicker({direction:false});$module_container.find('input.date[name*=PAYER_BORN]').datePicker({start_date:samo.dateYearAgo(-30),direction:false});samo.psbankButtonShow=function(){$module_container.find('button.load').show();$module_container.find('.progressbar').remove();};$module_container.find('.payer_info').on('change','input, select',function(){samo.psbankButtonShow();});$module_container.find('.load').on('click',function(){if(check_fields()){var action=$form.attr('action');var $link=$('<a/>');$link.attr('href',action).css('display','none').data('post-form',$form).appendTo(psbank);$link.on('click',samo.delayed_download).triggerHandler('click');$link.removeData('post-form');$('button.load').hide();}
return false;}).end().find('.PAYER').on('change',function(){var payer_inc=this.value;var $values=(payer_inc>0)?$('option:selected',this).data('payer'):{PAYER_FIO:"",PAYER_ADDRESS:"",PAYER_PSERIE:"",PAYER_PNUMBER:"",PAYER_PGIVENDATE:"",PAYER_PGIVENORG:"",PAYER_PGIVENORG_MENT:"",PAYER_BORN:"",PAYER_PHONES:"",PAYER_INN:""};var update_warrant=$module_container.data('update_warrant');$.each($values,function(idx,value){var tmp=$('.'+idx);tmp.val(value||'');if(update_warrant==0&&payer_inc>0&&value!=''){tmp.prop('readonly',true);}else{tmp.prop('readonly',false);}
var $warning=$module_container.find('.warning');if(update_warrant==0&&payer_inc>0){$warning.css('display','block');}else{$warning.css('display','none');}});}).triggerHandler('change');$module_container.find('[name=BANK]').on('change',function(){var bank_inc=this.value;var percnt=null;let commission=null;var mincommisssum=null;var ratio=null;var $fld=$('[name=MAX_AMOUNT]');var $div_percnt=$('.bank-percent');var $currency=$fld.data('currency');var new_price=parseFloat($fld.data('original'));if(bank_inc>0){percnt=$('option:selected',this).data('percnt');if(percnt>0){ratio=$('option:selected',this).data('ratio');new_price=$fld.data('original')*ratio;commission=percnt+'%';mincommisssum=$('option:selected',this).data('mincommisssum');if(mincommisssum>0){let new_pricesum=new_price-$fld.data('original');if(new_pricesum<mincommisssum){new_price=parseFloat($fld.data('original'))+mincommisssum;commission=mincommisssum+' '+$currency;}}
$div_percnt.html(samo.i18n('PSBANK_COMMISSION_IN')+commission+'<br \/>'+
samo.i18n('PSBANK_FULLAMOUNT_COMMISSION')+new_price.toFixed(2)+" "+$currency);}else{$div_percnt.html('&nbsp')}}
$fld.attr('max',new_price.toFixed(2));$fld.val(new_price.toFixed(2));}).triggerHandler('change');function check_fields(){var is_ok=true;samo.field.clear_errors($form);$form.find('.required').not('label').each(function(){if(!$(this).val().length){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);}});if(is_ok){$form.find('.date').each(function(){if(this.value.length&&!$.valid_date(this)){is_ok=samo.field.error(samo.i18n('DATE_FORMAT_TITLE'),this);return false;}});}
if(is_ok){var fld='[name=MAX_AMOUNT]',$fld=$(fld);if($fld.length>0){var tmp=parseFloat($fld.val());if(tmp!=$fld.val()){$fld.errorField(samo.i18n('INVALID_PAYER_AMOUNT'));return false;}
if(tmp==0){$fld.errorField(samo.i18n('NO_CLAIM_PAYMENT'));return false;}
var tmp2=parseFloat($fld.attr('max'));if(tmp>tmp2){$fld.errorField(samo.i18n('PAYER_AMOUNT_BIG')+' '+$(fld).attr('max'));$fld.val(tmp2);return false;}}
$fld=$('#BANK');if($fld.val()==0){$fld.errorField(samo.i18n('PSBANK_BANK'));return false;}}
return is_ok;}};})(samo.jQuery);