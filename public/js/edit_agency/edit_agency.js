(function($){var bank_old_value=$('#edit_agency').find('select.PARTNER_BANK').val();var disabled_bank=false;var ownership_self_employed=(typeof samo.ownership_self_employed!='undefined')?samo.ownership_self_employed:1;var initialHash='';var currentHash='';samo.edit_agency=function($module_container){var _ROOT_URL=samo.ROUTES.edit_agency.url;if(arguments.length==0){$module_container=$('#edit_agency');}
$module_container.find('input[type=submit]').prop('disabled',true);samo.set_data_mask($module_container);samo.helpalt_field($module_container);$(document).on("click",".address_real",function(){var input=$(this).parent().parent().prev();input.val($(this).text());$("div.address_data").css('display','none').empty();});samo.bank_filter=function(){var $bik=$module_container.find('input.PARTNER_BIK');if($bik.length){var $bank=$module_container.find('.bank_name');var $hiddenbank=$module_container.find('input[name*="[PARTNER_BANK]"]');var bankListFull=$bik.data('variants')||[];var val=$bik.val().trim(),found=false;if(val.length>0){$bank.removeClass('error');$bank.text('');$.each(bankListFull,function(key,bank){if(val==bank.bik){found=true;if(bank.Private===1){disabled_bank=bank.Name;$bik.attr('placeholder',val);$bik.val('');$bank.text(bank.Name+' '+samo.LANG.CHOSEN_SELECTED_ITEM_NOT_AVAILABLE);}else{disabled_bank=false;$bank.text(bank.Name);$hiddenbank.val(bank.Inc);}
return true;}});if(!found){$bank.addClass('error');$bank.text(samo.i18n('BANK_NOT_FOUND'));}}else{$hiddenbank.val('');$bank.text('');}}};var default_required=[$module_container.find('input[name*="[PARTNER_KPP]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_ORGAN]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_SERIE]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_NUMBER]"]').hasClass('required')];$module_container.find('select.PARTNER_OWNERSHIP').on('change',function(){var val=$(this).val();var $kpp=$module_container.find('input[name*="[PARTNER_KPP]"]');var $registration_organ=$module_container.find('input[name*="[PARTNER_REGISTRATION_ORGAN]"]');var $registration_serie=$module_container.find('input[name*="[PARTNER_REGISTRATION_SERIE]"]');var $registration_number=$module_container.find('input[name*="[PARTNER_REGISTRATION_NUMBER]"]');if(val==ownership_self_employed){$.each([$kpp,$registration_organ,$registration_serie,$registration_number],function(idx,el){el.parents('tr:first').find('label').removeClass('required');el.removeClass('required');});}else{$.each([$kpp,$registration_organ,$registration_serie,$registration_number],function(idx,el){if(default_required[idx]){el.parents('tr:first').find('label').addClass('required');el.addClass('required');}});}}).each(function(){$(this).triggerHandler('change');}).end().find('input.date').datePicker().end().find('input.PARTNER_RS').on('change',function(){var $bank=$module_container.find('select.PARTNER_BANK');if($bank.val()==bank_old_value){$module_container.find('input.PARTNER_BIK').val('');samo.bank_filter();}}).end().find('input.PARTNER_OFFICIALNAME').on('focus',function(){$(this).val($(this).val().trim());if($(this).val()==''){$(this).val($('option:selected',$('select.PARTNER_OWNERSHIP',$module_container)).text());}}).on('blur',function(){var $name=$module_container.find('input.PARTNER_OFFICIALNAME'),val=$name.val().trim(),is_ok=false;$module_container.find('select.PARTNER_OWNERSHIP option').each(function(){if(val==$(this).text()){is_ok=true;}
if(is_ok){$name.val('');}});}).end().find('input[type=text]').on('keypress',samo.key_press_filter).end().find('input.PARTNER_BIK').on('keyup',function(e){var $bank=$module_container.find('.bank_name');$bank.text('');if(e.key==="Escape"){this.value='';}}).on('blur',samo.bank_filter).end().find('input[name=save]').on('click',function(e){e.stopPropagation();e.preventDefault();if(check_fields($module_container)){$.post(samo.ROOT_URL+$.param({samo_action:'SAVE_PARTNER'}),$module_container.find('.partner_info').pseudoForm(),null,'script');}});$('.PARTNER_TOWN,.PARTNER_METROSTATION',$module_container).each(function(){$(this).find('option').each(function(){if($(this).attr('data-search-string')){$(this).attr('data-search-string',$(this).attr('data-search-string')+' '+$(this).attr('data-search-string').fixKeyboardLayout());}});});$('.PARTNER_TOWN',$module_container).chosen({enable_split_word_search:false,search_contains:true});$('.PARTNER_METROSTATION',$module_container).chosen({placeholder_text_single:samo.i18n('SELECT_METRO')});$('.PARTNER_TAXATION,.PARTNER_OWNERSHIP,.PARTNER_DIRECTORPOSITION,.PARTNER_ACTIVITY',$module_container).chosen({disable_search:true});samo.enableMetro=function(){$('.PARTNER_METROSTATION',$module_container).prop('disabled',false);};samo.renderMetroStation=function(){$('.PARTNER_METROSTATION option',$module_container).each(function(){var text=$(this).text();if(text){$(this).attr('data-search-string',(text+' '+text.fixKeyboardLayout()));}});};$module_container.find('select.PARTNER_TOWN').on('change',function(){var selected_town=this.value;var phoneprefix=$(this).find('option:selected').data('phonePrefix');var $metrostation=$module_container.find('select.PARTNER_METROSTATION').prop('disabled',true);if(selected_town>0){$module_container.find('input.PARTNER_PHONES_PREFIX').val(phoneprefix);$.getScript(_ROOT_URL+$.param({TOWN:selected_town,samo_action:'TOWN',PARTNER_METROSTATION:$metrostation.val()}));}}).triggerHandler('change');samo.request_changes=function(){$module_container.find('input:disabled').not('input[type=submit]').each(function(){var $self=$(this);$self.replaceWith('<span class="frm-value request-changes" data-frm-name="'+$self.attr('data-frm-name')+'">'+$self.val()+'</span>');});$module_container.find('.request-changes').on('click',function(){var params={samo_action:'REQUEST_CHANGES'};$.getScript(_ROOT_URL+$.param(params),null,false);});};samo.request_changes_form=function(){var $frm=$('#request-changes-frm').on('submit',function(e){e.stopPropagation();e.preventDefault();$('#request-changes-btn').prop('disabled',true);$.post(this.action,$(this).serialize(),function(){$('#request-changes-btn').prop('disabled',false);},'script');});samo.edit_agency($frm);};function check_fields($container){var is_ok=true;$container.find('.required').not('label, :disabled').each(function(){if($(this).hasClass('PARTNER_BANK')&&!$(this).val().length){var bik=$container.find('.PARTNER_BIK');samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),bik);}else if(!$.NonEmptyValue(this)){is_ok=false;return false;}else{if($(this).hasClass('PARTNER_OFFICIALNAME')){var ownerShip=$module_container.find('.PARTNER_OWNERSHIP');if(ownerShip.val()==ownership_self_employed){if($(this).val().split(' ').length<3){is_ok=samo.field.error(samo.i18n('REQUIRED_FULL_FIO'),this);return false;}}}}});if(is_ok){if(disabled_bank!==false){var $bik=$container.find('.PARTNER_BIK');if(!$bik.is('.required')){samo.field.error(disabled_bank+' '+samo.i18n('CHOSEN_SELECTED_ITEM_NOT_AVAILABLE'),$bik);}
is_ok=false;}}
if(is_ok){$container.find('input.date').each(function(){if(!$.valid_date(this)){is_ok=false;return false;}});}
if(is_ok){$container.find('input, select').not('label, :disabled').each(function(){if(!$.RegexpValue(this)){is_ok=false;return false;}});}
var el=$container.find('input.PARTNER_OFFICIALNAME');if(el.hasClass('required')){var val=el.val().trim();var ownership=$('select.PARTNER_OWNERSHIP option:selected',$container).text().trim();if(val==ownership){$.notify({text:samo.i18n('OFFICIALNAME_EMPTY'),type:'error'});return false;}}
return is_ok;}
samo.address_dadata=function($module_container,_ROOT_URL){var innField=$module_container.find("input").filter(function(){return this.name.match(/.*ADDRESS.*/);});var $inputTown=$("input[data-frm-name*='[PARTNER_TOWN]']");innField.on('keyup',function(){var elementInput=$(this);if(elementInput.val().length>3){let result={};result.samo_action='getAddress';result.selector=elementInput.attr('name');result.TOWN=$inputTown.attr('data-town-value');result.query=elementInput.val();samo.delay(function(){$.getScript(_ROOT_URL+$.param(result));$(".address_data").css('display','block');elementInput.after($(".address_data"));},1000);}}).blur(function(){setTimeout(function(){$("div.address_data").css('display','none');},500);});};samo.address_dadata($module_container,_ROOT_URL);samo.bank_filter();initialHash=currentHash=calculateAgencyHash($module_container);$module_container.find('input').on('blur',function(){compareHashes()});$module_container.find('select').on('change',function(){compareHashes()});$module_container.find('input:checkbox').on('change',function(){compareHashes()});function compareHashes(){currentHash=calculateAgencyHash($module_container);if(initialHash!=currentHash){$module_container.find('input[type=submit]').prop('disabled',false);}else{$module_container.find('input[type=submit]').prop('disabled',true);}}
function calculateAgencyHash($module_container){var calculated='';$module_container.find('input.frm-input').each(function(){calculated+=$(this).val();});$module_container.find('select').each(function(){calculated+=$(this).val();});$module_container.find('input').each(function(){if($(this).is(':checkbox')){calculated+=($(this).is(':checked')?'1':'0');}});return calculated;}
samo.Map($module_container);};$(function(){samo.edit_agency($('#edit_agency'));});})(samo.jQuery);